---
title: "California Seed Production Analysis"
author: "R. Alex Thompson"
date: "1/2/2024"
output: html_document
---

This loads some but not all of the packages used in this project. Functions are loaded as needed throughout this markdown file. 
```{r setup, include=FALSE}
library(dplyr)
library(tidyverse)
library(ggpubr)
library(ggplot2)
library(mastif)
library(repmis)
library(parallel)
library(ggthemes)
library(rFIA)
library(maps)

```

These functions are from Jim Clark. There are a variety of functions here but most important is the shade calculation for the FIA data and the genusExtract function that let's us isolate a single genus from the MASTIF dataset.
``` {r some new functions}


distmat <- function(x1,y1,x2,y2){
  xd <- outer(x1,x2,function(x1,x2) (x1 - x2)^2)
  yd <- outer(y1,y2,function(y1,y2) (y1 - y2)^2)
  t(sqrt(xd + yd)) 
}

predCanopy <- function(newdata, fit = NULL, 
                       ppath="/Volumes/research/clark/clark.unix/allocationmodel/datafiles/treesActive/"){
  
  # columns in newdata: canopyYEAR, diamYEAR, UTMx, UTMy, plot, tree, species
  
  if(is.null(fit))load( paste(ppath, "canopyModel.rdata", sep='') )
  
  wc <- grep('canopy', colnames(newdata))
  
  CANOBS <- F
  canopy <- NA
  
  wc <- grep('diam', colnames(newdata))
  diam <- apply(newdata[,wc, drop=F], 1, max, na.rm=T)
  wf <- which(is.finite(diam))
  
  diam <- diam[wf]
  xy <- newdata[wf,c('UTMx','UTMy')]
  
  wc <- grep('canopy', colnames(newdata))
  if(length(wc) > 0){
    canopy <- as.matrix( newdata[,wc, drop=F] )
    if(ncol(canopy) > 1){
      canopy <- apply(canopy, 1, max, na.rm=T)
    }
    canopy <- canopy[wf]
    canopy[canopy > 5] <- 5
    CANOBS <- T
    names(canopy) <- names(diam)
  }
  
  covec <- getCanopyCoeff(xy, diam, canopy, ecoeff = fit$ecoeff)
  names(covec) <- rownames(xy)
  
  dk <- data.frame(plot = newdata$plot[wf], tree = newdata$tree[wf], 
                   species = newdata$species[wf],
                   xy, diam, shade = covec)
  
  pk <- .predCanopyCoeff(fit$fit, newdata = dk)
  
  canopy[!is.finite(canopy)] <- NA
  #dk$canopy  <- canopy
  #dk$canPred <- pk          
  
  out <- newdata
  out$shade <- NA
  out[ names(pk), 'shade' ] <- pk
  out$shade[ is.finite(out$canopy) ] <- out$canopy[ is.finite(out$canopy) ]
  out
}

getCanopyCoeff <- function(xy, diam, canopy = NULL, ecoeff = .02, maxdist = 30){
  
  k <- 50
  
  ww <- which( is.na(xy[,1]) | is.na(xy[,2]) |
                 is.na(diam) )
  
  if(length(ww) > 0)stop( 'cannot have NA in xy or diam' )
  
  if(nrow(xy) < 1000){
    rmat <- distmat(xy[,1],xy[,2], xy[,1], xy[,2])
    rmat <- exp( -ecoeff*rmat^2)
    rmat[rmat > maxdist] <- 0

    dmat <- matrix(diam, length(diam), length(diam), byrow=T)
    dmat <- dmat - dmat[1,]
  }else{
    rtmp <- RANN::nn2(data = xy, k = k, radius = maxdist)
    rii  <- rtmp[[1]]
    rdd  <- rtmp[[2]]
    
    dmat <- matrix(diam[rii], length(diam), k)
    dmat <- dmat - dmat[,1]
    rmat <- exp( -ecoeff*rdd^2)
  }
  
  rmat[rmat < .0001] <- .0001
  
  dmat[dmat < 0] <- 0
  dmat[!is.finite(dmat)] <- 0
  
  can <- rowSums(dmat*rmat, na.rm=T)  #increases with shading; decreases with canopy
  
  round(can, 1)
}

.predCanopyCoeff <- function(fit, newdata){
  
  pred2 <- predict(fit, newdata = newdata)
  
  ip <- findInterval(pred2, c(-Inf, 0 + c(1:4), Inf))
  names(ip) <- names(pred2)
  
  ip
}

fitCanopyOrd <- 
  function(path="/Volumes/research/clark/clark.unix/allocationmodel/datafiles/treesActive",
           PLOT=F, ecoeff=.02){
    
    # reads all active files in path and fits ordinal regression for canopy
    # returns predictions and fitted model
    
    lf <- list.files(path, full.names=T)
    lf <- lf[ grep('active.csv', lf) ]
    
    bb <- grep('BART', lf)
    lf <- lf[-bb]
    
    data <- numeric(0)
    
    for(k in 1:length(lf)){
      
      tmp <- read.csv(lf[k], stringsAsFactors = F)
      
      
      colnames(tmp)[colnames(tmp) == 'UTMX'] <- 'UTMx'
      colnames(tmp)[colnames(tmp) == 'UTMY'] <- 'UTMy'
      
      wc <- grep('canopy', colnames(tmp))
      if(length(wc) == 0)next
      
      canopy <- as.matrix( tmp[,wc, drop=F] )
      if(ncol(canopy) > 1){
        canopy <- apply(canopy, 1, max, na.rm=T)
      }
      canopy[canopy > 5] <- 5
      
      wc <- grep('diam', colnames(tmp))
      diam <- apply(tmp[,wc, drop=F], 1, max, na.rm=T)
      wf <- which( is.finite(diam) & is.finite(canopy) & canopy > 0 &
                    is.finite(tmp$UTMx) )
      canopy <- canopy[wf]
      diam   <- diam[wf]
      xy <- tmp[wf,c('UTMx','UTMy')]
      
      shade <- getCanopyCoeff(xy, diam, ecoeff = ecoeff)
      
      dk <- data.frame(plot = tmp$plot[wf], tree = tmp$tree[wf],
                       species = tmp$species[wf], xy, diam, 
                       shade = sqrt(shade), canopy)
      data <- rbind(data, dk)
    }
    
    data$can[data$shade == 1] <- .1
    
    if(PLOT){
      par(mfrow=c(2,2))
      plot(data$shade, jitter(data$canopy), cex=.1, 
           ylab = 'open to suppressed', xlab = 'More, big neighbors')
      boxplot(shade ~ canopy, data = data)
      plot(data$diam, data$shade, cex=.1)
    }
    
 #   data$canopy <- factor(data$canopy, 
 #                         levels=c("1", "2", "3", "4"), ordered=TRUE)
    #options(contrasts = c("contr.treatment", "contr.poly"))
    #polrMod <- MASS::polr(canopy ~ can, data=data) 
    #summary(polrMod)
    #pred <- predict(polrMod, data, type = "p")
    
    #pmax <- apply(pred, 1, which.max)
    #plot(jitter(as.numeric(as.character(data$canopy))), jitter(pmax), cex=.1)
    
  #  data$canopy <- as.numeric(as.character(data$canopy))
    
    tt <- table(data$canopy)
    tt <- tt/sum(tt)
    w <- 1/tt[ data$canopy ]
    
    p2 <- lm(canopy ~ shade + I(shade^2), data = data, weights = w)
    summary(p2)
    
    d2 <- data[,names(data) != 'canopy']
    pred2 <- predict(p2, newdata = data)
    
    qc <- findInterval(pred2, c(-Inf, 0 + c(1:4), Inf))
    
    if(PLOT){
      dev.off()
      plot(jitter(data$canopy),jitter(qc),cex=.01)
    }
    
    data$canPred <- data$shade <- qc
    list(data = data, fit = p2, ecoeff = ecoeff, files = lf )
  }


fitCanopyCompressedFile <- 
  function(file="/Users/jimclark/makeMastOnJimClark/makeMast/compressedFiles/europe/belledone/BACHAT1.rdata",
           ecoeff=.02){
    
    # reads all active files in path and fits ordinal regression for canopy
    # returns predictions and fitted model
    
    load(file)
    
    tid <- columnPaste(treeData$plot, treeData$tree)
    xid <- columnPaste(xytree$plot, xytree$tree)
    
    diam   <- tapply(treeData$diam, tid, mean, na.rm=T)[xid]
    shade  <- getCanopyCoeff(xytree[,c('x','y')], diam, ecoeff = ecoeff)
    canopy <- 6 - tapply(treeData$shade, tid, mean, na.rm=T)[xid]
    
    p2 <- lm(canopy ~ shade + I(shade^2)) 
    summary(p2)
    
    pred2 <- predict(p2)
    
    qc <- findInterval(pred2, c(-Inf, 0 + c(1:4), Inf))
    
    data <- data.frame(plot = xytree$plot, tree = xytree$tree,
                       diam,
                       stringsAsFactors = F)
                       
    data$canPred <- data$shade <- qc
    
    
    list(data = data, fit = p2, ecoeff = ecoeff, files = file )
  }
    


















# TOF

extractPlot <- function( inputs, plot, taxa, plotData ){
  
  xytree <- NULL
  inputs$treeData <- inputs$treeData[ inputs$treeData$plot == plot, ]
  specNames <- inputs$specNames <- sort( unique( inputs$treeData$species ) )
  
  inputs$priorTable <- inputs$priorTable[ drop=F, specNames, ]
  
  if( !is.null( inputs$xytree ) ){
    
    g1 <- stri_locate_first_regex(specNames, "[A-Z]")
    gen <- substr( specNames, 1, g1 - 1 )
    unkn <- unique( paste( gen, 'UNKN', sep = '' ) )
    
    inputs$xytree   <- inputs$xytree[ inputs$xytree$plot == plot, ]
    inputs$xytrap   <- inputs$xytrap[ inputs$xytrap$plot  == plot, ]
    inputs$seedData <- inputs$seedData[ inputs$seedData$plot == plot, ]
    
    dcols <- colnames( inputs$seedData )
    seeds <- c( specNames, unkn )
    scols <- colnames(inputs$seedData)
    scols <- scols[ scols %in% seeds ]
    
    inputs$seedData <- inputs$seedData[,c('plot','trap','year','area','active', scols ) ]
    inputs$seedNames <- scols
  }
  taxa <- taxa[specNames, ]
  plotData <- plotData[ drop = F, match( plot, plotData$plot), ]
  list( inputs = inputs, plotData = plotData, taxa = taxa )
}


extractGenus <- function( inputs, taxa, plotData, genus = NULL ){
  
  xytree <- NULL
  
  taxa$genus <- tolower( taxa$genus )
  if( is.null( genus ) )genus <- sort( unique( taxa$genus ) )
  genus      <- tolower( genus )
  specNames  <- rownames( taxa )[taxa$genus %in% genus ]
  tplots     <- sort( unique( inputs$treeData$plot ) )
  plotData   <- plotData[ plotData$plot %in% tplots, ]
  
  inputs$priorTable <- inputs$priorTable[ drop=F, specNames, ]
  inputs$treeData   <- inputs$treeData[ inputs$treeData$species %in% specNames, ]
  if( !is.null( inputs$xytree ) ){
    inputs$xytree   <- inputs$xytree[ inputs$xytree$plot %in% tplots, ]
    inputs$xytrap   <- inputs$xytrap[ inputs$xytrap$plot %in% tplots, ]
    inputs$seedData <- inputs$seedData[ inputs$seedData$plot %in% tplots, ]
    
    dcols <- colnames( inputs$seedData )
    scols <- character(0)
    seeds <- specNames
    for( k in 1:length(genus) ){
      seeds <- c( seeds, paste( genus, 'UNKN', sep = '' ) )
    }
    for( k in 1:length(seeds)){
      scols <- c( scols, dcols[ startsWith( dcols, seeds[k] ) ] )
    }
    inputs$seedData <- inputs$seedData[,c('plot','trap','year','area','active', scols ) ]
    inputs$seedNames <- scols
  }
  inputs$specNames <- sort( unique( inputs$treeData$species ) )
  taxa <- taxa[specNames, ]
  list( inputs = inputs, plotData = plotData, taxa = taxa )
}


obsGrid <- function( treeData, plotData ){
  
  # location of each observation
  mm <- match( inputs$treeData$plot, plotData$plot )
  ll <- plotData[mm, c('lon','lat') ]
  
  # aggregate to 1 degree grid
  loc  <- round( ll, 1 )
  ltab <- table( loc[,1], loc[,2] ) # no. observation at each grid point
  wtab <- which( ltab > 0, arr.ind = T )
  
  nobs <- ltab[ wtab ]
  xy   <- cbind( rownames( ltab )[wtab[,1]], colnames( ltab )[wtab[,2]] )
  effort <- data.frame( lon = as.numeric( xy[,1] ),
                        lat = as.numeric( xy[,2] ),
                        nobs )
  
  # assign colorRamp, low to high
  ramp  <- c('#fdbb84','#fc8d59','#7f0000')
  zlevs <- 1:10
  icol  <- findInterval( log(1 + effort$nobs), zlevs ) + 1
  zlevs <- zlevs[ zlevs <= max(icol) ]
  cvals <- colorRampPalette( ramp )( max( icol ) )
  effort$cols  <- cvals[ icol ]
  effort
}

xy2area <- function(xy){  # convex hull and polygon area
  
  require(splancs)
  
  wf <- which( is.finite( xy[,1] ) & is.finite( xy[,2] ) )
  
  ctmp <- as.matrix( xy[ drop = F, wf, ] )
  hull <- ctmp[ chull( ctmp ), ]
  area <- areapl( hull )
  
  list(hull = hull, area = area)
}


inside <- function( x, lo, hi ){
  x >= lo & x <= hi 
}

shadeClassSize <- function(plot, diam){
  
  logBA <- log(pi*(diam/2)^2)            # per plot, not per area
  nbin <- 4
  bins <- c(0, .4, .9, 1)
  stab <- tapply( logBA, list( plot = plot), quantile, bins )
  binsBA <- t( matrix( as.matrix(unlist(stab)), nbin, length(stab)) )
  rownames(binsBA) <- names(stab)
  colnames(binsBA) <- bins
  
  bi  <- binsBA[ plot, ] 
  blo <- bhi <- logBA*0
  for(k in 1:nbin){
    bi[ bi[,k] < logBA, k] <- Inf
  }
  shade <- 6 - apply(bi, 1, which.min)
  
  # trees per plot
  tpp <- tapply( logBA*0 + 1, plot, sum )
  tpp <- tpp[ plot ]
  shade[ tpp == 1 & shade < 3 ] <- 1
  
  shade
}

treeDataChecks <- function( treeData, pcols ){
  
  if( max( treeData$diam, na.rm=T ) > 700 ){
    print( fileSeed[k] )
    cat( paste( '\nMaximum tree diameter:', max( treeData$diam, na.rm=T ), '\n' ) )
    stop( 'diameter too large' )
  }
  treeData$species <- nameFix( treeData$species )
  treeData$year <- factor2integer( treeData$year )
  
  treeData$genus  <- genus
  treeData$treeID <- columnPaste( treeData$plot,treeData$tree )
  
  if( 'cropFraction' %in% colnames( treeData ) ){
    treeData$cropFraction <- as.numeric( treeData$cropFraction )
    
    wf <- which( is.finite( treeData$cropFraction ) )
    
    if( length( wf ) > 0 ){
      rf <- range( treeData$cropFraction, na.rm=T )
      if( rf[2] > 1 ){
        warning( 'cropFraction too large' )
        wrf <- which( treeData$cropFraction > 1 )
        treeData$cropFraction[wrf] <- treeData$cropFraction[wrf]/100
      }
    }
  }
  
  treeData$tree <- as.character( treeData$tree )
  treeData$plot <- as.character( treeData$plot )
  wf <- which( sapply( treeData, is.factor ) )
  if( length( wf ) > 0 )for( z in wf )treeData[[z]] <- as.character( treeData[[z]] )
  
  treeData <- firstLast2treeData( treeData )
  treeData$diam <- diamFill( treeData )
  
  wd <- which( treeData$diam <= 0 )
  if( length( wd ) > 0 )treeData$diam[wd] <- NA
  
  wna <- which( is.na( treeData$diam ) )
  
  if( length( wna ) > 0 ){        
    
    treeID <- columnPaste( treeData$plot,treeData$tree )
    
    # interpolate missing diameters
    ii <- as.character( treeID )
    jj <- treeData$year
    jtimes <- sort( unique( jj ) )
    i  <- unique( ii )
    
    icol <- match( ii,i )
    jcol <- match( jj,jtimes )
    ijFull <- matrix( 0,length( i ),length( jtimes ) )
    ijFull[ cbind( icol,jcol ) ] <- treeData$diam
    
    maxVal <- max( treeData$diam, na.rm=T ) + 1
    
    jmat <- ijFull*0
    
    if( ncol( jmat ) > 1 ){
      for( i in 1:nrow( ijFull ) ){
        rr <- range( ijFull[i,], na.rm=T )
        rr[1] <- rr[1] - .3
        rr[2] <- rr[2] + .3
        jmat[i,] <- .interp( ijFull[i,],INCREASING=T,
                             minVal=rr[1],maxVal=rr[2],defaultValue=NULL )
      }
    }
    jmat[jmat < 0] <- 0
    
    wf <- which( is.finite( ijFull ) )
    jmat[wf] <- ijFull[wf]
    jmat <- round( jmat,2 )
    
    treeData$diam <- jmat[ cbind( icol,jcol ) ]
  }
  
  if( !'repr' %in% colnames( treeData ) )treeData$repr <- NA
  if( !'repMu' %in% colnames( treeData ) )treeData$repMu <- NA
  if( !'repSd' %in% colnames( treeData ) )treeData$repSd <- NA
  
  if( is.character( treeData$cropFraction ) )stop( 'cropFraction 0' )##########
  
  if( genus == 'pinus' & !'serotinous' %in% colnames( treeData ) )
    treeData$serotinous <- 0
  
  if( 'cropFraction' %in% colnames( treeData ) ){
    if( !'cropFractionSd' %in% colnames( treeData ) ){
      treeData$cropFractionSd <- NA
      wm <- which( is.finite( treeData$cropFraction ) )
      fs <- .5*dbeta( treeData$cropFraction[wm], .1,2 ) + 1e-3
      treeData$cropFractionSd[wm] <- fs
    }
  }
  
  cc <- which( !pcols %in% colnames( treeData ) )
  if( length( cc ) > 0 ){
    for( p in cc ){
      pc <- matrix( NA, nrow( treeData ), 1 )
      colnames( pc ) <- pcols[p]
      treeData <- cbind( treeData, pc )
    }
  }
  
  treeData
}

censoredSeedCols <- function( seedData, seedNames ){
  
  minmax <- unique( c( grep( '_min', colnames( seedData ) ), 
                       grep( '_max', colnames( seedData ) ) ) ) # min/max cols
  snames   <- unique( c( colnames( seedData )[minmax], seedNames ) )
  newSeeds <- .replaceString( colnames( seedData )[minmax],'_min','' )
  newSeeds <- .replaceString( newSeeds,'_max','' )
  newSeeds <- sort( unique( newSeeds ) )
  newSeeds <- newSeeds[!newSeeds %in% colnames( seedData )]
  if( length( newSeeds ) > 0 ){
    snew <- matrix( NA,nrow( seedData ),length( newSeeds ) )
    colnames( snew ) <- newSeeds
    seedData <- cbind( seedData, snew )
  }
  seedData
}


firstLast2treeData <- function( treeData ){
  
  FIRST <- 'firstYr' %in% colnames( treeData )
  LAST  <- 'lastYr' %in% colnames( treeData )
  
  if( !FIRST ){
    firstPl <- tapply( treeData$year, treeData$plot, min )
    firstTr <- tapply( treeData$year, treeData$treeID, min )
    firstTr <- firstTr[ match( treeData$treeID, names( firstTr ) ) ]
    firstPl <- firstPl[ match( treeData$plot, names( firstPl ) ) ]
    firstYr <- firstPl
    wy   <- which( ( firstTr - firstPl ) > 10 )
    if( length( wy ) > 0 ){
      firstPl[ wy ] <- firstTr[ wy ] - 5
    }
    treeData$firstYr <- firstPl
  }
  
  if( !LAST ){
    lastPl <- tapply( treeData$year, treeData$plot, max )
    lastTr <- tapply( treeData$year, treeData$treeID, max )
    lastTr <- lastTr[ match( treeData$treeID, names( lastTr ) ) ]
    lastPl <- lastPl[ match( treeData$plot, names( lastPl ) ) ]
    lastYr <- lastPl
    wy   <- which( ( lastPl - lastTr ) > 10 )
    if( length( wy ) > 0 ){
      lastYr[ wy ] <- lastTr[ wy ] + 1
    }
    treeData$lastYr <- lastYr
  }
  treeData
}


combineSeedNamesOld <- function( sdata, snames, cseed=NULL ){
  
  if( is.null( cseed ) )
    return( list( seedNames = snames, seedData = sdata ) )
  
  from <- cseed[,1]
  to   <- cseed[,2]
  
  c1 <- matrix( paste( from,'_min',sep='' ), ncol=1 )
  c2 <- matrix( paste( from,'_max',sep='' ), ncol=1 )
  
  cnew <- rbind( cbind( c1, to ), cbind( c2, to ) )
  
  cmb <- rbind( cbind( from, to ) , cnew )
  
  wmm <- grep( '_min_min',cmb[,1] )
  if( length( wmm ) > 0 ){
    cmb[wmm,1] <- .replaceString( cmb[wmm,1], '_min_min','_min' )
  }
  wmm <- grep( '_min_max',cmb[,1] )
  if( length( wmm ) > 0 ){
    cmb[wmm,1] <- .replaceString( cmb[wmm,1], '_min_max','_min' )
  }
  cmb <- cmb[!duplicated( cmb[,1] ),]
  cmb <- cmb[order( cmb[,1] ),]
  
  smb1 <- paste( snames,'_min',sep='' )
  smb2 <- paste( snames,'_max',sep='' )
  smb  <- c( snames, smb1, smb2 )
  
  wmm <- grep( '_min_min',smb )
  if( length( wmm ) > 0 ){
    smb[wmm] <- .replaceString( smb[wmm], '_min_min','_min' )
  }
  wmm <- grep( '_min_max',smb )
  if( length( wmm ) > 0 ){
    smb[wmm] <- .replaceString( smb[wmm], '_min_max','_min' )
  }
  smb <- smb[!duplicated( smb )]
  
  ww <- which( smb %in% cmb[,'from'] )
  if( length( ww ) == 0 | is.null( cmb ) )
    return( list( seedNames = snames, seedData = sdata ) )
  
  mm <- match( smb[ww], cmb[,'from'] )
  
  # sall <- smb[-mm]
  
  for( k in 1:length( mm ) ){
    fromk <- cmb[mm[k],'from']
    tok   <- cmb[mm[k],'to']
    smb[ww[k]] <- tok
    if( !tok %in% colnames( sdata ) & fromk %in% colnames( sdata ) ){
      colnames( sdata )[colnames( sdata ) == fromk] <- tok
      next
    }
    if( tok %in% colnames( sdata ) & fromk %in% colnames( sdata ) ){
      sdata[ ,tok ] <- sdata[ ,tok ] +
        sdata[ ,fromk ]
    }else{
      colnames( sdata )[colnames( sdata ) == fromk] <- tok
    }
  }
  
  wm <- which( colnames( sdata ) %in% cmb[,'from'] )
  if( length( wm ) > 0 )sdata <- sdata[,-wm]
  
  seedNames <- snames[!duplicated( snames )]
  seedNames <- seedNames[seedNames %in% colnames( sdata )]
  
  list( seedNames = seedNames, seedData = sdata )
}

combineSpecies <- function( specVec, specNames = NULL, combineSpecs = NULL ){
  
  if( is.null( combineSpecs ) )
    return( list( specNames = specNames, species = specVec ) )
  
  if( !is.character( specVec ) )specVec <- as.character( specVec )
  
  if( is.null( specNames ) )specNames <- sort( unique( specVec ) )
  
  if( !is.null( combineSpecs ) ){
    wf <- which( combineSpecs[,'from'] %in% as.character( specVec ) )
    if( length( wf ) > 0 ){
      specs <- as.character( specVec )
      for( m in wf ){
        ws <- which( specs == combineSpecs[m,'from'] )
        specs[ws] <- combineSpecs[m,'to']
      }
      #    specVec <- as.factor( specs )
      specVec <- specs
    }
    specNames <- sort( unique( as.character( specVec ) ) )
  }
  list( specNames = specNames, species = specVec )
}

checkTreeVars <- function( tfile, tdata, numCols, grpCols, CHECKEMPTY = F ){
  
  # numCols - not with year reference
  # grpCols - have year reference, e.g., diam2019
  
  cc <- numCols[ numCols %in% colnames( tdata ) ]
  if( length( cc ) > 0 ){
    ww <- which( !sapply( tdata[,cc], is.numeric ) )
    vv <- which( sapply( tdata[,cc], is.logical ) )
    if( length( ww ) > 0 ){
      print( tfile )
      print( cc[ww] )
    }
  }
  
  # these are empty columns
  if( CHECKEMPTY ){
    for( m in 1:length( grpCols ) ){
      wm <- grep( grpCols[m], colnames( tdata ) )
      
      if( length( wm ) == 0 )next
      
      vv <- which( sapply( tdata[,wm], is.logical ) )
      
      if( length( vv ) > 0 ){
        print( tfile )
        print( paste( 'this column appears to be empty, fix:',names( vv ) ) )
        tdata <- tdata[,!colnames( tdata ) %in% names( vv )]
      }
    }
    
    
    # these are non-numeric columns
    
    for( m in 1:length( grpCols ) ){
      wm <- grep( grpCols[m], colnames( tdata ) )
      
      if( length( wm ) == 0 )next
      if( length( wm ) == 1 & !is.numeric( tdata[,wm] ) )ww <- wm
      if( length( wm ) > 1 )ww <- which( !sapply( tdata[,wm], is.numeric ) )
      if( length( ww ) == 0 )next
      
      print( tfile )
      print( paste( 'this column could be empty, remove:',names( ww ) ) )
      tdata <- tdata[,!colnames( tdata ) %in% names( ww )]
    }
  }
  
  tdata
}

nameFix <- function( specVec ){
  
  nn <- rbind( c( 'acerBarb', 'acerFloridan' ), 
               c( 'acerCampestri', 'acerCampestr' ),
               c( 'acerNigra', 'acerNigru' ), 
               c( 'acerSacc', 'acerSaccharum' ), 
               c( 'caryGlab', 'caryaGlabra' ),
               c( 'caryTome', 'caryaAlba' ), 
               c( 'cornusPacifica', 'cornusNuttalli' ),
               c( 'corylusAvelana', 'corylusAvellana' ), 
               c( 'franExce', 'fraxinusExcelsior' ), 
               c( 'fraxinusExelsior', 'fraxinusExcelsior' ), 
               c( 'neeaAff.flor', 'neeaFloribun' ),
               c( 'piceStro', 'pinusStrobus' ), 
               c( 'pouteriaTortaGla', 'pouteriaTorta' ),
               c( 'querCocc', 'quercusCoccinea' ), 
               c( 'querMacr', 'quercusMacrocarp' ), 
               c( 'querPrin', 'quercusMontana' ),
               c( 'quercusPrinus', 'quercusMontana' ), 
               c( 'pinuStro', 'pinusStrobus' ), 
               c( 'popuTrem', 'populusTremuloi' ),
               c( 'sorbusAria', 'ariaEdulis' ),
               c( 'thugOcci', 'thujaOccident' ) )
  
  for( j in 1:nrow( nn ) ){
    jn <- which( specVec == nn[j,1] )
    if( length( jn ) == 0 )next
    specVec <- .replaceString( specVec, nn[j,1], nn[j,2] )
  }
  specVec
}

columnSplit <- function( vec, sep = '_', ASFACTOR = F, ASNUMERIC = FALSE, 
                         LASTONLY = FALSE ){
  
  vec <- as.character( vec )
  nc  <- length( strsplit( vec[ 1], sep, fixed = TRUE )[[ 1]] )
  
  mat <- matrix( unlist( strsplit( vec, sep, fixed = TRUE ) ), ncol = nc, byrow = TRUE )
  if( LASTONLY & ncol( mat ) > 2 ){
    rnn <- mat[, 1]
    for( k in 2:( ncol( mat )-1 ) ){
      rnn <- columnPaste( rnn, mat[, k] )
    }
    mat <- cbind( rnn, mat[, ncol( mat )] )
  }
  if( ASNUMERIC ){
    mat <- matrix( as.numeric( mat ), ncol = nc )
  }
  if( ASFACTOR ){
    mat <- data.frame( mat )
  }
  if( LASTONLY )mat <- mat[, 2]
  mat
}


columnPaste <- function( c1, c2, sep='-', NOSPACE = FALSE ){
  
  c1    <- as.character( c1 )
  c2    <- as.character( c2 )
  if( NOSPACE ){
    c1   <- .replaceString( c1, ' ', '' )
    c2   <- .replaceString( c2, ' ', '' )
  }
  c12   <- apply( cbind( c1, c2 ) , 1, paste0, collapse=sep )
  
  c12
}


.replaceString <- function( xx, now='_', new=' ' ){  #replace now string in vector with new
  
  if( !is.character( xx ) )xx <- as.character( xx )
  
  ww <- grep( now,xx,fixed  = TRUE )
  if( length( ww ) == 0 )return( xx )
  
  if( length( new ) == 1 ){
    for( k in ww ){
      s  <- unlist( strsplit( xx[k],now,fixed  = TRUE ) )
      ss <- s[1]
      if( length( s ) == 1 )ss <- paste( ss,new,sep='' )
      if( length( s ) > 1 )for( kk in 2:length( s ) ) ss <- paste( ss,s[kk],sep=new )
      xx[k] <- ss
    }
  }else{
    # new is a vector
    s  <- unlist( strsplit( xx,now,fixed  = TRUE ) )
    nx <- length( xx )
    nc <- length( s )/length( xx )
    
    ss <- matrix( s, ncol=nc, byrow  = TRUE )
    nl <- nchar( ss[1,] )
    
    if( nl[1] == 0 )ss <- paste( new, ss[,2], sep='' )
    if( nl[2] == 0 )ss <- paste( ss[,1], new, sep='' )
    
    xx <- ss
  }
  xx
}


getEcoReg <- function( tdata, 
                       rpath = "/Users/jimclark/makeMastOnJimClark/ecoRegionFiles/WWFecoRegions" ){
  
  
  #https://www.worldwildlife.org/publications/terrestrial-ecoregions-of-the-world
  # tdata has plot, lon, lat
  
  require( maptools )
  require( ggmap )
  require( rgeos )
  require( sp )
  require( rgdal )
  
  tdata$plot <- as.character( tdata$plot )
  
  pnow <- getwd( )
  
  plots <- unique( tdata$plot )
  mm    <- match( plots, tdata$plot )
  
  dat   <- data.frame( Longitude = tdata$lon[mm], Latitude = tdata$lat[mm],
                       names = tdata$plot[mm] )
  wkeep <- which( is.finite( dat$Longitude ) )
  dat <- dat[wkeep,]
  coordinates( dat ) <- ~ Longitude + Latitude
  
  setwd( rpath )
  wwf <- readOGR( ".", "wwf_terr_ecos" )
  
  proj4string( dat ) <- CRS( "+proj=longlat" )
  
  wwf3 <- spTransform( dat, proj4string( wwf ) )
  dat$ecoRegWWF <- over( wwf3, wwf )$ECO_NAME 
  dat$ecoCode <- over( wwf3, wwf )$eco_code 
  
  dat$ecoRegWWF <- shortEcoReg( dat$ecoRegWWF )
  ecoReg <- as.character( dat$ecoRegWWF )
  
  setwd( pnow )
  
  kk <- match( tdata$plot, plots )
  ecoReg[kk]
}

UTM2latlon <- function( xy, zone = NULL, lon = NULL, southern = FALSE ){
  
  #xy has 2 columns or 3 columns, x, y, zone
  
  if( ncol( xy ) == 2 ){
    if( is.null( zone ) & is.null( lon ) )stop( 'zone or lon must be specified' )
    if( is.null( zone ) )zone <- long2UTMZone( lon )
    xy <- cbind( xy, zone )
  }
  
  if( length( southern ) == 1 )southern <- rep( southern, nrow( xy ) )
  
  require( rgdal )
  
  colnames( xy ) <- c( "x","y","zone" )
  
  zones <- sort( unique( xy[,'zone'] ) )
  
  ll <- xy[drop=F,,1:2]
  
  for( j in zones ){
    
    wj  <- which( xy[,'zone'] == j )
    xyj <- as.data.frame( xy[drop=F, wj,] )
    
    ws <- which( southern[wj] )
    wn <- which( !southern[wj] )
    
    if( length( ws ) > 0 ){
      xys <- as.data.frame( xyj[drop=F,ws,] )
      
      coordinates( xys ) <- c( "x", "y" )
      cstring <- paste( '+proj=utm +zone=', j,' +ellps=WGS84 +south', sep='' )
      upoints <- suppressWarnings( SpatialPoints( coords=xys,
                                                  proj4string=CRS( cstring ) ) )
      
      ut <- suppressWarnings( spTransform( upoints, 
                                           CRS( "+proj=longlat +ellps=WGS84 +south" ) ) ) # ll to utm
      ut <- as.data.frame( ut )
      
      ll[wj[ws],1:2] <- ut
    }
    if( length( wn ) > 0 ){
      xys <- as.data.frame( xyj[drop=F,wn,] )
      coordinates( xys ) <- c( "x", "y" )
      cstring <- paste( '+proj=utm +zone=', j,' +ellps=WGS84 +north', sep='' )
      upoints <- suppressWarnings( SpatialPoints( coords=xys,
                                                  proj4string=CRS( cstring ) ) )
      ut <- suppressWarnings( spTransform( upoints, 
                                           CRS( "+proj=longlat +ellps=WGS84 +north" ) ) ) # ll to utm
      ut <- as.data.frame( ut )
      ll[wj[wn],1:2] <- as.matrix( ut )
    }
  }
  colnames( ll ) <- c( 'lon','lat' )
  ll
}

spacedVector <- function( x, y, newx, window = 3 ){
  
  if( length( y ) < window ){
    warning( 'short y could not be spaced' )
    return( cbind( x, y ) )
  }
  
  newy <- newx*0
  dx <- diff( range( newx ) )
  
  for( i in 1:length( newx ) ){
    
    xi <- newx[i]
    wi <- numeric( 0 )
    win <- window/2
    while( length( wi ) < 3 ){
      win <- win*1.2
      wi <- which( x > ( xi - win ) & x < ( xi + win ) )
    }
    xx <- x[ wi ]
    wt <- 1/( abs( xx - xi )^2 + dx/10000 )
    yi <- sum( y[wi]*wt )/sum( wt )
    newy[i] <- yi
  }
  
  cbind( newx, newy )
}


mergeMat <- function( specSite, specBySite ){
  
  if( length( specSite ) == 0 )return( specBySite )
  
  asite <- sort( unique( c( colnames( specSite ),colnames( specBySite ) ) ) )
  aspec <- sort( unique( c( rownames( specSite ),rownames( specBySite ) ) ) )
  
  tmat  <- matrix( 0, length( aspec ), length( asite ) )
  colnames( tmat ) <- asite
  rownames( tmat ) <- aspec
  tmat[rownames( specBySite ),colnames( specBySite )] <- 
    tmat[rownames( specBySite ),colnames( specBySite )] + specBySite
  tmat[rownames( specSite ),colnames( specSite )] <- 
    tmat[rownames( specSite ),colnames( specSite )] + specSite
  tmat <- tmat[,order( colnames( tmat ) )]
  tmat <- tmat[order( rownames( tmat ) ),]
  tmat
}


getSeedTraits <- function( specNames, code = 'code8', region = NULL,
                           file = "/Users/jimclark/Documents/makeMastOnJimClark/traitsByGroup/plantTraits.csv" ){
  
  # code = 'code4', 'code8'
  traitTable <- read.csv( file, stringsAsFactors=F )
  
  # code8 <- species2code( traitTable$genus, traitTable$specEpith, length = 8 )
  # traitTable <- traitTable[,!colnames( traitTable ) == 'code7']
  # traitTable <- cbind( code8, traitTable )
  # write.csv( traitTable, file = file, row.names = F, quote = F )
  
  
  if( !code %in% colnames( traitTable ) ){
    
    length <- as.numeric( substring( code, 5 ) )
    
    variableSearch <- NULL
    if( !is.null( region ) )variableSearch <- list( region = region )
    spec <- code2species( specNames, variableSearch = variableSearch )
    gg   <- columnSplit( spec, ' ' )
    specNames   <- species2code( gg[,1],gg[,2], length = length )
    
  }
  
  wspec <- match( specNames,traitTable[,code] )
  seedMass <- as.matrix( traitTable[wspec,'gmPerSeed',drop=F] ) # gm per seed
  rownames( seedMass ) <- specNames
  
  wna <- which( is.na( seedMass ) )
  if( length( wna ) > 0 ){
    seedMass[wna] <- mean( seedMass,na.rm=T )
  }
  
  seedMass[is.na( seedMass )] <- 1
  seedsPerFruit <- as.matrix( traitTable[wspec,'seedsPerFruit',drop=F] )
  rownames( seedsPerFruit ) <- specNames
  
  traits <- traitTable[match( specNames,traitTable[,code] ),
                       c( code,"gmPerSeed","seedsPerFruit" )]
  missSpec <- which( is.na( traits[,code] ) )
  if( length( missSpec ) > 0 )traits[,code][missSpec] <- specNames[missSpec]
  
  rownames( traits ) <- traits[,code]
  seedTraits <- traits[,c( "gmPerSeed","seedsPerFruit" )]
  
  wna <- which( is.na( seedTraits ), arr.ind=T )
  if( length( wna ) > 0 ){
    tmu <- signif( colMeans( seedTraits, na.rm=T ), 3 )
    seedTraits[ wna ] <- tmu[ wna[,2] ]
  }
  
  seedTraits[is.na( seedTraits )] <- 1
  seedTraits
}

ssPlots <- "CWT_118"
cfiles <- c("compressedFiles/east/clarkLab/pinus.Rdata", 
            "compressedFiles/east/clarkLab/quercus.Rdata")

updatePlotAreas <- function(){
  
  gt <- grep( 'ST', plotData$data )
  ssPlots <- plotData$plot[ gt ]
  ssPlots <- sort( ssPlots )
  
  cfiles <- list.files( 'compressedFiles', recursive = T, full.names = T )
  cfiles <- cfiles[ startsWith(cfiles, 'compressed') ]
  
  clist <- vector( 'list', length(ssPlots) )
  names( clist ) <-  ssPlots 
  
  for( k in 1:length(cfiles) ){
    
    xytree <- NULL
    
    load( cfiles[k], verbose = F )
    
    if( is.null( xytree ) )next
    
    print( cfiles[k] )
    
    treeData <- treeData[ treeData$plot %in% ssPlots, ]
    xytree   <- xytree[ xytree$plot %in% ssPlots, ]
    
    if( nrow(treeData) == 0 )next
    
    colnames( xytree )[colnames(xytree) == 'UTMx'] <- 'x'
    colnames( xytree )[colnames(xytree) == 'UTMy'] <- 'y'
    
    years <- min(treeData$year):max(treeData$year)
    
    
    treeData$treeID <- paste( treeData$plot, treeData$tree, sep = '-' )
    xytree$treeID   <- paste( xytree$plot, xytree$tree, sep = '-' )
    
    plotYr <- paste( treeData$plot, treeData$year, sep = '-' )
    plotYears <- sort( unique( plotYr ) )
    hull        <- vector( 'list', length( plotYears ) )
    plotHull  <- rep('', length(plotYears) )
    names(hull) <- plotYears
    #  utm             <- xytree
    
    for( j in 1:length(plotYears)){
      
      wj <- which( plotYr == plotYears[j] )
      if( length( wj ) == 0 )next
      
      ti <- treeData$treeID[ wj ]
      if( length( ti ) == 0 )next
      
      plotHull[j] <- treeData$plot[wj[1]]
      
      xy <- xytree[ match( ti, xytree$treeID ), c('x','y')]
      
      if( plotYears[j] %in% names( clist[[ plotHull[j] ]] ) ){
        cj <- clist[[ plotHull[j] ]][[ plotYears[j] ]]
        xy <- rbind( xy, cj )
      }
      
      xy <- xy[ is.finite( xy[,1] ) & is.finite( xy[,2] ),  ]
      
      hh <- xy[ chull( xy ), ]
      
      hull[[ plotYears[j] ]] <-  hh
      
      if( plotYears[j] %in% names( clist[[ plotHull[j] ]] ) ){
        clist[[ plotHull[j] ]][[ plotYears[j] ]] <- hh
      }
      
    }
    
    pj <- unique( plotHull )
    
    for( j in 1:length(pj) ){
      
      hj <- hull[ plotHull == pj[j] ]
      
      if( is.null( clist[[ pj[j] ]] ) ){
        clist[[ pj[j] ]] <- append( clist[[ pj[j] ]],  hj  )
      }
      
    }
  }
  
  areaPlotByYr <- numeric(0)
  
  for( k in 1:length( clist ) ){
    
    ck <- clist[[k]]
    if( is.null( ck ) )next
    nn <- columnSplit( names(ck), '-' )
    cm <- matrix( NA, 1, length(ck), dimnames = list( nn[1,1], nn[,2]) )
    
    for( j in 1:length(ck) ){
      if( nrow( ck[[j]] ) <= 1 ){
        cm[1,j] <- 0
      }else{
        cm[1,j] <- round( xy2area( ck[[j]] )$area/10000, 3 )
      }
    }
    areaPlotByYr <- .appendMatrix( areaPlotByYr, cm, SORT = T )
  }
  
  for( m in 2:ncol(areaPlotByYr)){
    wm <- which( areaPlotByYr[,m] == 0 )
    if( length(wm) == 0 )next
    
    areaPlotByYr[wm,m] <- areaPlotByYr[wm,m-1]
  }
  
  file <- 'areaPlotByYr.csv'
  
  current <- read.csv( file, row.names = 1 )
  colnames( current ) <- .replaceString( colnames(current), 'X', '' )
  
  wc <- which( !colnames( areaPlotByYr ) %in% colnames(current ) )
  if( length(wc) > 0 ){
    new <- matrix( NA, nrow( areaPlotByYr ), length(wc),
                   dimnames = list( rownames(areaPlotByYr), wc ))
    current <- cbind( current, new )
    current <- current[, colnames( areaPlotByYr ) ]
  }
  wc <- which( !rownames( areaPlotByYr ) %in% rownames(current ) )
  if( length(wc) > 0 ){
    new <- matrix( NA, length(wc), ncol( areaPlotByYr ),
                   dimnames = list( wc, colnames(areaPlotByYr) ))
    current <- rbind( current, new )
    current <- current[ rownames( areaPlotByYr ),  ]
  }
  
#  current[ is.na(current) ] <- 0
  
  wc <- which( areaPlotByYr != current & is.finite( as.matrix(current) ) )
  
  areaPlotByYr[ wc ] <- as.matrix( current )[wc]
  write.csv( areaPlotByYr, file = file, row.names = T )
}

.treeFormat <- function( tfile, specNames = NULL, genusName = NULL,    # in moreFunctions.R
                         changeNames = NULL, plot, reg = NULL, 
                         years = NULL, yrCols, MUSTHAVE = FALSE, keepCols = NULL, 
                         verbose = FALSE ){
  
  # if MUSTHAVE, tree rejected if any yrCols are missing
  
  newplot <- plot
  
  midCD <- c( 273890.6, 3938623.3 )  #plot center for ( x, y ) at GSNP_CD
  
  site <- unlist( strsplit( plot, '_' ) )[ 1]
  
  CSV <- endsWith( tfile, '.csv' )
  if( CSV ){
    trees <- read.csv( tfile, stringsAsFactors = FALSE )
  }else{
    trees  <- read.table( tfile, header = TRUE, stringsAsFactors = FALSE )
  }
  
  wd <- grep( 'diam', colnames( trees ) )
  
  kk <- which( sapply( trees[, wd], is.character ) )
  
  if( length( kk ) > 0 ){
    stop( paste( 'character in column', names( kk ) ) )
  }
  
  colnames( trees ) <- .replaceString( colnames(trees), 'canopy', 'shade' )
  
  trees <- trees[ !trees$species %in% c('rhododenCalendul', 'unknownUNKNOWN'), ]
  
  
  trees$species[ trees$species == "piceStro"] <- "pinusStrobus"
  trees$species[ trees$species == "acerSacc"] <- "acerSaccharum"
  trees$species[ trees$species == "querMacr"] <- "quercusMacrocarp"
  trees$species[ trees$species == 'acerNigra'] <- 'acerNigru'
  trees$species[ trees$species == 'caryTome'] <- 'caryaAlba'
  trees$species[ trees$species == 'acerBarb'] <- 'acerFloridan'
  trees$species[ trees$species == 'americanUlmus'] <- 'ulmusAmerican'
  trees$species[ trees$species == 'nigraJuniperu'] <- 'juglansNigra'
  trees$species[ trees$species == 'UNKNCarya'] <- 'caryaUNKN'
  trees$species[ trees$species == 'rubraUNKN'] <- 'ulmusRubra'
  trees$species[ trees$species == 'gymnDioc'] <- 'gymnoclaDioicus'
  
  trees$species <- .replaceString( trees$species, 'Unkn', 'UNKN' )
  trees$species <- .replaceString( trees$species, 'UNKNOWN', 'UNKN' )
  
  wu <- which( trees$species == 'UNKNUNKN' )
  if( length(wu) > 0)trees <- trees[ -wu, ]
  
  specs <- sort( unique( trees$species ) )
  mm    <- match( trees$species, specs )
  
  variableSearch <-  list( region = reg )
  if( is.null(reg) )variableSearch <- NULL
  
  spp <- code2species( specs,  variableSearch = variableSearch )
  
  if( !is.null( attr( spp, 'conflicts' ) ) ) stop( 'spp conflicts in trait file' )
  if( !is.null( attr( spp, 'missing' ) ) ) stop( 'missing spp in trait file' )
  
  gg  <- columnSplit( spp, ' ' )
  spp <- species2code( gg[, 1], gg[, 2], length = 8 )
  
  trees$species <- spp[ mm ]
  
  
  if( 'plotID' %in% colnames( trees ) )trees$plot <- trees$plotID
  if( 'individualID' %in% colnames( trees ) )trees$tree <- trees$individualID
  
  trees <- trees[ which( trees$plot == plot ), ]
  if( nrow( trees ) == 0 )return( list( yrDat = numeric( 0 ) ) )
  
  if( is.null( specNames ) & is.null( genusName ) ){
    specNames <- sort( unique( as.character( trees$species ) ) )
  }
  if( is.null( specNames ) & !is.null( genusName ) ){
    ss <- which( substr( trees$species, 1, 4 ) == substr( genusName, 1, 4 ) )
    specNames <- sort( unique( as.character( trees$species[ ss] ) ) )
  }
  
  trees$ID   <- as.character( trees$tree )
  treeID     <- columnPaste( trees$plot, trees$tree )
  
  if( 'UTMX' %in% colnames( trees ) )colnames( trees )[ colnames( trees ) == 'UTMX'] <- 'UTMx'
  if( 'UTMY' %in% colnames( trees ) )colnames( trees )[ colnames( trees ) == 'UTMY'] <- 'UTMy'
  
  if( !'UTMx' %in% colnames( trees ) )trees$UTMx <- trees$x
  if( !'UTMy' %in% colnames( trees ) )trees$UTMy <- trees$y
  
  
  # if( !'x' %in% colnames( trees ) )trees$x <- trees$UTMx
  # if( !'y' %in% colnames( trees ) )trees$y <- trees$UTMy
  
  if( plot == "GSNP_CD" ){
    trees$x <- trees$UTMx - midCD[ 1]
    trees$y <- trees$UTMy - midCD[ 2]
  }
  
  trees$x <- trees$UTMx
  trees$y <- trees$UTMy
  
  trees$plot <- newplot
  trees$species <- as.character( trees$species )
  
  if( is.null( genusName ) ){
    wj     <- which( trees$species %in% specNames & is.finite( trees$x ) &
                       is.finite( trees$y ) )
  }else{
    ww <- grep( genusName, as.character( trees$species ) )
    wj <- ww[ which( is.finite( trees$x[ ww] ) & is.finite( trees$y[ ww] ) )]
    specNames <- sort( unique( trees$species[ wj] ) )
  }
  if( length( wj ) == 0 )return( list( yrDat = numeric( 0 ) ) )
  
  trees  <- trees[ drop = FALSE, wj, ]
  
  mcol <- grep( 'diam', colnames( trees ) )
  dmm  <- suppressWarnings( max( trees[, mcol], na.rm = T ) )
  if( dmm < 0 )return( list( yrDat = numeric( 0 ) ) )
  
  wchange <- which( as.character( trees$species ) %in% changeNames[, 1] )
  if( length( wchange ) > 0 ){
    ts <- as.character( trees$species )
    wm <- match( ts[ wchange], changeNames[, 1] )
    ts[ wchange] <- changeNames[ wm, 2]
    trees$species[ wchange] <- ts[ wchange]
  }
  
  yrc <- yrCols
  ww  <- grep( 'crop', yrc )
  if( length( ww ) > 0 )yrc <- yrc[ -ww]
  
  if( MUSTHAVE ){
    
    for( k in 1:length( yrc ) ){                      
      
      tk   <- as.matrix( trees[, grep( yrc[ k], colnames( trees ) )] )
      wmin <- suppressWarnings( apply( tk, 1, min, na.rm = TRUE ) )
      wna  <- which( !is.finite( wmin ) )
      if( length( wna ) > 0 )trees <- trees[ -wna, ]
    }
    if( nrow( trees ) == 0 )return( list( yrDat = numeric( 0 ) ) )
  }
  
  # trees with multiple stems
  ID      <- as.character( trees$tree )
  dup     <- which( duplicated( ID ) )
  diamCol <- grep( 'diam', colnames( trees ) )
  
  if( length( dup ) > 0 ){
    
    for( j in dup ){
      
      idup <- which( ID == ID[ j] )
      
      ID[ idup] <- paste( ID[ idup], letters[ 1:length( idup )], sep = '' )
      trees$tree[ idup] <- ID[ idup]
    }
    trees$ID <- ID
  }
  
  ser <- c( grep( 'serotinous', colnames( trees ) ), 
            grep( 'serotinuos', colnames( trees ) ) )
  if( length( ser ) > 0 ){
    if( length( ser ) == 1 ){
      trees[, ser] <- as.character( trees[, ser] )
    }else{
      trees[, ser] <- lapply( trees[, ser], as.character )
    }
    serotinous <- rep( 0, nrow( trees ) )
    for( k in 1:length( ser ) ){
      serotinous[ is.na( trees[, ser[ k]] )] <- .2
      serotinous[ trees[, ser[ k]] == 'S'] <- 1
      serotinous[ trees[, ser[ k]] == 'B'] <- .5
    }
    trees$serotinous <- serotinous
  }
  
  dataYr <- as.numeric( columnSplit( colnames( trees )[ diamCol], 'diam' )[, 2] )
  dmat   <- trees[, diamCol, drop = F]
  dmat[ dmat > 0] <- 1
  dmat[ is.na( dmat )] <- 0
  dmat <- t( apply( dmat, 1, cumsum ) )
  
  if( length( diamCol ) == 1 ){
    fyr <- lyr <- rep( dataYr, nrow( trees ) )
  }else{
    lyr <- dataYr[ apply( dmat, 1, which.max )]
    dmat[ dmat == 0] <- Inf
    fyr <- dataYr[ apply( dmat, 1, which.min )]
  }
  
  if( !'censinyr' %in% colnames( trees ) ){
    trees$censinyr <- fyr
  }else{
    trees$censinyr <- as.numeric( trees$censinyr )
    trees$censinyr[ is.na( trees$censinyr )] <- fyr[ is.na( trees$censinyr )]
  }
  if( !'growinyr' %in% colnames( trees ) ){
    trees$growinyr <- trees$censinyr
  }else{
    trees$growinyr <- as.numeric( trees$growinyr )
  }
  if( !'deathyr' %in% colnames( trees ) ){
    trees$deathyr <- NA
  }else{
    trees$deathyr <- as.numeric( trees$deathyr )
  }
  if( !'censoryr' %in% colnames( trees ) ){
    trees$censoryr <- lyr
  }else{
    trees$censoryr <- as.numeric( trees$censoryr )
    trees$censoryr[ is.na( trees$censoryr )] <- lyr[ is.na( trees$censoryr )]
  }
  trees$firstYr <- apply( cbind( trees$censinyr, trees$growinyr ), 1, min, na.rm = T )
  trees$lastYr  <- apply( cbind( trees$censoryr, trees$deathyr ), 1, max, na.rm = T ) + 1
  trees$lastYr[ !is.finite( trees$lastYr )] <- lyr[ !is.finite( trees$lastYr )] + 1
  
  
  
  colnames( trees ) <- .replaceString( colnames( trees ), 'cropFractionSD', 'cropFractionSd' )
  
  wk <- grep( 'cropCount', colnames( trees ) )
  if( length( wk ) > 0 )yrCols <- c( yrCols, 'cropCount' )
  wk <- grep( 'cropFraction', colnames( trees ) )
  if( length( wk ) > 0 )yrCols <- c( yrCols, 'cropFraction' )
  wk <- grep( 'cropFractionSd', colnames( trees ) )
  if( length( wk ) > 0 )yrCols <- c( yrCols, 'cropFractionSd' )
  
  yrCols <- yrCols[ !duplicated( yrCols )]
  
  yrange <- numeric( 0 )
  
  for( k in 1:length( yrCols ) ){
    
    wk <- which( startsWith( colnames( trees ), yrCols[ k] ) )
    
    if( length( wk ) == 0 )next
    
    yk <- columnSplit( colnames( trees )[ wk], yrCols[ k] )[, 2]
    ww <- grep( 'Sd', yk )
    if( length( ww ) > 0 )next
    
    yk <- .replaceString( yk, 'Sd', '' )
    yrange <- c( yrange, as.numeric( yk ) )
  }
  
  wk <- which( startsWith( colnames( trees ), 'sex' ) )
  
  if( length( wk ) > 0 ){
    yk <- columnSplit( colnames( trees )[ wk], 'sex' )[, 2]
    yrange <- c( yrange, as.numeric( yk ) )
  }
  years <- min( yrange ):max( yrange )
  
  # reproduction
  
  snew <- matrix( NA, nrow( trees ), length( years ) )
  colnames( snew ) <- years
  
  scols <- as.matrix( trees[, grep( 'sex', colnames( trees ) ), drop = FALSE] )
  
  if( ncol( scols ) == 0 )scols <- NULL
  
  if( !is.null( scols ) ){
    
    ccol <- matrix( unlist( strsplit( colnames( scols ), 'sex' ) ), ncol = 2, byrow = 2 )[, 2]
    colnames( scols ) <- ccol
    
    snot <- which( scols == 'N', arr.ind = TRUE )
    srep <- which( scols == 'R' | scols == 'F', arr.ind = TRUE )
    sfem <- which( scols == 'F', arr.ind = TRUE )
    smal <- which( scols == 'M', arr.ind = TRUE )
    
    smal <- smal[ !smal[, 1] %in% sfem[, 1], ]  # female overrides male
    if( !is.matrix( smal ) )smal <- matrix( smal, 1 )
    
    matr <- repr <- matrix( NA, nrow( trees ), ncol( scols ) ) 
    colnames( matr ) <- colnames( scols )
    
    colnames( matr ) <- as.numeric( ccol )
    if( length( smal ) > 0 )repr[ smal[, 1], ] <- 0
    if( length( sfem ) > 0 )repr[ sfem[, 1], ] <- 1
    
    matr[ snot] <- 0
    matr[ srep] <- 1
    
    snew[, colnames( matr )] <- matr
  }
  
  
  yrCols <- yrCols[ yrCols != 'sex']
  fcols  <- grep( 'crop', yrCols )
  
  yrDat  <- as.data.frame( matrix( NA, length( years )*nrow( trees ), 
                                   length( yrCols ) ), 
                           stringsAsFactors = F )
  id     <- sort( unique( as.character( trees$ID ) ) )
  
  tindex <- rep( id, each = length( years ) )
  yindex <- rep( years, length( id ) )
  
  index <- columnPaste( tindex, yindex, '-' )
  
 # index <- apply( cbind( tindex, yindex ), 1, paste0, collapse = '-' )
  rownames( yrDat ) <- index
  colnames( yrDat ) <- yrCols
  
  obsDat <- yrDat[ , -fcols ]
  
  
  elev <- NA
  if( 'elev' %in% colnames( trees ) )elev <- trees[, 'elev']
  
  xytree <- trees[, c( 'UTMx', 'UTMy' )]
  colnames( xytree ) <- c( 'x', 'y' )
  id     <- apply( cbind( newplot, as.character( trees$ID ) ), 1, paste0, 
                   collapse = '-' )
  xytree <- data.frame( treeID = id, plot = newplot, tree = trees$ID, xytree )
  xytree$elev <- elev
  
  
  for( k in 1:length( yrCols ) ){                      # yrCol2017
    
    tk <- as.matrix( trees[, grep( yrCols[ k], colnames( trees ) ), drop = FALSE] )
    rownames( tk ) <- trees$tree
    if( ncol( tk ) == 0 ){
      yrDat[, k] <- NA
      next
    }
    
    if( yrCols[ k] == 'cropFraction' & length( grep( 'Sd', colnames( tk ) ) ) > 0 ){
      sdcol <- grep( 'Sd', colnames( tk ) )
      tk    <- tk[, -sdcol, drop = FALSE]
    }
    
    dmat <- matrix( NA, nrow( tk ), length( years ) )
    rownames( dmat ) <- rownames( tk )
    colnames( dmat ) <- years
    
    kk <- matrix( unlist( strsplit( colnames( tk ), yrCols[ k] ) ),
                  ncol = 2, byrow = TRUE )[, 2]
    
    yk <- as.numeric( kk )
    if( min( yk ) < min( years ) | max( yk ) > max( years ) )
      stop( '\nyears do not span diam years\n' )
    yseq <- min( yk ):max( yk )
    
    
    syr  <- trees[, 'censinyr']                             # left censored
    imat <- matrix( years, nrow( trees ), length( years ), byrow = TRUE ) 
    wmin <- which( is.finite( tk ), arr.ind = TRUE )                 # measurements exist
    
    tmp <- tapply( yk[ wmin[, 2]], list( tree = wmin[, 1], yr = wmin[, 1]*0+1 ), FUN = min )
    t2  <- matrix( NA, nrow( trees ), ncol( tmp ) )
    t2[ as.numeric( rownames( tmp ) ), ] <- tmp
    tmp <- t2
    
    syr  <- pmin( syr, tmp, na.rm = TRUE )
    
    syr  <- matrix( syr, nrow( trees ), length( years ) )           # start
    eyr  <- suppressWarnings( apply( trees[, c( 'deathyr', 'censoryr' )], 
                                     1, min, na.rm = TRUE ) )
    eyr  <- matrix( eyr, nrow( trees ), length( years ) )               # end
    eyr[ eyr == Inf] <- max( years ) 
    imat[ imat < syr | imat > eyr] <- NA
    tmat <- matrix( trees[, 'ID'], nrow( tk ), length( years ) )
    
    icol <- match( yk, years )
    irow <- rep( 1:nrow( tk ), each = length( icol ) )
    icol <- rep( icol, nrow( tk ) )
    jcol <- rep( 1:length( yk ), nrow( tk ) )
    dmat[ cbind( irow, icol )] <- tk[ cbind( irow, jcol )]   # interpolate here
    omat <- dmat                                             # observed values
    
    start <- match( suppressWarnings( apply( imat, 1, min, na.rm = TRUE ) ), years )
    end   <- match( suppressWarnings( apply( imat, 1, max, na.rm = TRUE ) ), years )
    
    wf <- which( is.finite( start ) & is.finite( end ) & end > start )
    
    if( !k %in% fcols ){
      
      if( length( wf ) > 0 ){
        minVal <- 0
        maxVal <- 400
        rr     <- 1
        tinySlope <- .0001
        if( yrCols[ k] == 'shade' ){
          minVal <- suppressWarnings( apply( dmat[ drop = FALSE, wf, ], 1, min, na.rm = T ) )
          maxVal <- suppressWarnings( apply( dmat[ drop = FALSE, wf, ], 1, max, na.rm = T ) )
          minVal[ minVal < 1 | !is.finite( minVal )] <- 1
          maxVal[ maxVal > 5 | !is.finite( maxVal )] <- 5
          rr     <- 0
          tinySlope <- NULL
        } 
        
        tmp <- .interpRows( dmat[ drop = FALSE, wf, ], 
                            startIndex = start[ wf], endIndex = end[ wf], 
                            INCREASING = T, minVal = minVal, maxVal = maxVal, 
                            defaultValue = NULL, tinySlope = tinySlope )
        dmat[ wf, ] <- round( tmp, rr )
      }
      
      if( yrCols[ k] == 'shade' ){
        maxVal <- suppressWarnings( apply( dmat[ drop = FALSE, wf, ], 1, max, na.rm = TRUE ) )
        wmm    <- which( is.finite( maxVal ) )
        mmat   <- matrix( maxVal[ wmm], length( wmm ), ncol( tmp ) )
        ww     <- which( tmp[ wmm, ] > mmat )
        tmp[ wmm, ][ ww] <- mmat[ ww]
        dmat[ wf, ] <- round( tmp )
      }
    }
    
    dvec <- dmat[ is.finite( imat ), drop = F]
    ovec <- omat[ is.finite( imat ), drop = F]
    
    it   <- tmat[ is.finite( imat )]
    iy   <- imat[ is.finite( imat )]
    inn  <- apply( cbind( it, iy ), 1, paste0, collapse = '-' )
    mm   <- match( inn, index )
    yrDat[ mm, k] <- dvec
    if( yrCols[k] %in% colnames( obsDat) )obsDat[ mm, yrCols[k] ] <- ovec
  }
  
  colnames( obsDat ) <- paste( colnames( obsDat ), 'obs', sep = '_' )
  yrDat <- cbind( yrDat, obsDat )
  
  mm <- match( tindex, trees[, 'tree'] )
  
  spec <- trees[ mm, 'species']
  repr <- rep( NA, nrow( yrDat ) )
  repr[ match( inn, index )] <- snew[ is.finite( imat )]
  if( 'cropCount' %in% colnames( yrDat ) ){
    repr[ yrDat$cropCount > 0] <- 1
  }
  
  treeID <- columnPaste( newplot, tindex )
  yrDat <- data.frame( plot = newplot, treeID = treeID, tree = tindex, species = spec, 
                       year = yindex, 
                       repr = repr, yrDat, stringsAsFactors = F )
  if( length( keepCols ) > 0 )
    yrDat <- cbind( yrDat, trees[, keepCols] )
  
  if( 'taxonID' %in% colnames( trees ) )yrDat$taxonID <- trees[ mm, 'taxonID']
  if( !'survey' %in% colnames( trees ) )trees$survey <- 'DUKE'
  if( 'survey' %in% colnames( trees ) ){
    yrDat$survey <- trees[ mm, 'survey']
    yrDat$x <- trees[ mm, 'x']
    yrDat$y <- trees[ mm, 'y']
    yrDat$UTMx <- trees[ mm, 'UTMx']
    yrDat$UTMy <- trees[ mm, 'UTMy']
  }
  if( 'serotinous' %in% colnames( trees ) )yrDat$serotinous[ mm] <- trees$serotinous[ mm]
  
  if( MUSTHAVE )yrDat <- yrDat[ is.finite( yrDat$diam ) & yrDat$diam > 1, ]
  xytree <- xytree[ xytree$treeID %in% yrDat$treeID, ]
  
  rownames( yrDat ) <- NULL
  
  # yrDat <- yrDat[ drop = FALSE, is.finite( yrDat$diam ), ]
  xytree <- xytree[ xytree$treeID %in% yrDat$treeID, ]
  
  rownames( yrDat ) <- columnPaste( yrDat$treeID, yrDat$year, '_' )
  
  yrDat$firstYr <- trees$firstYr[ mm]
  yrDat$lastYr  <- trees$lastYr[ mm]
  
  yrDat <- yrDat[ yrDat$year >= yrDat$firstYr & yrDat$year <= yrDat$lastYr, ]
  
  colnames( yrDat )[ colnames( yrDat ) == 'canopy'] <- 'shade'
  
  wc <- which( duplicated( colnames( yrDat) ) )
  
  if( length(wc) > 0 ){
    
    for( k in 1:length(wc) ){
      cc <- which( colnames(yrDat) == colnames(yrDat)[wc[k]] )
      cnew <- as.matrix( yrDat[, cc] )
      cnew <- apply( cnew, 1, mean, na.rm = T )
      cnew[ !is.finite(cnew) ] <- NA
      yrDat[,cc[1]] <- cnew
    }
    yrDat <- yrDat[,-wc]
  }
  yrDat <- yrDat[ order( yrDat$treeID, yrDat$year ), ]
  
  list( yrDat = yrDat, xytree = xytree[, c( 'plot', 'tree', 'treeID', 'x', 'y', 'elev' )] )
}


growthFromTreeByYear <- function( mat ){
  
  yvec <- c(1:ncol(mat))
  
  vec <- matrix( NA, nrow(mat), 2 )
  colnames( vec ) <- c('growthMu', 'growthSe')
  rownames( vec ) <- rownames( mat )
  
  for( i in 1:nrow(mat) ){
    
    xi <- mat[i,]
    wi <- which( is.finite(xi) )
    yi <- yvec[wi]
    xi <- xi[wi]
    rr <- diff(xi)/diff(yi)
    mu <- round( mean( rr , na.rm = T ), 5 )
    ss <- round( sd( rr, na.rm = T)/sqrt( length(xi) ), 5 )
    vec[i,] <- c( mu, ss )
  }
  vec
}

byYear <- function( tdata, xname = 'fecEstMu', 
                    by = 'species', perBA = T, perHa = F ){
  
  require( allodb )
  require( splancs )
  
  # by can be 'plot' or 'species' or 'tree'
  # perBA divides fecundity by treeBA
  
  if( xname %in% c('biomass', 'diam', 'shade') )perBA <- F
  
  ty <- columnSplit( rownames(tdata), '_' )
  treeID <- ty[,1]
  year   <- as.numeric( ty[,2] )
  tdata$plot <- columnSplit( ty[,1], '-' )[,1]
  if( by[1] == 'tree' )tdata$tree <- ty[,1]
  
  ii <- tdata[, by[1]]
  ii <- list( ii, year )
  names(ii) <- c( by[1], 'year' )
  
  if( xname %in% c( 'fecEstMu', 'fecPredMu' ) ){
    
    sname <- .replaceString( xname, 'Mu', 'Se' )
    
    mu <- tdata[, xname]
    ss <- tdata[, sname]
    mu[ !is.finite(mu) ] <- NA
    ss[ !is.finite(ss) ] <- NA
    if( perBA ){
      baM2 <- pi*(tdata$diam/2)^2/10000   # per m2
      mu <- mu/baM2
      ss <- ss/baM2
    }
    
    wt <- 1/ss
    wt[ !is.finite( wt ) ] <- NA
    xx <- mu*wt
    xx[ !is.finite(xx) ] <- NA
    
    x  <- tapply( xx, ii, sum, na.rm = T )
    wt <- tapply( wt, ii, sum, na.rm = T) 
    x  <- x/wt
    x[ !is.finite( x ) ] <- NA
    
    x <- signif( x, 4 )
    
    return( signif( x, 4 ) )
  }
  
  if( xname == 'biomass' ){
    
    path2Traits = "../traitsByGroup/"
    
    genus <- getTraits( tdata$species, 'genus', path2Traits = path2Traits )
    spec  <- getTraits( tdata$species, 'specEpith', path2Traits = path2Traits )
    
    tdata$biomass <- round( get_biomass( dbh = tdata$diam, genus = genus, species = spec,
                                  coords = c( tdata$lon[1], tdata$lat[1] ) ), 2 )
  }
  
  if( perHa ){
    
    area <- read.csv( 'areaPlotByYr.csv', row.names = 1 )
    colnames( area ) <- .replaceString( colnames(area), 'X', '' )
    rownames( area ) <- .fixNames( rownames(area), all = T )$fixed
    rr <- match( tdata$plot, rownames(area) )
    cc <- match( year, as.numeric( colnames(area) ) )
    aa <- area[ cbind(rr, cc) ]
    tdata[, xname] <- tdata[, xname]/aa
  }
    
  x <- tapply( tdata[, xname ], ii, mean, na.rm = T )
  
  if( by[1] %in% c('species','plot') ){
    vr  <- tapply( tdata[, xname ], ii, var, na.rm = T )
    nn  <- tapply( tdata[, xname ]*0 + 1, ii, sum, na.rm = T )
    se  <- sqrt( vr/nn )
    
    rownames( x ) <- paste( rownames(x), 'estimate' )
    rownames( se ) <- paste( rownames(se), 'SE' )
    
    x <- signif( rbind( x, se ), 4 )
    x <- x[ order( rownames(x) ), ]
  }
  
  x[ !is.finite(x) ] <- NA
  
  signif(x, 4 )
}

byTree <- function( tdata, fecWt = 'cv' ){
  
  # fecWt can be 'sd' or 'cv'
  # xname is 'fecEst', 'fecPred','diam', 'growth', or 'fecPerBA'
  
  ty <- columnSplit( rownames(tdata), '_' )
  treeID <- ty[,1]
  year   <- as.numeric( ty[,2] )
  
  diam  <- tapply( tdata$diam, treeID, mean, na.rm = T )
  baM2  <- pi*(diam/2)^2/10000                             # m2
  shade <- round( tapply( tdata$shade, treeID, mean, na.rm = T ), 1 )
  
  mu <- vec2Mat( tdata$fecEstMu, treeID, year )
  wt <- vec2Mat( 1/tdata$fecEstSe, treeID, year )
  mu[ !is.finite( mu ) ] <- NA
  wt[ !is.finite( wt ) ] <- NA
  
  if( fecWt == 'cv' )wt <- wt*mu
  fecEst <- round( rowSums( mu*wt, na.rm = T )/rowSums( wt, na.rm = T )[ names(diam) ], 2 )
  
  mu <- vec2Mat( tdata$fecPredMu, treeID, year )
  wt <- vec2Mat( 1/tdata$fecPredSe, treeID, year )
  if( fecWt == 'cv' )wt <- wt*mu
  fecPred <- round( rowSums( mu*wt, na.rm = T )/rowSums( wt, na.rm = T )[ names(diam) ], 2 )
  
  gM2est  <- round(fecEst/baM2, 2)  # g/m2 BA
  gM2pred <- round(fecPred/baM2, 2)
  
  dmat <- vec2Mat( tdata$diam, treeID, year )
  growth <- growthFromTreeByYear( dmat )[ names(diam),]
  
  fecEst[ !is.finite( fecEst ) ] <- NA
  fecPred[ !is.finite( fecPred ) ] <- NA
  gM2est[ !is.finite( gM2est ) ] <- NA
  gM2pred[ !is.finite( gM2pred ) ] <- NA
  
  data.frame( species = tdata[ match( names(diam), treeID), 'species'],
              diam = round( diam, 1 ), baM2 = round( baM2, 4), growth, 
              shade, fecEst , fecPred, gM2est, gM2pred )
}


vec2Mat <- function( x, i, j){
  
  I <- sort(unique(i))
  J <- sort(unique(j))
  mat <- matrix( NA, length(I), length(J) )
  colnames(mat) <- J
  rownames(mat) <- I
  mm <- cbind( match(i, I), match(j, J) )
  mat[ mm ] <- x
  mat
}


mat2Vec <- function( mat ){  # reverse: matrix back to vector
  
  if(is.null(colnames(mat)))colnames(mat) <- c(1:ncol(mat))
  if(is.null(rownames(mat)))rownames(mat) <- c(1:nrow(mat))
  
  i <- rownames(mat)
  j <- colnames(mat)
  
  ii <- rep( i, length(j) )
  jj <- rep( j, each = length(i) )
  id <- paste(ii, jj, sep = '_')
  
  vec <- mat[ cbind(ii, jj) ]
  names(vec) <- id
  w <- which(is.finite(vec))
  df <- data.frame( i = ii, j = jj, x = vec)
  df[w,]
}

 
dataFiles <- function( x = "trees", full.names = F,
                       dataPath = "../allocationmodel/datafiles/" ){
  
  # file names/paths for duke data
  # x - 'seeds' or 'trees'
  
  dataFiles <- paste( dataPath, x, 'Active', sep = '' )
  xfiles    <- list.files( dataFiles, full.names = full.names )
  files     <- xfiles[ grep( 'active.csv', xfiles ) ]
  
  plotData   <- read.csv( 'mastPlotsAll.csv', stringsAsFactors=F )
  sname      <- columnSplit( files,'_active.csv' )[,1]
  if( full.names ){
    sname <- .replaceString( sname, dataFiles, '' )
    sname <- .replaceString( sname, '/', '' )
  }
  
  dontOmit <- c("BART_C15G1", "BART_C15G2", "BART_C15G3", "BART_C15G4",
                "BART_C38G1", "BART_C38G2", "DSNY_NEON", "HARV_NEON",  "MLBS_NEON",
                "NIWO_NEON",  "OSBS_NEON", "SERC_NEON", "SJER_NEON", "SOAP_NEON", "TALL_NEON",  
                "TREE_NEON",  "UKFS_NEON",  "UNDE_NEON",  "WREF_NEON", "YELL_NEON")
  
  ww <- which( !sname %in% c( dontOmit, plotData$plot) )
  if( length( ww ) > 0 )
    warning( paste( 'missing from mastPlotsAll.csv:', paste0( sname[ww],
                                      collapse = ', ') ) )
                              
  if( x == 'trees' )return( list(files = files, plots = sname) )
  
  locFiles <- xfiles[ grep( 'UTM.csv', xfiles ) ]
#  trapFile <- paste( dataPath, 'seedTrapArea.txt', sep='' )
#  trapArea <- read.table( trapFile, header=T, stringsAsFactors = F )
#  ww <- which( !sname %in% trapArea$plot )
#  if( length( ww ) > 0 ){
#    warning( paste( 'enter trap area for', sname[ww], 'in file', trapFile ) )
#  }
  
  # missing location files
  uf <- columnSplit( locFiles, '_UTM.csv')
  sf <- columnSplit( files, '_active.csv')
  
  wn <- which( !uf %in% sf )
  if( length(wn) > 0 ){
    missU <- uf[wn]
    print( paste( 'removed UTM file missing seed file:', missU ) )
  #  files <- files[ -wn ]
    uf <- uf[ -wn ]
    locFiles <- locFiles[ -wn ]
  }
  mm <- match( sf, uf )
  wn <- which( is.na( mm ) )
  if( length(wn) > 0 ){
    missU <- uf[wn]
    print( paste( 'removed plots missing UTM file:', missU ) )
    files <- files[ -wn ]
    sf <- sf[ -wn ]
  }
  uf <- columnSplit( locFiles, '_UTM.csv')
  mm <- match( sf, uf )
  
  sname      <- columnSplit( files,'_active.csv' )[,1]
  if( full.names ){
    sname <- .replaceString( sname, dataFiles, '' )
    sname <- .replaceString( sname, '/', '' )
  }
  
  list( files = files, locFiles = locFiles[mm], # trapArea = trapArea, 
        plots = sname )
}

seedColumns <- function( seedData, 
                         cols2remove =  c( 'trapID', 'basket', 'scales', 'IMMA', 'X', 'Y',
                                           'x', 'y', 'trapName', 'fallyr', 'fallYr',
                                           'UNKNUNKN' ),
                         cols2combine = c( 'caps', 'cap' ),
                         cols2transform = list( 'fagusGrandifo_fruit' = 3,
                                                'castaneaDentata' = 3) ){
  
  colnames( seedData )[colnames( seedData ) == 'Plot'] <- 'plot'
  colnames( seedData )[colnames( seedData ) == 'Trap'] <- 'trap'
  seedData$plot <- .replaceString( seedData$plot, ' ', '' )
  seedData <- seedData[, !startsWith(colnames( seedData ), 'UNKN' ) ]
  seedData <- seedData[, !startsWith(colnames( seedData ), 'X.' ) ]
  
  colnames(seedData) <- nameFix( colnames(seedData) )
  
  if( !is.null(cols2remove) ){
    
    cols2go <- numeric( 0 )
    for( k in 1:length( cols2remove ) ){
      wm <- which( endsWith( colnames(seedData), cols2remove[k] ) )
      if( length( wm ) == 0 )next
      cols2go <- c( cols2go, wm )
    }
    
    if( length(cols2go) > 0 )seedData <- seedData[ , -cols2go ]
  }
  
  if( !is.null(cols2combine) ){
    
    cols2go <- numeric(0)
    
    for( k in 1:length( cols2combine ) ){
      
      wc <- which( endsWith( colnames(seedData), paste('_', cols2combine[k], sep = '') ) )
      
      if( length(wc) == 0 )next
      
      xcols <- columnSplit( colnames(seedData)[wc], '_' )
      mm  <- match( xcols[,1], colnames(seedData) )
      wna <- which( is.na( mm ) )
      
      if( length(wna) > 0 ){
        
        if( length(mm) > 1 ){
          
          newCols <- xcols[ !xcols[,1] %in% colnames( seedData) ,1 ]
          x2 <- matrix( 0, nrow(seedData), length(newCols) )
          colnames( x2 ) <- newCols
          seedData <- cbind( seedData, x2 )
          mm  <- match( xcols[,1], colnames(seedData) )
          
        }else{
          colnames( seedData )[wc[wna]] <- 
            columnSplit( colnames(seedData)[wc[wna]] , '_' )[,1]
          next
        }
      }
      
      x1 <- seedData[,wc]
      x2 <- seedData[,mm]
      
      x1[ is.na(x1) ] <- 0
      x2[ is.na(x2) ] <- 0
      xnew <- x1 + x2
      
      wna <- which( is.na( seedData[, wc] ) & is.na( seedData[, mm] ), arr.ind = T )
      
      xnew[ wna ] <- NA
      
      seedData[, wc ] <- xnew
      cols2go <- c( cols2go, wc )
    }
    if (length(cols2go) > 0)seedData <- seedData[,-cols2go]
  }
  
  if (!is.null(cols2transform)) {
    
    cols2go <- numeric(0)
    
    for (k in 1:length(cols2transform)) {
      
      wc <- which( colnames(seedData) == names( cols2transform )[k] )
      if( length(wc) == 0 )next
      
      xcols <- columnSplit( colnames(seedData)[wc], '_' )
      mm <- match( xcols[,1], colnames(seedData) )
      
      seedData[ , mm] <- seedData[,mm]*cols2transform[[k]]
      
      xnew <- apply( seedData[, c(wc, mm) ], 1, sum, na.rm = T )
      xnew[ is.na( seedData[,wc] ) & is.na( seedData[,mm] ) ] <- NA
      
      seedData[,wc] <- xnew
      cols2go <- c( cols2go, wc )
    }
    if (length(cols2go) > 0)seedData <- seedData[,-cols2go]
  }
  seedData
}

getPlotData <- function( plots, a = 'region', compare = 'site', 
                         path = '', dash.removed = F ){
  
  # compare can be 'plot' or 'site'
  # plots is a character vector of plot names 
  
  if( dash.removed & compare == 'site' )stop( 'cannot compare sites with dash.removed' )
  
  plotData <- read.csv( paste( path, 'mastPlotsAll.csv', sep = ''), stringsAsFactors=F )
  plot <- plotData$plot
  if( dash.removed )     plot <- .replaceString( plot, '_', '' )
  if( compare == 'site' ){
    plot  <- columnSplit( plot, '_' )[,1]
    plots <- columnSplit( plots, '_' )[,1]
  }
  plotData$region[ match( plots, plot ) ]
}

wrap.it <- function(x, len)
{ 
  sapply(x, function(y) paste(strwrap(y, len), 
                              collapse = "\n"), 
         USE.NAMES = FALSE)
}


wrap.labels <- function(x, len) # Call with a list or vector
{
  if (is.list(x))
  {
    lapply(x, wrap.it, len)
  } else {
    wrap.it(x, len)
  }
}


getEcoRegs <- function( xeco = c( -130, -60 ), yeco = c( 15, 55 ), 
                        epath = "/Volumes/research/clark/clark.unix/ecoRegionFiles/WWFecoRegions" ){
  
  require( maptools )
  require( ggmap )
  require( rgeos )
  require( sp )
  require( rgdal )
  
  pnow <- getwd( )
  setwd( epath )
  
  wwf         <- readOGR( ".", "wwf_terr_ecos" )
  wwf@data$id <- rownames( wwf@data )
  wwfPoints   <- fortify( wwf, region = "id" )
  wwfDF       <- merge( wwfPoints, wwf@data, by = "id" )
  wwfDF$group <- as.numeric( as.character( wwfDF$group ) )
  
  ww <- which( wwfDF$long > ( xeco[ 1] - 10 ) & 
                 wwfDF$long < ( xeco[ 2] + 10 ) & 
                 wwfDF$lat > ( yeco[ 1] - 10 ) & 
                 wwfDF$lat < ( yeco[ 2] + 10 ) )
  gg <- unique( wwfDF$group[ ww] )
  
  wwfDF <- wwfDF[ wwfDF$group %in% gg, ]
  
  eg <- wwfDF$group
  ea <- unique( eg )
  mm <- match( eg, ea )
  
  wwfDF$group <- mm
  
  setwd( pnow )
  
  data.frame( wwfDF, stringsAsFactors = F )
}




ecoColors <- function( enames ){
  
  etable <- unique( enames )
  
  greens <- rev( c( '#99d8c9', '#66c2a4', '#41ae76', '#238b45', '#006d2c', '#00441b' ) )
  browns <- c( '#bf812d', '#dfc27d'  )
  tans   <- c( '#fdcc8a', '#fc8d59' )
  blues  <- c( '#a6bddb', '#74a9cf', '#3690c0', '#0570b0' )
  whites <- c( '#f5f5f5', '#c7eae5' )
  
  eg <- c( grep( 'forest', etable ), grep( 'mangrove', etable ), grep( 'Everglades', etable ),
    #       grep( 'coastal forest mosaic', etable),
           grep( 'wetland', etable ), grep( 'varzea', etable ), grep( 'restingas', etable ), 
           grep( 'Centla', etable ), grep( 'Pantanal', etable ), grep( 'Islands', etable ) )
  
  eb <- c( grep( 'grassland', etable ), grep( 'steppe', etable ), grep( 'complex', etable ), 
           grep( 'woodland', etable ),
           grep( 'Caatinga', etable ), grep( 'Dry', etable ), grep( 'Dry', etable ), 
           grep( 'espinal', etable ), grep( 'campinarana', etable ), grep( 'Chaco', etable ), 
           grep( 'savanna', etable ), grep( 'Everglades', etable ), grep( 'prairie', etable ) )
  
  et <- c( grep( 'desert', etable ), grep( 'Mediterranean', etable, ignore.case = T ), 
           grep( 'shrub', etable ), grep( 'Pampas', etable ), grep( 'Llano', etable ), 
           grep( 'bush', etable ), 
           grep( 'mezquital', etable ), grep( 'matorral', etable ), grep( 'scrub', etable ), 
           grep( 'Tuxtlas', etable ), grep( 'barrens', etable ), grep( 'chaparral', etable ), 
           grep( 'halophytics', etable ), grep( 'sclerop', etable ), grep( 'Cerrado', etable ), 
           grep( 'Monte', etable ), 
       #    grep( 'mosaic', etable ), 
           grep( 'Rock', etable, ignore.case = T ) )
  
  el <- c( grep( 'Mountain', etable, ignore.case = F ), grep( 'montane', etable ), 
           grep( 'Yungas', etable, ignore.case = F ), grep( 'puna', etable ), 
           grep( 'Pantepui', etable ), grep( 'Highveld', etable ), 
           grep( 'alpine', etable ), grep( 'Alps', etable ), grep( 'Pyrenees', etable ), 
           grep( 'taiga', etable ), grep( 'tundra', etable ), grep( 'paramo', etable ), 
           grep( 'Cascade', etable ), grep( 'Rockies forests', etable ), 
           grep( 'Sierra Nevada', etable ), grep( 'Appalachian', etable ) ) 
  
  ew <- c( grep( 'Ice', etable ) )
  
  eg <- eg[ !eg %in% c( eb, et, el, ew )]
  eb <- eb[ !eb %in% c( et, el, ew )]
  et <- et[ !et %in% c( el, ew )]
  el <- el[ !el %in% ew ]
  
  ecolors <- rep( 'lightgreen', length( enames ) )
  
  forest <- colorRampPalette( greens )( length( eg ) )
  names( forest ) <- etable[ eg]
  mm <- match( enames, etable[ eg] )
  wf <- which( is.finite( mm ) )
  ecolors[ wf] <- forest[ mm[ wf]]
  
  grass <- colorRampPalette( browns )( length( eb ) )
  names( grass ) <- etable[ eb]
  mm <- match( enames, etable[ eb] )
  wf <- which( is.finite( mm ) )
  ecolors[ wf] <- grass[ mm[ wf]]
  
  desert <- colorRampPalette( tans )( length( et ) )
  names( desert ) <- etable[ et]
  mm <- match( enames, etable[ et] )
  wf <- which( is.finite( mm ) )
  ecolors[ wf] <- desert[ mm[ wf]]
  
  montane <- colorRampPalette( blues )( length( el ) )
  names( montane ) <- etable[ el]
  mm <- match( enames, etable[ el] )
  wf <- which( is.finite( mm ) )
  ecolors[ wf] <- montane[ mm[ wf]]
  
  ice <- colorRampPalette( whites )( length( ew ) )
  names( ice ) <- etable[ ew]
  mm <- match( enames, etable[ ew] )
  wf <- which( is.finite( mm ) )
  ecolors[ wf] <- ice[ mm[ wf]]
  
  legend <- list( forest = forest, grass = grass, desert = desert, montane = montane, 
                  ice = ice )
  
  
  ww  <- which( sapply( legend, length ) > 0 )
  legend <- legend[ww]
  
  names( ecolors ) <- enames
  
  list( ecols = ecolors, legend = legend )
}

```

The next six code blocks isolate specific climate variables for the MASTIF data. In the original analysis for the paper, I focused on reproductive phase-specific climate variables. Precipitation was calculated as the total rainfall from prior October through contemporaneous April. Temperature was calculated as phase-specific mean temperature (i.e., average temp from March - July). Each of these corresponds to a specific reproductive phase like pollination or fertilization, as named in the final output from these code chunks. After I select climate for each genus, I run the MASTIF code. 
``` {r Abies Climate}
library(sf)
library(raster)
library(terra)
library(sp)


dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)

genus<-"abies"
tmp<-extractGenus(inputs, genus = genus, taxa, plotData)




treeData<-tmp$inputs$treeData # get individual tree data
xytree<-tmp$inputs$xytree # isolate tree location data
seedData<-tmp$inputs$seedData
xytrap<-tmp$inputs$xytrap
seedTraits<-as.data.frame(tmp$inputs$seedTraits)%>%
  mutate(species=rownames(.))




# first, let's prep the tree data
xytree2<-xytree
trees<-merge(treeData,xytree2)
tree_sf<-st_as_sf(trees,coords=c("x","y"),
                  crs = "+proj=utm +zone=11")
tree_transform<- st_transform(tree_sf, crs = "+proj=longlat +datum=WGS84")
tree_crs<-crs(tree_transform) # define the CRS


# start with Abies bud initiation
# first is t-1 years
mon<-5:10
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_budInit=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

# now let's do April of current year
mon<-4
years<-unique(trees$year)
vars<-"tmean"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_budInit=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}

budTemp<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(temp_budInit=mean(tmean_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,temp_budInit)%>%
  distinct()



# now let's do temp at pollination
mon<-5
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Poll=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

pollenTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(tmean_Poll=mean(tmean_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,tmean_Poll)%>%
  distinct()

# now let's do temp at fertilization
mon<-6:8
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Fert=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

fertTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(tmean_Fert=mean(tmean_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,tmean_Fert)%>%
  distinct()



# now let's do precip at Bud Initiation
# here we are only concerned with water year
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}


# now let's get spring precip
mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


budPrecip<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  mutate(Year=ifelse(Month%in%c(10:12),as.numeric(Year)+1,as.numeric(Year)))%>%
  group_by(species,tree,plot,Year)%>%
  mutate(precip_budInit=sum(ppt_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,precip_budInit)%>%
  distinct()

# given the timing, we have to do pollination and fertilization precip together because the timing is all the same (i.e., current year)
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_PollFert=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}


# now let's get spring precip
mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_PollFert=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


PollFertPrecip<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  mutate(Year=ifelse(Month%in%c(10:12),as.numeric(Year)+1,as.numeric(Year)))%>%
  group_by(species,tree,plot,Year)%>%
  mutate(precip_PollFert=sum(ppt_PollFert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,precip_PollFert)%>%
  distinct()




abiesClim<-full_join(budPrecip,budTemp)%>%
  full_join(.,pollenTemp)%>%
  full_join(.,fertTemp)%>%
  full_join(.,PollFertPrecip)



# OK let's try to do the normals calculations

# OK, now let's load in some PRISM 30year mean data
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
mon<-c(1:3,10:12)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("ppt", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_sf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Precip=31)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_p<-EXT_df%>%
    dplyr::select(tree,Precip)%>%
    distinct()%>%
    group_by(tree)%>%
    mutate(Norm_p=sum(Precip))%>%
    dplyr::select(-Precip)%>%
    distinct()
    
  
  
  

temp<-data.frame(NULL)
library(prism)
mon<-c(5:8)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("tmean", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_sf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Temp=31)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_t<-EXT_df%>%
    dplyr::select(tree,Temp)%>%
    rename(Norm_t=Temp)%>%
    group_by(tree)%>%
    mutate(Norm_t=mean(Norm_t))%>%
    distinct()

normals<-full_join(normal_t,normal_p)


abiesClim2<-full_join(abiesClim,normals)%>%
  mutate(precip_budInit=precip_budInit-Norm_p,temp_budInit=temp_budInit-Norm_t,tmean_Poll=tmean_Poll-Norm_t,tmean_Fert=tmean_Fert-Norm_t,precip_PollFert=precip_PollFert-Norm_p)
  
```

``` {r Abies MASTIF run}

dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)
genus<-"abies"
tmp<-extractGenus(inputs, genus = genus, taxa, plotData)
treeData<-tmp$inputs$treeData%>% # get individual tree data
  dplyr::select(plot,tree,year,species,cropCount,cropFraction,ecoRegWWF,diam,shade)%>%
  distinct()
xytree<-tmp$inputs$xytree # isolate tree location data
seedData<-tmp$inputs$seedData
xytrap<-tmp$inputs$xytrap
seedTraits<-as.data.frame(tmp$inputs$seedTraits)%>%
  mutate(species=rownames(.))

firz<-treeData
firxy<-xytree


plots<-tmp$plotData
td2<-treeData%>%
  dplyr::select(plot,tree,year,species)
ap_trees<-full_join(plots,td2)%>%
  mutate(Type=ifelse(survey=="INAT","iNaturalist","Permanent Plot"))%>%
  dplyr::select(fullName,tree,Type,lon,lat,species,year,plot)%>%
  drop_na()

abiesClim2<-abiesClim2%>%
  mutate(precip_budInit=scale(precip_budInit),temp_budInit=scale(temp_budInit),tmean_Poll=scale(tmean_Poll),tmean_Fert=scale(tmean_Fert),precip_PollFert=scale(precip_PollFert))


# make a subset of data just to make things run faster
treeData2<-merge(treeData,abiesClim2)%>%
  #filter(!plot %in% drop$plot)%>%
  #filter(plot!='UCSCFERP',plot!='WREFWFDP')%>%
  distinct()

#td2<-merge(treeData,all_clim)

  
treeData2<-as.data.frame(treeData2)
seedData2<-seedData%>%
  #filter(!plot %in% drop$plot)%>%
  #filter(plot!='UCSCFERP',plot!='WREFWFDP',plot!="SEQJ",plot!="SOAP001",plot!="SOAP002",plot!="SOAP004",plot!="SOAP008",plot!="SOAP011")%>%
  distinct(plot,trap,year,.keep_all = TRUE)%>%
  mutate(abiesAmabilis=round(abiesAmabilis,0),abiesProcera=round(abiesProcera,0))
xytree2<-xytree%>%
 # filter(!plot %in% drop$plot)%>%
  #filter(plot!='UCSCFERP',plot!='WREFWFDP',plot!="SEQJ",plot!="SOAP001",plot!="SOAP002",plot!="SOAP004",plot!="SOAP008",plot!="SOAP011")%>%
  distinct()
xytrap2<-xytrap%>%
  #filter(!plot %in% drop$plot)%>%
  #filter(plot!='UCSCFERP',plot!='WREFWFDP',plot!="SEQJ",plot!="SOAP001",plot!="SOAP002",plot!="SOAP004",plot!="SOAP008",plot!="SOAP011")%>%
  distinct(plot,trap,.keep_all = TRUE)
priors<-tmp$inputs$priorTable
  
 
  
# OK let's try to run MASTIF now
seednames<-seedData2%>%
  pivot_longer(cols=c(6,8,10,12,14,15,17),names_to="seedName",values_to="count")%>%
  distinct(seedName)
seeds<-c(unique(seednames$seedName))

plist<-data.frame(plot=unique(treeData2$plot))
seed_data<-merge(seedData2,plist)


# I think the best model will be contemporaneous temperature and precip
# possibly a 1-year lag too
fecForms<-list(
  f1=as.formula(~diam + I(diam^2) + shade + precip_budInit + diam:precip_budInit + temp_budInit + diam:temp_budInit + tmean_Poll + diam:tmean_Poll + tmean_Fert + diam:tmean_Fert  + precip_PollFert + diam:precip_PollFert)
)

formulaRep <- as.formula( ~ diam)   # maturation model

#yearEffect   <- list( groups = c('species','ecoRegWWF'), p = 2)   # AR( 2 ) 
randomEffect <- list( randGroups = 'tree', 
                     formulaRan = as.formula( ~ 1 ) )
betaPrior  <- list( pos = 'diam', neg = 'I( diam^2 )' )

specNames<-seeds[seeds!='abiesUNKN']
seedNames<-seeds

#specNames<-c('abiesConcolor','abiesMagnific')
#seedNames<-specNames
  
  
#treeData2$cropCount<-as.integer(treeData2$cropCount)
inputs   <- list( specNames = specNames, seedNames = seedNames,
                  treeData = treeData2, seedData = seed_data, 
                  #betaPrior=betaPrior,
                  #priorTable=priors,
                  #yearEffect = yearEffect, 
                  randomEffect=randomEffect,
                  #maxF=1e+8,
                  xytree = xytree2, xytrap = xytrap2)
  
plotPars<-list()
plotPars$SAVEPLOTS=T
  
output <- mastif( inputs = inputs, formulaFec=fecForms, formulaRep, ng = 1000, burnin = 800)
mastPlot(output,plotPars=plotPars)


# let's aggregate the data really quick to assess prediction
abiesAgg<-output[["prediction"]][["seedPred"]]%>%
  group_by(plot)%>%
  mutate(totalObs=mean(countPerTrap),totalPred=mean(predMeanTrap))

abiesAggPred<-ggplot(abiesAgg,aes(log(totalObs),log(totalPred))) +
  geom_point() +
  geom_smooth(method="lm") +
  facet_wrap(~year)

ggsave("abiesAggPrediction.png",abiesAggPred,bg="white",dpi=300)

# OK, prediction is very good here!
betaFec<-(output[["parameters"]][["betaFec"]])
write.csv(betaFec,file="abies_betas.csv")
#mastPlot(output,plotPars)






```

``` {r Pinus Climate}
library(sf)
library(raster)
library(terra)
library(sp)


dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)

genus<-"pinus"
tmp<-extractGenus(inputs, genus = genus, taxa, plotData)




treeData<-tmp$inputs$treeData # get individual tree data
xytree<-tmp$inputs$xytree # isolate tree location data
seedData<-tmp$inputs$seedData
xytrap<-tmp$inputs$xytrap
seedTraits<-as.data.frame(tmp$inputs$seedTraits)%>%
  mutate(species=rownames(.))




# first, let's prep the tree data
xytree2<-xytree
trees<-merge(treeData,xytree2)
tree_sf<-st_as_sf(trees,coords=c("x","y"),
                  crs = "+proj=utm +zone=11")
tree_transform<- st_transform(tree_sf, crs = "+proj=longlat +datum=WGS84")
tree_crs<-crs(tree_transform) # define the CRS


# start with Pinus bud initiation
mon<-8:10
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_budInit=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

budTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(temp_budInit=mean(tmean_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,temp_budInit)%>%
  distinct()



# now let's do temp at pollination
mon<-4:8
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Poll=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

pollenTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(tmean_Poll=mean(tmean_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,tmean_Poll)%>%
  distinct()



# now let's do temp at fertilization
mon<-5:10
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Fert=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

fertTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(tmean_Fert=mean(tmean_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,tmean_Fert)%>%
  distinct()



# now let's do precip at Bud Initiation
# here we are only concerned with water year
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-4),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-4)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}


# now let's get spring precip
mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


budPrecip<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  mutate(Year=ifelse(Month%in%c(10:12),as.numeric(Year)+1,as.numeric(Year)))%>%
  group_by(species,tree,plot,Year)%>%
  mutate(precip_budInit=sum(ppt_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,precip_budInit)%>%
  distinct()


# now let's do precip at Pollination
# here we are only concerned with water year
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Poll=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}


# now let's get spring precip
mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Poll=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


pollPrecip<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  mutate(Year=ifelse(Month%in%c(10:12),as.numeric(Year)+1,as.numeric(Year)))%>%
  group_by(species,tree,plot,Year)%>%
  mutate(ppt_Poll=sum(ppt_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_Poll)%>%
  distinct()


# now let's do precip at Fertilization
# here we are only concerned with water year
require(terra)
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Fert=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}


# now let's get spring precip
mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Fert=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


fertPrecip<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  mutate(Year=ifelse(Month%in%c(10:12),as.numeric(Year)+1,as.numeric(Year)))%>%
  group_by(species,tree,plot,Year)%>%
  mutate(ppt_Fert=sum(ppt_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_Fert)%>%
  distinct()



budPrecip$tree<-as.character(budPrecip$tree)
pollPrecip$tree<-as.character(pollPrecip$tree)
fertPrecip$tree<-as.character(fertPrecip$tree)
budTemp$tree<-as.character(budTemp$tree)
pollenTemp$tree<-as.character(pollenTemp$tree)
fertTemp$tree<-as.character(fertTemp$tree)

pinusClim<-full_join(budPrecip,pollPrecip)%>%
  full_join(.,fertPrecip)%>%
  full_join(.,budTemp)%>%
  full_join(.,pollenTemp)%>%
  full_join(.,fertTemp)




# OK let's try to do the normals calculations

# OK, now let's load in some PRISM 30year mean data
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
mon<-c(1:3,10:12)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("ppt", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_sf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Precip=31)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_p<-EXT_df%>%
    dplyr::select(tree,Precip)%>%
    distinct()%>%
    group_by(tree)%>%
    mutate(Norm_p=sum(Precip))%>%
    dplyr::select(-Precip)%>%
    distinct()
    
  
  
  

temp<-data.frame(NULL)
library(prism)
mon<-c(5:8)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("tmean", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_sf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Temp=31)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_t<-EXT_df%>%
    dplyr::select(tree,Temp)%>%
    rename(Norm_t=Temp)%>%
    group_by(tree)%>%
    mutate(Norm_t=mean(Norm_t))%>%
    distinct()

normals<-full_join(normal_t,normal_p)


pinusClim2<-full_join(pinusClim,normals)%>%
  mutate(precip_budInit=precip_budInit-Norm_p,temp_budInit=temp_budInit-Norm_t,tmean_Poll=tmean_Poll-Norm_t,tmean_Fert=tmean_Fert-Norm_t,ppt_Poll=ppt_Poll-Norm_p,ppt_Fert=ppt_Fert-Norm_p)

```

``` {r Pinus MASTIF run}

dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)
genus<-"pinus"
tmp<-extractGenus(inputs, genus = genus, taxa, plotData)
treeData<-tmp$inputs$treeData # get individual tree data
xytree<-tmp$inputs$xytree # isolate tree location data
seedData<-tmp$inputs$seedData
xytrap<-tmp$inputs$xytrap
seedTraits<-as.data.frame(tmp$inputs$seedTraits)%>%
  mutate(species=rownames(.))
pinez<-treeData
pinexy<-xytree

plots<-tmp$plotData
td2<-treeData%>%
  dplyr::select(plot,tree,year,species)
pp_trees<-full_join(plots,td2)%>%
  mutate(Type=ifelse(survey=="INAT","iNaturalist","Permanent Plot"))%>%
  dplyr::select(fullName,tree,Type,lon,lat,species,year,plot)%>%
  drop_na()



# make a subset of data just to make things run faster
treeData2<-merge(treeData,pinusClim2)%>%
  distinct(plot,tree,year,.keep_all = TRUE)%>%
  #filter(!plot %in% drop)%>%
  #filter(plot!="SEQJ",plot!="SOAP001",plot!="SOAP002",plot!="SOAP004",plot!="SOAP008",plot!="SOAP011")%>%
  distinct()%>%
  mutate(fecMin=0,fecMax=1e+8)

  
treeData2<-as.data.frame(treeData2)
seedData2<-seedData%>%
  merge(.,plist)%>%
  distinct(plot,trap,year,.keep_all = TRUE)%>%
  #filter(!plot %in% drop)%>%
  #filter(plot!="SEQJ",plot!="SOAP001",plot!="SOAP002",plot!="SOAP004",plot!="SOAP008",plot!="SOAP011")%>%
  distinct(plot,trap,year,.keep_all = TRUE)
  #mutate(abiesAmabilis=round(abiesAmabilis,0),abiesProcera=round(abiesProcera,0))
xytree2<-xytree%>%
    merge(.,plist)%>%
  distinct(plot,tree,x,y,.keep_all = TRUE)%>%
  #filter(!plot %in% drop)%>%
  #filter(plot!="SEQJ",plot!="SOAP001",plot!="SOAP002",plot!="SOAP004",plot!="SOAP008",plot!="SOAP011")%>%
  distinct()
xytrap2<-xytrap%>%
    merge(.,plist)%>%
  distinct(plot,trap,x,y,.keep_all = TRUE)%>%
  #filter(!plot %in% drop)%>%
  #filter(plot!="SEQJ",plot!="SOAP001",plot!="SOAP002",plot!="SOAP004",plot!="SOAP008",plot!="SOAP011")%>%
  distinct(plot,trap,.keep_all = TRUE)
 # mutate(keep=ifelse(plot!="SEQUBBBPIPO",1,0),keep2=ifelse(plot=="SEQUBBBPIPO" & trap%in%c("6.3","11.9"),1,keep))
priorTable<-tmp$inputs$priorTable

# OK let's treeData# OK let's try to run MASTIF now
seednames<-seedData2%>%
  pivot_longer(cols=c(6,8:10,12,13),names_to="seedName",values_to="count")%>%
  distinct(seedName)
seeds<-c(unique(treeData2$species),'pinusUNKN')

seed_data<-seedData2



formulaRep <- as.formula( ~ diam)   # maturation model

#yearEffect   <- list( groups = c('species'), p = 0)   # AR( 0 ) 
randomEffect <- list( randGroups = 'tree', 
                     formulaRan = as.formula( ~ 1 ) )
#betaPrior  <- list( pos = 'diam', neg = 'I( diam^2 )' )

specNames<-seeds[seeds!='pinusUNKN']
#specNames<-"pinusPonderos"
seedNames<-seeds
#seedNames<-c("pinusPonderos","pinusUNKN")


#treeData2$cropCount<-as.integer(treeData2$cropCount)
inputs   <- list( specNames = specNames, seedNames = seedNames,
                  treeData = treeData2, seedData = seed_data, 
                  #betaPrior=betaPrior,
                  #priorTable=priorTable,
                  #yearEffect = yearEffect, 
                  randomEffect=randomEffect,
                  maxF=1e+8,
                  xytree = xytree2, xytrap = xytrap2)

plotPars<-list()
plotPars$SAVEPLOTS=T

fecForm<-as.formula(~diam + I(diam^2) + shade + precip_budInit + diam:precip_budInit + ppt_Poll + diam:ppt_Poll + ppt_Fert + diam:ppt_Fert+ temp_budInit + diam:temp_budInit + tmean_Poll + diam:tmean_Poll + tmean_Fert + diam:tmean_Fert)


output <- mastif( inputs = inputs, formulaFec=fecForm, formulaRep, ng = 3000, burnin = 1000)
mastPlot(output,plotPars=plotPars)

betaFec<-(output[["parameters"]][["betaFec"]])
write.csv(betaFec,file="pinus_betas.csv")


```

``` {r Quercus Climate}
library(sf)
library(raster)
library(terra)
library(sp)


dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)

genus<-"quercus"
tmp<-extractGenus(inputs, genus = genus, taxa, plotData)




treeData<-tmp$inputs$treeData # get individual tree data
xytree<-tmp$inputs$xytree # isolate tree location data
seedData<-tmp$inputs$seedData
xytrap<-tmp$inputs$xytrap
seedTraits<-as.data.frame(tmp$inputs$seedTraits)%>%
  mutate(species=rownames(.))




# first, let's prep the tree data
xytree2<-xytree
trees<-merge(treeData,xytree2)
tree_sf<-st_as_sf(trees,coords=c("x","y"),
                  crs = "+proj=utm +zone=11")
tree_transform<- st_transform(tree_sf, crs = "+proj=longlat +datum=WGS84")
tree_crs<-crs(tree_transform) # define the CRS


# start with Quercus bud initiation
mon<-7:9
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_budInit=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

budTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(temp_budInit=mean(tmean_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,temp_budInit)%>%
  distinct()


mon<-4
years<-unique(trees$year)
vars<-"tmean"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_budInit=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


budTemp2<-temp2%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(temp_budInit=mean(tmean_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,temp_budInit)%>%
  distinct()

budTemp<-rbind(budTemp,budTemp2)%>%
  group_by(species,tree,plot,year)%>%
  mutate(temp_budInit=mean(temp_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,temp_budInit)%>%
  distinct()


# now let's do temp at pollination
mon<-5
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Poll=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

pollenTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(tmean_Poll=mean(tmean_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,tmean_Poll)%>%
  distinct()



# now let's do temp at fertilization
mon<-6
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Fert=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

fertTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(temp_Fert=mean(tmean_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,temp_Fert)%>%
  distinct()


mon<-4:6
years<-unique(trees$year)
vars<-"tmean"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Fert=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


fertTemp2<-temp2%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(temp_Fert=mean(tmean_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,temp_Fert)%>%
  distinct()

fertTemp<-rbind(fertTemp,fertTemp2)%>%
  group_by(species,tree,plot,year)%>%
  mutate(temp_Fert=mean(temp_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,temp_Fert)%>%
  distinct()



# now let's do precip
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-4),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-4)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

budPrecip<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(ppt_budInit=sum(ppt_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_budInit)%>%
  distinct()


mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


budPrecip2<-temp2%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(ppt_budInit=sum(ppt_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_budInit)%>%
  distinct()

budPrecip<-rbind(budPrecip,budPrecip2)%>%
  group_by(species,tree,plot,year)%>%
  mutate(ppt_budInit=sum(ppt_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_budInit)%>%
  distinct()


# precip at pollination
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Poll=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

pollPrecip<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(ppt_Poll=sum(ppt_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_Poll)%>%
  distinct()


mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Poll=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


pollPrecip2<-temp2%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(ppt_Poll=sum(ppt_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_Poll)%>%
  distinct()

pollPrecip<-rbind(pollPrecip,pollPrecip2)%>%
  group_by(species,tree,plot,year)%>%
  mutate(ppt_Poll=sum(ppt_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_Poll)%>%
  distinct()


# precip at pollination
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Fert=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

fertPrecip<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(ppt_Fert=sum(ppt_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_Fert)%>%
  distinct()


mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Fert=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


fertPrecip2<-temp2%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(ppt_Fert=sum(ppt_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_Fert)%>%
  distinct()

fertPrecip<-rbind(fertPrecip,fertPrecip2)%>%
  group_by(species,tree,plot,year)%>%
  mutate(ppt_Fert=sum(ppt_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_Fert)%>%
  distinct()




quercusClim<-full_join(budPrecip,pollPrecip)%>%
  full_join(.,fertPrecip)%>%
  full_join(.,budTemp)%>%
  full_join(.,pollenTemp)%>%
  full_join(.,fertTemp)




# OK let's try to do the normals calculations

# OK, now let's load in some PRISM 30year mean data
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
mon<-c(1:3,10:12)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("ppt", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_sf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Precip=31)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_p<-EXT_df%>%
    dplyr::select(tree,Precip)%>%
    distinct()%>%
    group_by(tree)%>%
    mutate(Norm_p=sum(Precip))%>%
    dplyr::select(-Precip)%>%
    distinct()
    
  
  
  

temp<-data.frame(NULL)
library(prism)
mon<-c(5:8)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("tmean", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_sf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Temp=31)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_t<-EXT_df%>%
    dplyr::select(tree,Temp)%>%
    rename(Norm_t=Temp)%>%
    group_by(tree)%>%
    mutate(Norm_t=mean(Norm_t))%>%
    distinct()

normals<-full_join(normal_t,normal_p)


quercusClim2<-full_join(quercusClim,normals)%>%
  mutate(ppt_budInit=ppt_budInit-Norm_p,temp_budInit=temp_budInit-Norm_t,tmean_Poll=tmean_Poll-Norm_t,temp_Fert=temp_Fert-Norm_t,ppt_Poll=ppt_Poll-Norm_p,ppt_Fert=ppt_Fert-Norm_p)

```

``` {r Quercus MASTIF run}


dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)
genus<-"quercus"
tmp<-extractGenus(inputs, genus = genus, taxa, plotData)
treeData<-tmp$inputs$treeData # get individual tree data
xytree<-tmp$inputs$xytree # isolate tree location data
seedData<-tmp$inputs$seedData
xytrap<-tmp$inputs$xytrap
seedTraits<-as.data.frame(tmp$inputs$seedTraits)%>%
  mutate(species=rownames(.))
oakz<-treeData
oakxy<-xytree
# make a subset of data just to make things run faster
treeData2<-merge(treeData,quercusClim2)%>%
  #filter(!plot %in% drop$plot)%>%
  #filter(plot!='UCSCFERP',plot!='WREFWFDP')%>%
  distinct()

plots<-tmp$plotData
td2<-treeData%>%
  dplyr::select(plot,tree,year,species)
op_trees<-full_join(plots,td2)%>%
  mutate(Type=ifelse(survey=="INAT","iNaturalist","Permanent Plot"))%>%
  dplyr::select(fullName,tree,Type,lon,lat,species,year,plot)%>%
  drop_na()
  
treeData2<-as.data.frame(treeData2)
seedData2<-seedData%>%
  distinct(plot,trap,year,.keep_all = TRUE)
  #mutate(abiesAmabilis=round(abiesAmabilis,0),abiesProcera=round(abiesProcera,0))
xytree2<-xytree%>%
  distinct()
xytrap2<-xytrap%>%
  distinct(plot,trap,.keep_all = TRUE)
priors<-tmp$inputs$priorTable
  
 
  
# OK let's try to run MASTIF now
seednames<-seedData2%>%
  pivot_longer(cols=c(6:8,10),names_to="seedName",values_to="count")%>%
  distinct(seedName)
seeds<-c(unique(seednames$seedName))

plist<-data.frame(plot=unique(treeData2$plot))
seed_data<-merge(seedData2,plist)


formulaRep <- as.formula( ~ diam)   # maturation model

#yearEffect   <- list( groups = c('species','ecoRegWWF'), p = 3)   # AR( 4 ) 
randomEffect <- list( randGroups = 'tree', 
                     formulaRan = as.formula( ~ 1 ) )
#betaPrior  <- list( pos = 'diam', neg = 'I( diam^2 )' )

specNames<-c('quercusChrysole','quercusKelloggi','quercusAgrifoli')
seedNames<-seeds


#treeData2$cropCount<-as.integer(treeData2$cropCount)
inputs   <- list( specNames = specNames, seedNames = seedNames,
                  treeData = treeData2, seedData = seed_data, 
                  #betaPrior=betaPrior,
                  #priorTable=priors,
                  #yearEffect = yearEffect, 
                  randomEffect=randomEffect,
                  maxF=1e+8,
                  xytree = xytree2, xytrap = xytrap2)
  
plotPars<-list()
plotPars$SAVEPLOTS=T

fecForm<-as.formula(~diam + I(diam^2) + shade + ppt_budInit + diam:ppt_budInit + ppt_Poll + diam:ppt_Poll + ppt_Fert + diam:ppt_Fert+ temp_budInit + diam:temp_budInit + tmean_Poll + diam:tmean_Poll + temp_Fert + diam:temp_Fert)


output <- mastif( inputs = inputs, formulaFec=fecForm, formulaRep, ng = 3000, burnin = 1000)
mastPlot(output,plotPars=plotPars)

betaFec<-(output[["parameters"]][["betaFec"]])
write.csv(betaFec,file="quercus_betas.csv")



```

This code chunk maps individual observations in the MASTIF dataset and creates a table that I export as a .csv file with information on number of trees per species and the observation type (iNat or permanent plot).
``` {r Tree-years / data map}

specs<-c("abiesConcolor","abiesGrandis","abiesMagnific","pinusLamberti","pinusPonderos","pinusMonticol","pinusJeffreyi","pinusContorta","quercusAgrifoli","quercusKelloggi","quercusChrysole")

ty<-rbind(op_trees,ap_trees,pp_trees)%>%
  filter(species%in%specs)%>%
  mutate(val=1,totalTY=sum(val))%>%
  group_by(species)%>%
  mutate(N=n_distinct(plot),treeYears=sum(val))%>%
  ungroup()%>%
  mutate(plotCount=n_distinct(plot))%>%
  group_by(species,tree)%>%
  mutate(specCount=sum(val))%>%
  drop_na()

ty2<-ty%>%
  group_by(species,Type,plot)%>%
  mutate(TreeYears=sum(val))%>%
  group_by(plot,tree,Type)%>%
  mutate(N=sum(val))%>%
  ungroup()%>%
  dplyr::select(species,Type,N,TreeYears)%>%
  distinct()%>%
  group_by(species,Type)%>%
  mutate(N=sum(N),TreeYears=sum(TreeYears))%>%
  distinct()%>%
  pivot_wider(names_from="Type",values_from=c("N","TreeYears"))

write.csv(ty2,"TableS1.csv")

library(sf)
library(terra)


ty2<-ty%>%
  group_by(species,Type,plot)%>%
  mutate(TreeYears=sum(val))%>%
  group_by(plot,tree,Type)%>%
  mutate(N=sum(val))%>%
  ungroup()%>%
  dplyr::select(fullName,species,Type,N,TreeYears)%>%
  distinct()%>%
  group_by(species,Type)%>%
  mutate(N=sum(N),TreeYears=sum(TreeYears))%>%
  distinct()

plotLoc<-rbind(op_trees,ap_trees,pp_trees)%>%
  drop_na()%>%
  rename(x=lon,y=lat)%>%
  merge(.,ty2)

tysf<-sf::st_as_sf(plotLoc,coords=c("x","y"))


st_crs(tysf)<-"+proj=longlat +datum=WGS84"

tysf2<-terra::vect(tysf)

typroj<-project(tysf2, "+proj=longlat +datum=WGS84")
typroj_11<-project(tysf2_11, "+proj=longlat +datum=WGS84")

tynew<-rbind(typroj_10,typroj_11)

tysfNEW<-sf::st_as_sf(tysf2)%>%
  filter(species%in%specs)



sts<-c("California","Nevada","Arizona","Oregon","Washington","Idaho")

library(tigris) # package for CA maps
library(raster)
west<-states()%>%
  filter(NAME%in%sts)%>%
  dplyr::select(NAME,INTPTLAT,INTPTLON)%>%
  rename(LAT=2,LON=3)
west$LON<-as.numeric(west$LON)
west$LAT<-as.numeric(west$LAT)

library(ggthemes)

# create world map using ggplot() function 
maps<-ggplot() +  geom_sf(data = west,fill="white",color="black") +
  #xlim(-125,-110) +
  #ylim(25,50) +
  geom_sf(data=tysfNEW,aes(color=species,shape=Type,size=TreeYears)) +
  scale_size_continuous(range = c(2,8)) +
  guides(
    color = guide_legend(title = "Species",override.aes=list(size=5)),
    shape = "none",  # Hide the shape legend
    size = "none"    # Hide the size legend
  ) +
  scale_color_tableau(palette="Tableau 20") +
  theme_classic2() +
  #facet_wrap(~species) +
  theme()


ggsave("FigS1.png",maps,bg="white",width=12,height=12)


```

The next six code chunks apply the MASTIF output to the full FIA dataset for California.
``` {r OAK FIA PRISM}
library(sf)
library(raster)
library(terra)
library(sp)

dir<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA"
#CA_FIA <- getFIA(states = 'CA', dir = dir,load=TRUE) # use this code to get most updated FIA data
CA_FIA<-readFIA(dir) # read in data from directory


#CA_recent<-clipFIA(CA_FIA) # this gets most recent data
tpa_polysSF <- tpa(CA_FIA,treeType="live",treeDomain = SPCD==122,byPlot=TRUE,returnSpatial = TRUE) # filter out just PIPO and make it a spatial object, only gives trees per acre
plot(tpa_polysSF) # testplot of trees per acre

plot.list<-data.frame(Plot=CA_FIA$PLOT$PLOT,Unit=CA_FIA$PLOT$UNITCD,County=CA_FIA$PLOT$COUNTYCD,STATE=CA_FIA$PLOT$STATECD,UTMy=CA_FIA$PLOT$LAT,UTMx=CA_FIA$PLOT$LON)%>%
  unite(PLOT,Plot,Unit,County,STATE,sep="_")%>%
  rename(Plot=PLOT)%>%
  distinct()

tree.list <- data.frame(Year=CA_FIA$TREE$INVYR,Plot=CA_FIA$TREE$PLOT,Unit=CA_FIA$TREE$UNITCD,County=CA_FIA$TREE$COUNTYCD,STATE=CA_FIA$TREE$STATECD,Subplot=CA_FIA$TREE$SUBP,Tree=CA_FIA$TREE$TREE,Diameter=CA_FIA$TREE$DIA,SPCD=CA_FIA$TREE$SPCD,SHADE=CA_FIA$TREE$CLIGHTCD,canopy=CA_FIA$TREE$CCLCD)%>%
  unite(PLOT,Plot,Unit,County,STATE,sep="_")%>%
  rename(Plot=PLOT)%>%
  distinct()

PLOT_TREE<-merge(plot.list,tree.list)


# ok, let's predict some shade classes now
sp_names<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA/SPC_ID.csv")%>%
  dplyr::select(SPCD,SCI_NAME)

treeNames<-merge(PLOT_TREE,sp_names)%>% # merge tree spatial object and names list
  rename(species=SCI_NAME)%>%
  rename(diam=Diameter,shade=SHADE,plot=Plot,tree=Tree)



#ppath<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/canopy_pred/"
#test<-predCanopy(newdata=treeNames,fit=NULL,ppath=ppath)
#FIA_data<-test%>%
  #rename(LAT=UTMy,LON=UTMx)
  

specs<-c("Quercus agrifolia","Quercus chrysolepis","Quercus kelloggii")
tree_sf<-st_as_sf(treeNames,coords=c("UTMx","UTMy"))%>% # turn dataframe into a spatial object
  filter(species%in%specs)
#plot(tree_sf) # cool, the plot works 

tcrs<-"+proj=longlat +datum=WGS84"
st_crs(tree_sf)<-tcrs
tree_transform<-tree_sf
trees<-tree_transform
trees$year<-trees$Year
tree_transform$year<-tree_transform$Year
# start with Quercus bud initiation
mon<-7:9
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_budInit=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

budTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(temp_budInit=mean(tmean_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,temp_budInit)%>%
  distinct()


mon<-4
years<-unique(trees$year)
vars<-"tmean"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_budInit=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


budTemp2<-temp2%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(temp_budInit=mean(tmean_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,temp_budInit)%>%
  distinct()

budTemp<-rbind(budTemp,budTemp2)%>%
  group_by(species,tree,plot,Subplot,year)%>%
  mutate(temp_budInit=mean(temp_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,temp_budInit)%>%
  distinct()


# now let's do temp at pollination
mon<-5
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Poll=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

pollenTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(tmean_Poll=mean(tmean_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,tmean_Poll)%>%
  distinct()



# now let's do temp at fertilization
mon<-6
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Fert=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

fertTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(temp_Fert=mean(tmean_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,temp_Fert)%>%
  distinct()


mon<-4:6
years<-unique(trees$year)
vars<-"tmean"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Fert=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


fertTemp2<-temp2%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(temp_Fert=mean(tmean_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,temp_Fert)%>%
  distinct()

fertTemp<-rbind(fertTemp,fertTemp2)%>%
  group_by(species,tree,plot,Subplot,year)%>%
  mutate(temp_Fert=mean(temp_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,temp_Fert)%>%
  distinct()



# now let's do precip
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-4),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-4)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

budPrecip<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(ppt_budInit=sum(ppt_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,ppt_budInit)%>%
  distinct()


mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


budPrecip2<-temp2%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(ppt_budInit=sum(ppt_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,ppt_budInit)%>%
  distinct()

budPrecip<-rbind(budPrecip,budPrecip2)%>%
  group_by(species,tree,plot,Subplot,year)%>%
  mutate(ppt_budInit=sum(ppt_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,ppt_budInit)%>%
  distinct()


# precip at pollination
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Poll=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

pollPrecip<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(ppt_Poll=sum(ppt_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,ppt_Poll)%>%
  distinct()


mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Poll=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


pollPrecip2<-temp2%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(ppt_Poll=sum(ppt_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,ppt_Poll)%>%
  distinct()

pollPrecip<-rbind(pollPrecip,pollPrecip2)%>%
  group_by(species,tree,plot,Subplot,year)%>%
  mutate(ppt_Poll=sum(ppt_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,ppt_Poll)%>%
  distinct()


# precip at pollination
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Fert=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

fertPrecip<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(ppt_Fert=sum(ppt_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_Fert,diam,Subplot,shade,x,y)%>%
  distinct()


mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Fert=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


fertPrecip2<-temp2%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(ppt_Fert=sum(ppt_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_Fert,diam,Subplot,shade,x,y)%>%
  distinct()

fertPrecip<-rbind(fertPrecip,fertPrecip2)%>%
  group_by(species,tree,plot,Subplot,year)%>%
  mutate(ppt_Fert=sum(ppt_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_Fert,diam,Subplot,shade,x,y)%>%
  distinct()




quercusClim<-full_join(budPrecip,pollPrecip)%>%
  full_join(.,fertPrecip)%>%
  full_join(.,budTemp)%>%
  full_join(.,pollenTemp)%>%
  full_join(.,fertTemp)%>%
  rename(Diameter=diam,Plot=plot,Tree=tree,Species=species,X=x,Y=y)




# OK, now let's load in some PRISM 30year mean data
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
mon<-c(1:3,10:12)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("ppt", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_transform) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Precip=11)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_p<-EXT_df%>%
    dplyr::select(Year,plot,Subplot,tree,Precip)%>%
    distinct()%>%
    group_by(plot,Subplot,tree)%>%
    mutate(Norm_p=sum(Precip))%>%
    dplyr::select(-Precip)%>%
    distinct()
    
  
  
  

temp<-data.frame(NULL)
library(prism)
mon<-c(5:8)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("tmean", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_transform) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Temp=11)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_t<-EXT_df%>%
    dplyr::select(Year,plot,Subplot,tree,Temp)%>%
    rename(Norm_t=Temp)%>%
    group_by(plot,Subplot,tree)%>%
    mutate(Norm_t=mean(Norm_t))%>%
    distinct()

normals<-full_join(normal_t,normal_p)%>%
  rename(Tree=tree,Plot=plot,year=Year)

quercusNorm<-merge(quercusClim,normals)%>%
  mutate(ppt_budInit=scale(ppt_budInit-Norm_p),ppt_Poll=scale(ppt_Poll-Norm_p),ppt_Fert=scale(ppt_Fert-Norm_p),temp_budInit=scale(temp_budInit-Norm_t),tmean_Poll=scale(tmean_Poll-Norm_t),temp_Fert=scale(temp_Fert-Norm_t))%>%
  dplyr::select(-Norm_p,-Norm_t)

oclim<-quercusNorm

oclim2<-merge(quercusClim,normals)

quercusFIA<-tree_transform%>%dplyr::select(plot,Subplot,tree,geometry)
```

``` {r Quercus FIA Predict}


# okay I think the approach I need to take is as follows:
  # first take the coefficients for each term in my full model: diameter and temperature
coefs<-read.csv('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/Quercus MASTIF Output (deviation climate)/quercus_betas.csv')%>%
  mutate(X=gsub("species","",X))%>%
  separate(X,c('Species','var1','var2'),sep=":")%>%
  mutate(var1=ifelse(is.na(var1)==TRUE,"Intercept",var1),var2=ifelse(is.na(var2)==TRUE," ",var2))%>%
    filter(var1!="shade",var2!="shade")%>%
  mutate(Species=tolower(Species),Species=gsub("quercus","Quercus ",Species),Species=ifelse(Species=="Quercus chrysole","Quercus chrysolepis",ifelse(Species== "Quercus kelloggi","Quercus kelloggii","Quercus agrifolia")))%>%
  mutate(beta_obs=estimate,interaction=paste(var1,var2,sep=":"))%>%
  dplyr::select(Species,interaction,beta_obs)%>%
  pivot_wider(names_from=interaction,values_from=beta_obs)

all_clim<-oclim%>%
  dplyr::select(-shade)
all_clim$Year<-all_clim$year

# next for each term, calculate the change in each variable with time in the FIA data 

# GROWTH effect with time
library(broom)
#Spec<-"Abies concolor" # if I need to specify for a focal species do that here or comment code out
dG<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  dplyr::mutate(deltaG=Diameter-lag(Diameter))%>% # calculate growth as difference in diameter from current and previous time point
  mutate(deltaG=ifelse(deltaG<0,0,deltaG)) %>% # use a tobit model to censor data at zero (i.e., can't have negative growth)
  #drop_na()%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(Diameter~Year,data=.)$coefficients))%>%
  mutate(statistic=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,statistic)%>%
  drop_na()%>%
  rename(.,dGdt=statistic)


dT1<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(temp_budInit~Year,data=.)$coefficients))%>%
  mutate(dT1dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dT1dt)%>%
  drop_na()

dT2<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(tmean_Poll~Year,data=.)$coefficients))%>%
  mutate(dT2dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dT2dt)%>%
  drop_na()

dT3<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(temp_Fert~Year,data=.)$coefficients))%>%
  mutate(dT3dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dT3dt)%>%
  drop_na()

dP1<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"),ppt_budInit=scale(ppt_budInit))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(ppt_budInit~Year,data=.)$coefficients))%>%
  mutate(dP1dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dP1dt)%>%
  drop_na()

dP2<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"),ppt_Poll=scale(ppt_Poll))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(ppt_Poll~Year,data=.)$coefficients))%>%
  mutate(dP2dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dP2dt)%>%
  drop_na()

dP3<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"),ppt_Fert=scale(ppt_Fert))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(ppt_Fert~Year,data=.)$coefficients))%>%
  mutate(dP3dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dP3dt)%>%
  drop_na()


dCdt<-merge(dT1,dT2)%>%
  merge(.,dT3)%>%
  merge(.,dP1)%>%
  merge(.,dP2)%>%
  merge(.,dP3)




cnew<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  dplyr::select(Species,TREE_ID,X,Y,Year,Species,Diameter)%>%
  distinct()



growth_climate<-merge(dG,dCdt)%>%
  merge(.,cnew)%>%
  distinct()%>%
  merge(.,coefs)


# okay the Clark et al., 2021 Nat. Comms paper appears to do the following to calculate each effect
# response: df/dC which is just the MASTIF output for change in fecundity with change in precip
Response<-growth_climate%>%
  dplyr::select(Species,TREE_ID,X,Y,15:22)%>%
  distinct()%>%
  rename(G=5,G2=6,P1=7,T1=8,P2=9,T2=10,P3=11,T3=12)%>%
  pivot_longer(col=5:12,names_to="Variable",values_to="Response")

# direct: df/dC * dC/dt 
Direct<-growth_climate%>%
  dplyr::select(TREE_ID,3:9)%>%
  rename(G=2,T1=3,T2=4,T3=5,P1=6,P2=7,P3=8)%>%
  distinct()%>%
  pivot_longer(cols=2:8,names_to="Variable",values_to="dt")%>%
  merge(.,Response)%>%
  mutate(Direct_Effect=Response*dt)
# full: Direct + B + C*(D + E)
    # Direct = df/dC * dC/dt 
  # INDIRECT: 
    #B = (df/dG*dG/dt) 
    #C = df/dGC
    # D = G_effect*dC/dt
    # E = C_effect*dG/dt)



Indirect<-growth_climate%>%
  rename(G=15,G2=16,P1=17,T1=18,P2=19,T2=20,P3=21,T3=22,GP1=23,GT1=24,GP2=25,GT2=26,GP3=27,GT3=28)%>%
  distinct()%>%
  mutate(T1=(G*dGdt)+(GT1*((G*dT1dt)+(T1*dGdt))),
         T2=(G*dGdt)+(GT2*((G*dT2dt)+(T2*dGdt))),
         T3=(G*dGdt)+(GT3*((G*dT3dt)+(T3*dGdt))),
         P1=(G*dGdt)+(GP1*((G*dP1dt)+(P1*dGdt))),
         P2=(G*dGdt)+(GP2*((G*dP2dt)+(P2*dGdt))),
         P3=(G*dGdt)+(GP3*((G*dP3dt)+(P3*dGdt))))%>%
  dplyr::select(TREE_ID,T1,T2,T3,P1,P2,P3)%>%
  distinct()%>%
  pivot_longer(cols=2:7,names_to="Variable",values_to="Indirect")



Full<-merge(Direct,Indirect)%>%
  mutate(Full_Effect=Direct_Effect+Indirect)%>%
  drop_na()
save(Full,file="quercus_FIA.rdata")

full_oaks<-Full%>%
  dplyr::select(TREE_ID,X,Y)%>%
  distinct()

full_sf<-st_as_sf(Full,coords=c("X","Y"))




library(tigris) # package for CA maps
library(raster)
ca<-states()%>%
  filter(NAME=="California")%>%
  dplyr::select(NAME,INTPTLAT,INTPTLON)%>%
  rename(LAT=2,LON=3)
ca$LON<-as.numeric(ca$LON)
ca$LAT<-as.numeric(ca$LAT)



grid <- ca%>%
  sf::st_make_grid(cellsize = 0.05, what = "polygons",square=TRUE) %>%
  sf::st_intersection(ca) %>% 
  sf::st_sf(grid_id = 1:length(.))
sf::sf_use_s2(FALSE)
#grid<-distinct(grid)

library(gstat)



interp<-NULL
for(j in unique(full_sf$Variable)) {
  
  dat<-filter(full_sf,Variable==j)
  st_crs(dat)<-st_crs(grid)
  
  iR <- idw(Response~1, dat, grid,nmax=5,maxdist=5)
  iR2<-cbind(iR,Variable=j,Effect="Response")
  
  idt <- gstat::idw(dt~1, dat, grid,nmax=5,maxdist=5)
  idt2<-cbind(idt,Variable=j,Effect="dt")
  
  iDirect<-gstat::idw(Direct_Effect~1, dat, grid,nmax=5,maxdist=5)
  iDirect2<-cbind(iDirect,Variable=j,Effect="Direct")
  
  iindirect<-gstat::idw(Indirect~1, dat, grid,nmax=5,maxdist=5)
  iindirect2<-cbind(iindirect,Variable=j,Effect="Indirect")
  
  interp<-rbind(interp,iR2,idt2,iDirect2,iindirect2)
}


interp2<-interp%>%
  mutate(Variable=ifelse(Variable=="P3","Precipitation, Bud Initiation",ifelse(Variable=="P2","Precipitation, Pollination",ifelse(Variable=="P1","Precipitation, Fertilization",ifelse(Variable=="T3","Temperature, Bud Initiation",ifelse(Variable=="T2","Temperature, Pollination",ifelse(Variable=="T1","Temperature, Fertilization",NA)))))))



# map of response first
resps<-list()
for (i in unique(interp2$Variable)) {
  resp<-filter(interp2,Variable==i,Effect=="Response")
   nam<-paste0("response",i)
    plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=resp, aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradientn(colours = terrain.colors(7),na.value="white")+
    #scale_fill_gradient(low="lightgreen",high="darkgreen",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 
   resps[[i]]<-plot
   #names(resps[[i]])<-nam
   #setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/Quercus/Quercus Response")
   #file_name = paste("response_", i, ".png", sep="")
   #ggsave(file_name,plot,bg="white",height=10,width=10)
}

resp_plots<-ggarrange(plotlist=resps,nrow=1,common.legend=TRUE)


# map of direct effects
for (i in unique(interp$Variable)) {
  resp<-filter(interp,Variable==i,Effect=="Direct")
   nam<-paste0("Direct",i)
    plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=resp, aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="lightgreen",high="darkgreen",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 
   #resp_plots[[i]]<-plot
   #names(resp_plots[[i]])<-nam
   setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/Quercus/Quercus Direct")
   file_name = paste("Direct_", i, ".png", sep="")
   ggsave(file_name,plot,bg="white",height=10,width=10)
}

# map of indirect effects
for (i in unique(interp$Variable)) {
  resp<-filter(interp,Variable==i,Effect=="Indirect")
   nam<-paste0("Indirect",i)
    plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=resp, aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="lightgreen",high="darkgreen",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 
   #resp_plots[[i]]<-plot
   #names(resp_plots[[i]])<-nam
   setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/Quercus/Quercus Indirect")
   file_name = paste("Indirect_", i, ".png", sep="")
   ggsave(file_name,plot,bg="white",height=10,width=10)
}

full<-interp%>%
  filter(Effect=="Direct" | Effect =="Indirect")%>%
  dplyr::select(-var1.var)%>%
  pivot_wider(names_from="Effect",values_from="var1.pred")%>%
  ungroup()%>%
  #drop_na()%>%
  mutate(Full=Direct + Indirect)


# map of Full effect
full_effects<-list()
for (i in unique(full$Variable)) {
  resp<-filter(full,Variable==i)
   nam<-paste0("Full",i)
    plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=resp, aes(fill = Full),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="lightgreen",high="darkgreen",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 
   full_effects[[i]]<-plot
   #names(full_effects[[i]])<-nam
   #etwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/Quercus/Quercus Full")
   #file_name = paste("Full_", i, ".png", sep="")
   #ggsave(file_name,plot,bg="white",height=10,width=10)
}

all_fulls<-ggarrange(plotlist=full_effects,common.legend=TRUE)


# let's look at the distribution of each species' response
specs<-coefs$Species
tree_ids<-treeNames%>%
  dplyr::select(plot,Subplot,tree,species)%>%
  mutate(TREE_ID=paste(plot,Subplot,tree,sep="_"))%>%
  dplyr::select(species,TREE_ID)%>%
  filter(species%in%specs)

oakResponse<-merge(full_sf,tree_ids)
oakResponse<-load("quercus_FIA.rdata")

library(colorspace)
oakPlot<-ggplot(oakResponse,aes(species,Variable,fill=(Response))) +
  geom_tile() +
  #geom_text(aes(label=mean(Response))) + 
  scale_fill_continuous_diverging("Blue-Yellow 2",na.value="Red")+
  #scale_fill_gradient(low="lightgreen",high="darkgreen",na.value="white") +
  theme_minimal()


ac2<-oclim%>%
  unite(TREE_ID,Plot,Subplot,Tree,sep="_")

gcAC_quercus<-merge(growth_climate,ac2)%>%
  dplyr::select(-dGdt,-dT1dt,-dT2dt,-dT3dt,-dP1dt,-dP2dt,-dP3dt)%>%
  rename(Int=7,dia=8,dia2=9,ppt_budInit_R=10,ppt_Poll_R=11,ppt_Fert_R=12,temp_budInit_R=13,temp_Poll_R=14,temp_Fert_R=15,dia_ppt_budInit_R=16,dia_ppt_Poll_R=17,dia_ppt_Fert_R=18,dia_temp_budInit_R=19,dia_temp_Poll_R=20,dia_temp_Fert_R=21,temp_Poll=tmean_Poll)%>%
   mutate(ppt_budInit_Hi=ppt_budInit*2,ppt_budInit_Lo=ppt_budInit/2,ppt_Poll_Hi=ppt_Poll*2,ppt_Poll_Lo=ppt_Poll/2,ppt_Fert_Hi=ppt_Fert*2,ppt_Fert_Lo=ppt_Fert/2,temp_budInit_Hi=((((temp_budInit*(9/5))+32)+5.8)-32)*(5/9),temp_Poll_Hi=((((temp_Poll*(9/5))+32)+5.8)-32)*(5/9),temp_Fert_Hi=((((temp_Fert*(9/5))+32)+5.8)-32)*(5/9))%>%
  mutate(#P1=scale(P1),P2=scale(P2),P3=scale(P3),T1=scale(T1),T2=scale(T2),T3=scale(T3),
         
         #P1Hi=scale(P1Hi),P2Hi=scale(P2Hi),P3Hi=scale(P3Hi),P1Lo=scale(P1Lo),P2Lo=scale(P2Lo),P3Lo=scale(P3Lo),T1Hi=scale(T1Hi),T2Hi=scale(T2Hi),T3Hi=scale(T3Hi),
         
  logF_current=Int + (dia*Diameter) + (dia2*Diameter) + (ppt_budInit_R*ppt_budInit) + (ppt_Poll_R*ppt_Poll) + (ppt_Fert_R*ppt_Fert) + (temp_budInit_R*temp_budInit)+ (temp_Poll_R*temp_Poll)+ (temp_Fert_R*temp_Fert) + (dia_ppt_budInit_R*ppt_budInit*dia)+ (dia_ppt_Poll_R*ppt_Poll*dia)+ (dia_ppt_Fert_R*ppt_budInit*dia) + (dia_temp_budInit_R*temp_budInit*dia)+ (dia_temp_Poll_R*temp_Poll*dia)+ (dia_temp_Fert_R*temp_Fert*dia),
  
  logF_WW=Int + (dia*Diameter) + (dia2*Diameter) + (ppt_budInit_R*ppt_budInit_Hi) + (ppt_Poll_R*ppt_Poll_Hi) + (ppt_Fert_R*ppt_Fert_Hi) + (temp_budInit_R*temp_budInit_Hi)+ (temp_Poll_R*temp_Poll_Hi)+ (temp_Fert_R*temp_Fert_Hi) + (dia_ppt_budInit_R*ppt_budInit_Hi*dia)+ (dia_ppt_Poll_R*ppt_Poll_Hi*dia)+ (dia_ppt_Fert_R*ppt_budInit_Hi*dia) + (dia_temp_budInit_R*temp_budInit_Hi*dia)+ (dia_temp_Poll_R*temp_Poll_Hi*dia)+ (dia_temp_Fert_R*temp_Fert_Hi*dia),
  
  logF_WD=Int + (dia*Diameter) + (dia2*Diameter) + (ppt_budInit_R*ppt_budInit_Lo) + (ppt_Poll_R*ppt_Poll_Lo) + (ppt_Fert_R*ppt_Fert_Lo) + (temp_budInit_R*temp_budInit_Hi)+ (temp_Poll_R*temp_Poll_Hi)+ (temp_Fert_R*temp_Fert_Hi) + (dia_ppt_budInit_R*ppt_budInit_Lo*dia)+ (dia_ppt_Poll_R*ppt_Poll_Lo*dia)+ (dia_ppt_Fert_R*ppt_budInit_Lo*dia) + (dia_temp_budInit_R*temp_budInit_Hi*dia)+ (dia_temp_Poll_R*temp_Poll_Hi*dia)+ (dia_temp_Fert_R*temp_Fert_Hi*dia),
  
  F_current=exp(logF_current),
  F_WW=exp(logF_WW),
  F_WD=exp(logF_WD)
  )%>%
  group_by(TREE_ID)%>%
  mutate(meanF_current=mean(logF_current),meanF_WW=mean(logF_WW),meanF_WD=mean(logF_WD))

specF_oaks<-gcAC_quercus%>%
  ungroup()%>%
  dplyr::select(Species,meanF_current,meanF_WW,meanF_WD)%>%
  group_by(Species)%>%
  mutate(Fcurr=exp(meanF_current),FWW=exp(meanF_WW),FWD=exp(meanF_WD))%>%
  distinct()

ggplot(specF_oaks) +
 # geom_density(aes(x=meanF_current,fill=Species)) +
   geom_density(aes(x=meanF_current),fill="blue") +
   geom_density(aes(x=meanF_WW),fill="white") +
  geom_density(aes(x=meanF_WD),fill="orange") +
  facet_wrap(~Species,scales="free")




```

``` {r ABIES FIA PRISM}
library(sf)
library(raster)
library(terra)
library(sp)

dir<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA"
#CA_FIA <- getFIA(states = 'CA', dir = dir,load=TRUE) # use this code to get most updated FIA data
CA_FIA<-readFIA(dir) # read in data from directory


#CA_recent<-clipFIA(CA_FIA) # this gets most recent data
tpa_polysSF <- tpa(CA_FIA,treeType="live",treeDomain = SPCD==122,byPlot=TRUE,returnSpatial = TRUE) # filter out just PIPO and make it a spatial object, only gives trees per acre
plot(tpa_polysSF) # testplot of trees per acre

plot.list<-data.frame(Plot=CA_FIA$PLOT$PLOT,Unit=CA_FIA$PLOT$UNITCD,County=CA_FIA$PLOT$COUNTYCD,STATE=CA_FIA$PLOT$STATECD,UTMy=CA_FIA$PLOT$LAT,UTMx=CA_FIA$PLOT$LON)%>%
  unite(PLOT,Plot,Unit,County,STATE,sep="_")%>%
  rename(Plot=PLOT)%>%
  distinct()

tree.list <- data.frame(Year=CA_FIA$TREE$INVYR,Plot=CA_FIA$TREE$PLOT,Unit=CA_FIA$TREE$UNITCD,County=CA_FIA$TREE$COUNTYCD,STATE=CA_FIA$TREE$STATECD,Subplot=CA_FIA$TREE$SUBP,Tree=CA_FIA$TREE$TREE,Diameter=CA_FIA$TREE$DIA,SPCD=CA_FIA$TREE$SPCD,SHADE=CA_FIA$TREE$CLIGHTCD,canopy=CA_FIA$TREE$CCLCD)%>%
  unite(PLOT,Plot,Unit,County,STATE,sep="_")%>%
  rename(Plot=PLOT)%>%
  distinct()

PLOT_TREE<-merge(plot.list,tree.list)


# ok, let's predict some shade classes now
sp_names<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA/SPC_ID.csv")%>%
  dplyr::select(SPCD,SCI_NAME)

treeNames<-merge(PLOT_TREE,sp_names)%>% # merge tree spatial object and names list
  rename(species=SCI_NAME)%>%
  rename(diam=Diameter,shade=SHADE,plot=Plot,tree=Tree)



#ppath<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/canopy_pred/"
#test<-predCanopy(newdata=treeNames,fit=NULL,ppath=ppath)
#FIA_data<-test%>%
  #rename(LAT=UTMy,LON=UTMx)
  

specs<-c("Abies grandis","Abies concolor","Abies magnifica")
tree_sf<-st_as_sf(treeNames,coords=c("UTMx","UTMy"))%>% # turn dataframe into a spatial object
  filter(species%in%specs)
#plot(tree_sf) # cool, the plot works 

tcrs<-"+proj=longlat +datum=WGS84"
st_crs(tree_sf)<-tcrs
tree_transform<-tree_sf
trees<-tree_transform
trees$year<-trees$Year
tree_transform$year<-tree_transform$Year


# start with Abies bud initiation
# first is t-1 years
mon<-5:10
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_budInit=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

# now let's do April of current year
mon<-4
years<-unique(trees$year)
vars<-"tmean"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_budInit=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}

budTemp<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(temp_budInit=mean(tmean_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,temp_budInit)%>%
  distinct()



# now let's do temp at pollination
mon<-5
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Poll=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

pollenTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(tmean_Poll=mean(tmean_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,tmean_Poll)%>%
  distinct()

# now let's do temp at fertilization
mon<-6:8
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Fert=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

fertTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(tmean_Fert=mean(tmean_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,tmean_Fert)%>%
  distinct()



# now let's do precip at Bud Initiation
# here we are only concerned with water year
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}


# now let's get spring precip
mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


budPrecip<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  mutate(Year=ifelse(Month%in%c(10:12),as.numeric(Year)+1,as.numeric(Year)))%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(precip_budInit=sum(ppt_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,precip_budInit)%>%
  distinct()

# given the timing, we have to do pollination and fertilization precip together because the timing is all the same (i.e., current year)
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_PollFert=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}


# now let's get spring precip
mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_PollFert=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


PollFertPrecip<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  mutate(Year=ifelse(Month%in%c(10:12),as.numeric(Year)+1,as.numeric(Year)))%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(precip_PollFert=sum(ppt_PollFert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,precip_PollFert,diam,shade,x,y)%>%
  distinct()




abiesClim<-full_join(budPrecip,budTemp)%>%
  full_join(.,pollenTemp)%>%
  full_join(.,fertTemp)%>%
  full_join(.,PollFertPrecip)%>%
  rename(Diameter=diam,Plot=plot,Tree=tree,Species=species,X=x,Y=y)




# OK, now let's load in some PRISM 30year mean data
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
mon<-c(1:3,10:12)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("ppt", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_transform) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Precip=11)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_p<-EXT_df%>%
    dplyr::select(Year,plot,Subplot,tree,Precip)%>%
    distinct()%>%
    group_by(plot,Subplot,tree)%>%
    mutate(Norm_p=sum(Precip))%>%
    dplyr::select(-Precip)%>%
    distinct()
    
  
  
  

temp<-data.frame(NULL)
library(prism)
mon<-c(5:8)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("tmean", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_transform) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Temp=11)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_t<-EXT_df%>%
    dplyr::select(Year,plot,Subplot,tree,Temp)%>%
    rename(Norm_t=Temp)%>%
    group_by(plot,Subplot,tree)%>%
    mutate(Norm_t=mean(Norm_t))%>%
    distinct()

normals<-full_join(normal_t,normal_p)%>%
  rename(Tree=tree,Plot=plot,year=Year)

abiesNorm<-merge(abiesClim,normals)%>%
  mutate(precip_budInit=scale(precip_budInit-Norm_p),temp_budInit=scale(temp_budInit-Norm_t),tmean_Poll=scale(tmean_Poll-Norm_t),tmean_Fert=scale(tmean_Fert-Norm_t),precip_PollFert=scale(precip_PollFert-Norm_p))%>%
  dplyr::select(-Norm_p,-Norm_t)


aclim<-abiesNorm

aclim2<-merge(abiesClim,normals)

abiesFIA<-tree_transform%>%dplyr::select(plot,Subplot,tree,geometry)
```

``` {r Abies FIA Predict}

# okay I think the approach I need to take is as follows:
  # first take the coefficients for each term in my full model: diameter and temperature
coefs<-read.csv('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/Abies MASTIF Output (deviation climate)/abies_betas.csv')%>%
  mutate(X=gsub("species","",X))%>%
  separate(X,c('Species','var1','var2'),sep=":")%>%
  mutate(var1=ifelse(is.na(var1)==TRUE,"Intercept",var1),var2=ifelse(is.na(var2)==TRUE," ",var2))%>%
    filter(var1!="shade",var2!="shade")%>%
  mutate(Species=tolower(Species),Species=gsub("abies","Abies ",Species),Species=ifelse(Species=="Abies concolor","Abies concolor",ifelse(Species=="Abies magnific","Abies magnifica",ifelse(Species=="Abies lasiocar","Abies lasiocarpa",Species))))%>%
  mutate(beta_obs=estimate,interaction=paste(var1,var2,sep=":"))%>%
  dplyr::select(Species,interaction,beta_obs)%>%
  pivot_wider(names_from=interaction,values_from=beta_obs)


all_clim<-aclim%>%
  dplyr::select(-shade)
all_clim$Year<-all_clim$year
# next for each term, calculate the change in each variable with time in the FIA data 

# GROWTH effect with time
library(broom)
#Spec<-"Abies concolor" # if I need to specify for a focal species do that here or comment code out
dG<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree,)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  dplyr::mutate(deltaG=Diameter-lag(Diameter))%>% # calculate growth as difference in diameter from current and previous time point
  mutate(deltaG=ifelse(deltaG<0,0,deltaG)) %>% # use a tobit model to censor data at zero (i.e., can't have negative growth)
  #drop_na()%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(Diameter~Year,data=.)$coefficients))%>%
  mutate(statistic=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,statistic)%>%
  drop_na()%>%
  rename(.,dGdt=statistic)



dT1<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(temp_budInit~Year,data=.)$coefficients))%>%
  mutate(dT1dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dT1dt)%>%
  drop_na()

dT2<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(tmean_Poll~Year,data=.)$coefficients))%>%
  mutate(dT2dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dT2dt)%>%
  drop_na()

dT3<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(tmean_Fert~Year,data=.)$coefficients))%>%
  mutate(dT3dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dT3dt)%>%
  drop_na()

dP1<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"),precip_budInit=scale(precip_budInit))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(precip_budInit~Year,data=.)$coefficients))%>%
  mutate(dP1dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dP1dt)%>%
  drop_na()

dP2<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"),precip_PollFert=scale(precip_PollFert))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(precip_PollFert~Year,data=.)$coefficients))%>%
  mutate(dP2dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dP2dt)%>%
  drop_na()


dCdt<-merge(dT1,dT2)%>%
  merge(.,dT3)%>%
  merge(.,dP1)%>%
  merge(.,dP2)




cnew<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  dplyr::select(TREE_ID,X,Y,Year,Species,Diameter,precip_budInit,temp_budInit,tmean_Poll,tmean_Fert,precip_PollFert)%>%
  distinct()



growth_climate<-merge(dG,dCdt)%>%
  merge(.,cnew)%>%
  #merge(.,dPrecip)%>%
 # merge(.,dVPD)%>%
  distinct()%>%
  merge(.,coefs)



# okay the Clark et al., 2021 Nat. Comms paper appears to do the following to calculate each effect
# response: df/dC which is just the MASTIF output for change in fecundity with change in precip
Response<-growth_climate%>%
  dplyr::select(Species,TREE_ID,X,Y,19:25)%>%
  distinct()%>%
  rename(G=5,G2=6,P1=7,T1=8,T2=9,T3=10,P2=11)%>%
  pivot_longer(col=5:11,names_to="Variable",values_to="Response")

# direct: df/dC * dC/dt 
Direct<-growth_climate%>%
  dplyr::select(1:8)%>%
  rename(G=3,T1=4,T2=5,T3=6,P1=7,P2=8)%>%
  distinct()%>%
  pivot_longer(cols=3:8,names_to="Variable",values_to="dt")%>%
  merge(.,Response)%>%
  mutate(Direct_Effect=Response*dt)



# full: Direct + B + C*(D + E)
    # Direct = df/dC * dC/dt 
  # INDIRECT: 
    #B = (df/dG*dG/dt) 
    #C = df/dGC
    # D = G_effect*dC/dt
    # E = C_effect*dG/dt)

Indirect<-growth_climate%>%
  dplyr::select(1:8,19:30)%>%
  rename(G=9,G2=10,P1=11,T1=12,T2=13,T3=14,P2=15,GP1=16,GT1=17,GT2=18,GT3=19,GP2=20)%>%
  distinct()%>%
  mutate(P1=(G*dGdt)+(GP1*((G*dP1dt)+(P1*dGdt))),
         T1=(G*dGdt)+(GT1*((G*dT1dt)+(T1*dGdt))),
         P2=(G*dGdt)+(GP2*((G*dP2dt)+(P2*dGdt))),
         T2=(G*dGdt)+(GT2*((G*dT2dt)+(T2*dGdt))),
         T3=(G*dGdt)+(GT3*((G*dT3dt)+(T3*dGdt))))%>%
  dplyr::select(Species,TREE_ID,P1,T1,T2,T3,P2)%>%
  distinct()%>%
  pivot_longer(cols=3:7,names_to="Variable",values_to="Indirect")

Full<-merge(Direct,Indirect)%>%
  mutate(Full_Effect=Direct_Effect+Indirect)%>%
  drop_na()

full_firs<-Full%>%
  dplyr::select(TREE_ID,X,Y)%>%
  distinct()

save(Full,file="Abies_FIA.rdata")

full_sf<-st_as_sf(Full,coords=c("X","Y"))




library(tigris) # package for CA maps
library(raster)
ca<-states(keep_zipped_shapefile=TRUE)%>%
  filter(NAME=="California")%>%
  dplyr::select(NAME,INTPTLAT,INTPTLON)%>%
  rename(LAT=2,LON=3)
ca$LON<-as.numeric(ca$LON)
ca$LAT<-as.numeric(ca$LAT)




grid <- ca%>%
  sf::st_make_grid(cellsize = 0.05, what = "polygons",square=TRUE) %>%
  sf::st_intersection(ca) %>% 
  sf::st_sf(grid_id = 1:length(.))
sf::sf_use_s2(FALSE)
#grid<-distinct(grid)

library(gstat)



interp<-NULL
for(j in unique(full_sf$Variable)) {
  
  dat<-filter(full_sf,Variable==j)
  st_crs(dat)<-st_crs(grid)
  
  iR <- idw(Response~1, dat, grid,nmax=5,maxdist=5)
  iR2<-cbind(iR,Variable=j,Effect="Response")
  
  idt <- gstat::idw(dt~1, dat, grid,nmax=5,maxdist=5)
  idt2<-cbind(idt,Variable=j,Effect="dt")
  
  iDirect<-gstat::idw(Direct_Effect~1, dat, grid,nmax=5,maxdist=5)
  iDirect2<-cbind(iDirect,Variable=j,Effect="Direct")
  
  iindirect<-gstat::idw(Indirect~1, dat, grid,nmax=5,maxdist=5)
  iindirect2<-cbind(iindirect,Variable=j,Effect="Indirect")
  
  interp<-rbind(interp,iR2,idt2,iDirect2,iindirect2)
}






# map of response first
for (i in unique(interp$Variable)) {
  resp<-filter(interp,Variable==i,Effect=="Response")
   nam<-paste0("response",i)
    plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=resp, aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="lightgreen",high="darkgreen",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 
   #resp_plots[[i]]<-plot
   #names(resp_plots[[i]])<-nam
   setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/Abies/Abies Response")
   file_name = paste("response_", i, ".png", sep="")
   ggsave(file_name,plot,bg="white",height=10,width=10)
}



# map of direct effects
for (i in unique(interp$Variable)) {
  resp<-filter(interp,Variable==i,Effect=="Direct")
   nam<-paste0("Direct",i)
    plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=resp, aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="lightgreen",high="darkgreen",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 
   #resp_plots[[i]]<-plot
   #names(resp_plots[[i]])<-nam
   setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/Abies/Abies Direct")
   file_name = paste("Direct_", i, ".png", sep="")
   ggsave(file_name,plot,bg="white",height=10,width=10)
}

# map of indirect effects
for (i in unique(interp$Variable)) {
  resp<-filter(interp,Variable==i,Effect=="Indirect")
   nam<-paste0("Indirect",i)
    plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=resp, aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="lightgreen",high="darkgreen",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 
   #resp_plots[[i]]<-plot
   #names(resp_plots[[i]])<-nam
   setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/Abies/Abies Indirect")
   file_name = paste("Indirect_", i, ".png", sep="")
   ggsave(file_name,plot,bg="white",height=10,width=10)
}

full<-interp%>%
  filter(Effect=="Direct" | Effect =="Indirect")%>%
  dplyr::select(-var1.var)%>%
  pivot_wider(names_from="Effect",values_from="var1.pred")%>%
  ungroup()%>%
  #drop_na()%>%
  mutate(Full=Direct + Indirect)

# map of Full effects
for (i in unique(full$Variable)) {
  resp<-filter(full,Variable==i)
   nam<-paste0("Full",i)
    plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=resp, aes(fill = Full),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="lightgreen",high="darkgreen",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 
   #resp_plots[[i]]<-plot
   #names(resp_plots[[i]])<-nam
   setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/Abies/Abies Full")
   file_name = paste("Full_", i, ".png", sep="")
   ggsave(file_name,plot,bg="white",height=10,width=10)
}





ac2<-aclim%>%
  unite(TREE_ID,Plot,Subplot,Tree,sep="_")

gcAC_abies<-merge(growth_climate,ac2)%>%
  dplyr::select(-dGdt,-dT1dt,-dT2dt,-dT3dt,-dP1dt,-dP2dt)%>%
  rename(Int=12,dia=13,dia2=14,ppt_budInit_R=15,ppt_PollFert_R=19,temp_budInit_R=16,temp_Poll_R=17,temp_Fert_R=18,dia_ppt_budInit_R=20,dia_ppt_PollFert_R=24,dia_temp_budInit_R=21,dia_temp_Poll_R=22,dia_temp_Fert_R=23,ppt_budInit=precip_budInit,temp_Fert=tmean_Fert,ppt_PollFert=precip_PollFert,temp_Poll=tmean_Poll)%>%
  
   mutate(ppt_budInit_Hi=ppt_budInit*2,ppt_budInit_Lo=ppt_budInit/2,ppt_PollFert_Hi=ppt_PollFert*2,ppt_PollFert_Lo=ppt_PollFert/2,temp_budInit_Hi=((((temp_budInit*(9/5))+32)+5.8)-32)*(5/9),temp_Poll_Hi=((((temp_Poll*(9/5))+32)+5.8)-32)*(5/9),temp_Fert_Hi=((((temp_Fert*(9/5))+32)+5.8)-32)*(5/9))%>%
  
  mutate(#P1=scale(P1),P2=scale(P2),P3=scale(P3),T1=scale(T1),T2=scale(T2),T3=scale(T3),
         
         #P1Hi=scale(P1Hi),P2Hi=scale(P2Hi),P3Hi=scale(P3Hi),P1Lo=scale(P1Lo),P2Lo=scale(P2Lo),P3Lo=scale(P3Lo),T1Hi=scale(T1Hi),T2Hi=scale(T2Hi),T3Hi=scale(T3Hi),
         
  logF_current=Int + (dia*Diameter) + (dia2*Diameter) + (ppt_budInit_R*ppt_budInit) + (ppt_PollFert_R*ppt_PollFert) + (temp_budInit_R*temp_budInit)+ (temp_Poll_R*temp_Poll)+ (temp_Fert_R*temp_Fert) + (dia_ppt_budInit_R*ppt_budInit*dia)+ (dia_ppt_PollFert_R*ppt_PollFert*dia) + (dia_temp_budInit_R*temp_budInit*dia)+ (dia_temp_Poll_R*temp_Poll*dia)+ (dia_temp_Fert_R*temp_Fert*dia),
  
  logF_WW=Int + (dia*Diameter) + (dia2*Diameter) + (ppt_budInit_R*ppt_budInit_Hi) + (ppt_PollFert_R*ppt_PollFert_Hi) + (temp_budInit_R*temp_budInit_Hi)+ (temp_Poll_R*temp_Poll_Hi)+ (temp_Fert_R*temp_Fert_Hi) + (dia_ppt_budInit_R*ppt_budInit_Hi*dia)+ (dia_ppt_PollFert_R*ppt_PollFert_Hi*dia) + (dia_temp_budInit_R*temp_budInit_Hi*dia)+ (dia_temp_Poll_R*temp_Poll_Hi*dia)+ (dia_temp_Fert_R*temp_Fert_Hi*dia),
  
  logF_WD=Int + (dia*Diameter) + (dia2*Diameter) + (ppt_budInit_R*ppt_budInit_Lo) + (ppt_PollFert_R*ppt_PollFert_Lo) + (temp_budInit_R*temp_budInit_Hi)+ (temp_Poll_R*temp_Poll_Hi)+ (temp_Fert_R*temp_Fert_Hi) + (dia_ppt_budInit_R*ppt_budInit_Lo*dia)+ (dia_ppt_PollFert_R*ppt_PollFert_Lo*dia) + (dia_temp_budInit_R*temp_budInit_Hi*dia)+ (dia_temp_Poll_R*temp_Poll_Hi*dia)+ (dia_temp_Fert_R*temp_Fert_Hi*dia),
  
  F_current=exp(logF_current),
  F_WW=exp(logF_WW),
  F_WD=exp(logF_WD)
  )%>%
  group_by(TREE_ID)%>%
  mutate(meanF_current=mean(logF_current),meanF_WW=mean(logF_WW),meanF_WD=mean(logF_WD))

specF_abies<-gcAC_abies%>%
  ungroup()%>%
  dplyr::select(Species,meanF_current,meanF_WW,meanF_WD)%>%
  group_by(Species)%>%
  mutate(Fcurr=exp(meanF_current),FWW=exp(meanF_WW),FWD=exp(meanF_WD))%>%
  distinct()

ggplot(specF_abies) +
 # geom_density(aes(x=meanF_current,fill=Species)) +
   geom_density(aes(x=meanF_current),fill="blue") +
   geom_density(aes(x=meanF_WW),fill="white") +
  geom_density(aes(x=meanF_WD),fill="orange") +
  facet_wrap(~Species,scales="free")




futureClim<-rbind(specF_abies,specF_pinus,specF_oaks)


futureDists<-ggplot(futureClim) +
 # geom_density(aes(x=meanF_current,fill=Species)) +
   geom_density(aes(x=meanF_current,color="Historical"),fill="blue") +
   geom_density(aes(x=meanF_WW,color="Warm, Wet"),fill="white") +
  geom_density(aes(x=meanF_WD,color="Warm, Dry"),fill="yellow") +
  theme_minimal() +
  labs(x="Predicted Fecundity (Log Scale)") +
  theme(text=element_text(size=15),legend.title=element_blank()) +
  facet_wrap(~Species,scales="free",ncol=1)
ggsave("future_fecundity.png",futureDists,bg="white",dpi=300,height=15,width=10)



```

``` {r PINUS FIA PRISM}
library(sf)
library(raster)
library(terra)
library(sp)

dir<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA"
#CA_FIA <- getFIA(states = 'CA', dir = dir,load=TRUE) # use this code to get most updated FIA data
CA_FIA<-readFIA(dir) # read in data from directory


#CA_recent<-clipFIA(CA_FIA) # this gets most recent data
tpa_polysSF <- tpa(CA_FIA,treeType="live",treeDomain = SPCD==122,byPlot=TRUE,returnSpatial = TRUE) # filter out just PIPO and make it a spatial object, only gives trees per acre
plot(tpa_polysSF) # testplot of trees per acre

plot.list<-data.frame(Plot=CA_FIA$PLOT$PLOT,Unit=CA_FIA$PLOT$UNITCD,County=CA_FIA$PLOT$COUNTYCD,STATE=CA_FIA$PLOT$STATECD,UTMy=CA_FIA$PLOT$LAT,UTMx=CA_FIA$PLOT$LON)%>%
  unite(PLOT,Plot,Unit,County,STATE,sep="_")%>%
  rename(Plot=PLOT)%>%
  distinct()

tree.list <- data.frame(Year=CA_FIA$TREE$INVYR,Plot=CA_FIA$TREE$PLOT,Unit=CA_FIA$TREE$UNITCD,County=CA_FIA$TREE$COUNTYCD,STATE=CA_FIA$TREE$STATECD,Subplot=CA_FIA$TREE$SUBP,Tree=CA_FIA$TREE$TREE,Diameter=CA_FIA$TREE$DIA,SPCD=CA_FIA$TREE$SPCD,SHADE=CA_FIA$TREE$CLIGHTCD,canopy=CA_FIA$TREE$CCLCD)%>%
  unite(PLOT,Plot,Unit,County,STATE,sep="_")%>%
  rename(Plot=PLOT)%>%
  distinct()

PLOT_TREE<-merge(plot.list,tree.list)


# ok, let's predict some shade classes now
sp_names<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA/SPC_ID.csv")%>%
  dplyr::select(SPCD,SCI_NAME)

treeNames<-merge(PLOT_TREE,sp_names)%>% # merge tree spatial object and names list
  rename(species=SCI_NAME)%>%
  rename(diam=Diameter,shade=SHADE,plot=Plot,tree=Tree)



#ppath<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/canopy_pred/"
#test<-predCanopy(newdata=treeNames,fit=NULL,ppath=ppath)
#FIA_data<-test%>%
  #rename(LAT=UTMy,LON=UTMx)
  

specs<-c("Pinus ponderosa","Pinus contorta","Pinus jeffreyi", "Pinus lambertiana", "Pinus monticola")
tree_sf<-st_as_sf(treeNames,coords=c("UTMx","UTMy"))%>% # turn dataframe into a spatial object
  filter(species%in%specs)
#plot(tree_sf) # cool, the plot works 

tcrs<-"+proj=longlat +datum=WGS84"
st_crs(tree_sf)<-tcrs
tree_transform<-tree_sf
trees<-tree_transform
trees$year<-trees$Year
tree_transform$year<-tree_transform$Year


# start with Pinus bud initiation
mon<-8:10
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_budInit=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

budTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(temp_budInit=mean(tmean_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,temp_budInit)%>%
  distinct()



# now let's do temp at pollination
mon<-4:8
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Poll=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

pollenTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(tmean_Poll=mean(tmean_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,tmean_Poll)%>%
  distinct()



# now let's do temp at fertilization
mon<-5:10
years<-unique(trees$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Fert=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

fertTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(tmean_Fert=mean(tmean_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,tmean_Fert)%>%
  distinct()



# now let's do precip at Bud Initiation
# here we are only concerned with water year
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-4),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-4)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}


# now let's get spring precip
mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


budPrecip<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  mutate(Year=ifelse(Month%in%c(10:12),as.numeric(Year)+1,as.numeric(Year)))%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(precip_budInit=sum(ppt_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,precip_budInit)%>%
  distinct()


# now let's do precip at Pollination
# here we are only concerned with water year
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Poll=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}


# now let's get spring precip
mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Poll=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


pollPrecip<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  mutate(Year=ifelse(Month%in%c(10:12),as.numeric(Year)+1,as.numeric(Year)))%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(ppt_Poll=sum(ppt_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,ppt_Poll)%>%
  distinct()


# now let's do precip at Fertilization
# here we are only concerned with water year
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Fert=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}


# now let's get spring precip
mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Fert=11)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


fertPrecip<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  mutate(Year=ifelse(Month%in%c(10:12),as.numeric(Year)+1,as.numeric(Year)))%>%
  group_by(species,tree,plot,Subplot,Year)%>%
  mutate(ppt_Fert=sum(ppt_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,Subplot,year,ppt_Fert,shade,diam,x,y)%>%
  distinct()



pinusClim<-full_join(budPrecip,pollPrecip)%>%
  full_join(.,fertPrecip)%>%
  full_join(.,budTemp)%>%
  full_join(.,pollenTemp)%>%
  full_join(.,fertTemp)%>%
  rename(Diameter=diam,Plot=plot,Tree=tree,Species=species,X=x,Y=y)





# OK, now let's load in some PRISM 30year mean data
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
mon<-c(1:3,10:12)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("ppt", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_transform) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Precip=11)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_p<-EXT_df%>%
    dplyr::select(Year,plot,Subplot,tree,Precip)%>%
    distinct()%>%
    group_by(plot,Subplot,tree)%>%
    mutate(Norm_p=sum(Precip))%>%
    dplyr::select(-Precip)%>%
    distinct()
    
  
  
  

temp<-data.frame(NULL)
library(prism)
mon<-c(5:8)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("tmean", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_transform) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Temp=11)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_t<-EXT_df%>%
    dplyr::select(Year,plot,Subplot,tree,Temp)%>%
    rename(Norm_t=Temp)%>%
    group_by(plot,Subplot,tree)%>%
    mutate(Norm_t=mean(Norm_t))%>%
    distinct()

normals<-full_join(normal_t,normal_p)%>%
  rename(Tree=tree,Plot=plot,year=Year)

pinusNorm<-merge(pinusClim,normals)%>%
  mutate(precip_budInit=scale(precip_budInit-Norm_p),ppt_Poll=scale(ppt_Poll-Norm_p),ppt_Fert=scale(ppt_Fert-Norm_p),temp_budInit=scale(temp_budInit-Norm_t),tmean_Poll=scale(tmean_Poll-Norm_t),tmean_Fert=scale(tmean_Fert-Norm_t))%>%
  dplyr::select(-Norm_p,-Norm_t)

pclim<-pinusNorm

pclim2<-merge(pinusClim,normals)


pinusFIA<-tree_transform%>%dplyr::select(plot,Subplot,tree,geometry)

```

``` {r Pinus FIA Predict}

# okay I think the approach I need to take is as follows:
  # first take the coefficients for each term in my full model: diameter and temperature
coefs<-read.csv('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/Pinus MASTIF Output (deviation climate)/pinus_betas.csv')%>%
  mutate(X=gsub("species","",X))%>%
  separate(X,c('Species','var1','var2'),sep=":")%>%
  mutate(var1=ifelse(is.na(var1)==TRUE,"Intercept",var1),var2=ifelse(is.na(var2)==TRUE," ",var2))%>%
    filter(var1!="shade",var2!="shade")%>%
  mutate(Species=tolower(Species),Species=gsub("pinus","Pinus ",Species),Species=ifelse(Species=="Pinus contorta","Pinus contorta",ifelse(Species=="Pinus jeffreyi", "Pinus jeffreyi",ifelse(Species=="Pinus lamberti","Pinus lambertiana",ifelse(Species=="Pinus monticol","Pinus monticola","Pinus ponderosa")))))%>%
  mutate(beta_obs=ifelse(sig95=="*",estimate,0),interaction=paste(var1,var2,sep=":"))%>%
  dplyr::select(Species,interaction,beta_obs)%>%
  pivot_wider(names_from=interaction,values_from=beta_obs)

all_clim<-pclim%>%
  dplyr::select(-shade)
all_clim$Year<-all_clim$year

pinus<-merge(all_clim,coefs)%>%
  filter(Species%in%coefs$Species)
  

# next for each term, calculate the change in each variable with time in the FIA data 

# GROWTH effect with time
library(broom)
#Spec<-"Abies concolor" # if I need to specify for a focal species do that here or comment code out
dG<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree,)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  dplyr::mutate(deltaG=Diameter-lag(Diameter))%>% # calculate growth as difference in diameter from current and previous time point
  mutate(deltaG=ifelse(deltaG<0,0,deltaG)) %>% # use a tobit model to censor data at zero (i.e., can't have negative growth)
  #drop_na()%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(Diameter~Year,data=.)$coefficients))%>%
  mutate(statistic=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,statistic)%>%
  drop_na()%>%
  rename(.,dGdt=statistic)


dT1<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(temp_budInit~Year,data=.)$coefficients))%>%
  mutate(dT1dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dT1dt)%>%
  drop_na()

dT2<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(tmean_Poll~Year,data=.)$coefficients))%>%
  mutate(dT2dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dT2dt)%>%
  drop_na()

dT3<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(tmean_Fert~Year,data=.)$coefficients))%>%
  mutate(dT3dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dT3dt)%>%
  drop_na()

dP1<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(precip_budInit~Year,data=.)$coefficients))%>%
  mutate(dP1dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dP1dt)%>%
  drop_na()

dP2<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(ppt_Poll~Year,data=.)$coefficients))%>%
  mutate(dP2dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dP2dt)%>%
  drop_na()

dP3<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(ppt_Fert~Year,data=.)$coefficients))%>%
  mutate(dP3dt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,dP3dt)%>%
  drop_na()


dCdt<-merge(dT1,dT2)%>%
  merge(.,dT3)%>%
  merge(.,dP1)%>%
  merge(.,dP2)%>%
  merge(.,dP3)




cnew<-all_clim%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  dplyr::select(TREE_ID,X,Y,Year,Species,Diameter)%>%
  distinct()



growth_climate<-merge(dG,dCdt)%>%
  merge(.,cnew)%>%
  distinct()%>%
  merge(.,coefs)



# okay the Clark et al., 2021 Nat. Comms paper appears to do the following to calculate each effect
# response: df/dC which is just the MASTIF output for change in fecundity with change in precip
Response<-growth_climate%>%
  dplyr::select(Species,TREE_ID,X,Y,15:22)%>%
  distinct()%>%
  rename(G=5,G2=6,P1=7,P2=8,P3=9,T1=10,T2=11,T3=12)%>%
  pivot_longer(col=5:12,names_to="Variable",values_to="Response")

# direct: df/dC * dC/dt 
Direct<-growth_climate%>%
  dplyr::select(1:11)%>%
  rename(G=3,T1=4,T2=5,T3=6,P1=7,P2=8,P3=9)%>%
  distinct()%>%
  pivot_longer(cols=3:9,names_to="Variable",values_to="dt")%>%
  merge(.,Response)%>%
  mutate(Direct_Effect=Response*dt)


# full: Direct + B + C*(D + E)
    # Direct = df/dC * dC/dt 
  # INDIRECT: 
    #B = (df/dG*dG/dt) 
    #C = df/dGC
    # D = G_effect*dC/dt
    # E = C_effect*dG/dt)
Indirect<-growth_climate%>%
  rename(G=15,G2=16,P1=17,P2=18,P3=19,T1=20,T2=21,T3=22,GP1=23,GP2=24,GP3=25,GT1=26,GT2=27,GT3=28)%>%
  distinct()%>%
  mutate(T1=(G*dGdt)+(GT1*((G*dT1dt)+(T1*dGdt))),T2=(G*dGdt)+(GT2*((G*dT2dt)+(T2*dGdt))),T3=(G*dGdt)+(GT3*((G*dT3dt)+(T3*dGdt))),P1=(G*dGdt)+(GP1*((G*dP1dt)+(P1*dGdt))),P2=(G*dGdt)+(GP2*((G*dP2dt)+(P2*dGdt))),P3=(G*dGdt)+(GP3*((G*dP3dt)+(P3*dGdt))))%>%
  dplyr::select(Species,TREE_ID,T1,T2,T3,P1,P2,P3)%>%
  distinct()%>%
  pivot_longer(cols=3:8,names_to="Variable",values_to="Indirect")


Full<-merge(Direct,Indirect)%>%
  mutate(Full_Effect=Direct_Effect+Indirect)%>%
  drop_na()

full_pines<-Full%>%
  dplyr::select(TREE_ID,X,Y)%>%
  distinct()

save(Full,file="pinus_FIA.rdata")


load("pinus_FIA.rdata")

full_sf<-st_as_sf(Full,coords=c("X","Y"))



library(tigris) # package for CA maps
library(raster)
ca<-states(keep_zipped_shapefile=TRUE)%>%
  filter(NAME=="California")%>%
  dplyr::select(NAME,INTPTLAT,INTPTLON)%>%
  rename(LAT=2,LON=3)
ca$LON<-as.numeric(ca$LON)
ca$LAT<-as.numeric(ca$LAT)




grid <- ca%>%
  sf::st_make_grid(cellsize = 0.05, what = "polygons",square=TRUE) %>%
  sf::st_intersection(ca) %>% 
  sf::st_sf(grid_id = 1:length(.))
sf::sf_use_s2(FALSE)
#grid<-distinct(grid)

library(gstat)



interp<-NULL
for(j in unique(full_sf$Variable)) {
  
  dat<-filter(full_sf,Variable==j)
  st_crs(dat)<-st_crs(grid)
  
  iR <- idw(Response~1, dat, grid,nmax=5,maxdist=5)
  iR2<-cbind(iR,Variable=j,Effect="Response")
  
  idt <- gstat::idw(dt~1, dat, grid,nmax=5,maxdist=5)
  idt2<-cbind(idt,Variable=j,Effect="dt")
  
  iDirect<-gstat::idw(Direct_Effect~1, dat, grid,nmax=5,maxdist=5)
  iDirect2<-cbind(iDirect,Variable=j,Effect="Direct")
  
  iindirect<-gstat::idw(Indirect~1, dat, grid,nmax=5,maxdist=5)
  iindirect2<-cbind(iindirect,Variable=j,Effect="Indirect")
  
  interp<-rbind(interp,iR2,idt2,iDirect2,iindirect2)
}






# map of response first
for (i in unique(interp$Variable)) {
  resp<-filter(interp,Variable==i,Effect=="Response")
   nam<-paste0("response",i)
    plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=resp, aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="lightgreen",high="darkgreen",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 
   #resp_plots[[i]]<-plot
   #names(resp_plots[[i]])<-nam
   setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/Pinus/Pinus Response")
   file_name = paste("response_", i, ".png", sep="")
   ggsave(file_name,plot,bg="white",height=10,width=10)
}


# map of direct effects
for (i in unique(interp$Variable)) {
  resp<-filter(interp,Variable==i,Effect=="Direct")
   nam<-paste0("Direct",i)
    plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=resp, aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="lightgreen",high="darkgreen",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 
   #resp_plots[[i]]<-plot
   #names(resp_plots[[i]])<-nam
   setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/Pinus/Pinus Direct")
   file_name = paste("Direct_", i, ".png", sep="")
   ggsave(file_name,plot,bg="white",height=10,width=10)
}

# map of indirect effects
for (i in unique(interp$Variable)) {
  resp<-filter(interp,Variable==i,Effect=="Indirect")
   nam<-paste0("Indirect",i)
    plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=resp, aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="lightgreen",high="darkgreen",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 
   #resp_plots[[i]]<-plot
   #names(resp_plots[[i]])<-nam
   setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/Pinus/Pinus Indirect")
   file_name = paste("Indirect_", i, ".png", sep="")
   ggsave(file_name,plot,bg="white",height=10,width=10)
}

full<-interp%>%
  filter(Effect=="Direct" | Effect =="Indirect")%>%
  dplyr::select(-var1.var)%>%
  pivot_wider(names_from="Effect",values_from="var1.pred")%>%
  ungroup()%>%
  #drop_na()%>%
  mutate(Full=Direct + Indirect)

# map of Full effects
for (i in unique(full$Variable)) {
  resp<-filter(full,Variable==i)
   nam<-paste0("Full",i)
    plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=resp, aes(fill = Full),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="lightgreen",high="darkgreen",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 
   #resp_plots[[i]]<-plot
   #names(resp_plots[[i]])<-nam
   setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/Pinus/Pinus Full")
   file_name = paste("Full_", i, ".png", sep="")
   ggsave(file_name,plot,bg="white",height=10,width=10)
}


# let's look at the distribution of each species' response
specs<-coefs$Species
tree_ids<-treeNames%>%
  dplyr::select(plot,Subplot,tree,species)%>%
  mutate(TREE_ID=paste(plot,Subplot,tree,sep="_"))%>%
  dplyr::select(species,TREE_ID)%>%
  filter(species%in%specs)

pineResponse<-merge(full_sf,tree_ids)




ac2<-pclim%>%
  unite(TREE_ID,Plot,Subplot,Tree,sep="_")

gcAC_pinus<-merge(growth_climate,ac2)%>%
  dplyr::select(-dGdt,-dT1dt,-dT2dt,-dT3dt,-dP1dt,-dP2dt,-dP3dt)%>%
  rename(Int=7,dia=8,dia2=9,ppt_budInit_R=10,ppt_Poll_R=11,ppt_Fert_R=12,temp_budInit_R=13,temp_Poll_R=14,temp_Fert_R=15,dia_ppt_budInit_R=16,dia_ppt_Poll_R=17,dia_ppt_Fert_R=18,dia_temp_budInit_R=19,dia_temp_Poll_R=20,dia_temp_Fert_R=21,temp_Poll=tmean_Poll,ppt_budInit=precip_budInit,temp_Fert=tmean_Fert)%>%
  
   mutate(ppt_budInit_Hi=ppt_budInit*2,ppt_budInit_Lo=ppt_budInit/2,ppt_Poll_Hi=ppt_Poll*2,ppt_Poll_Lo=ppt_Poll/2,ppt_Fert_Hi=ppt_Fert*2,ppt_Fert_Lo=ppt_Fert/2,temp_budInit_Hi=((((temp_budInit*(9/5))+32)+5.8)-32)*(5/9),temp_Poll_Hi=((((temp_Poll*(9/5))+32)+5.8)-32)*(5/9),temp_Fert_Hi=((((temp_Fert*(9/5))+32)+5.8)-32)*(5/9))%>%
  
  mutate(#P1=scale(P1),P2=scale(P2),P3=scale(P3),T1=scale(T1),T2=scale(T2),T3=scale(T3),
         
         #P1Hi=scale(P1Hi),P2Hi=scale(P2Hi),P3Hi=scale(P3Hi),P1Lo=scale(P1Lo),P2Lo=scale(P2Lo),P3Lo=scale(P3Lo),T1Hi=scale(T1Hi),T2Hi=scale(T2Hi),T3Hi=scale(T3Hi),
         
  logF_current=Int + (dia*Diameter) + (dia2*Diameter) + (ppt_budInit_R*ppt_budInit) + (ppt_Poll_R*ppt_Poll) + (ppt_Fert_R*ppt_Fert) + (temp_budInit_R*temp_budInit)+ (temp_Poll_R*temp_Poll)+ (temp_Fert_R*temp_Fert) + (dia_ppt_budInit_R*ppt_budInit*dia)+ (dia_ppt_Poll_R*ppt_Poll*dia)+ (dia_ppt_Fert_R*ppt_budInit*dia) + (dia_temp_budInit_R*temp_budInit*dia)+ (dia_temp_Poll_R*temp_Poll*dia)+ (dia_temp_Fert_R*temp_Fert*dia),
  
  logF_WW=Int + (dia*Diameter) + (dia2*Diameter) + (ppt_budInit_R*ppt_budInit_Hi) + (ppt_Poll_R*ppt_Poll_Hi) + (ppt_Fert_R*ppt_Fert_Hi) + (temp_budInit_R*temp_budInit_Hi)+ (temp_Poll_R*temp_Poll_Hi)+ (temp_Fert_R*temp_Fert_Hi) + (dia_ppt_budInit_R*ppt_budInit_Hi*dia)+ (dia_ppt_Poll_R*ppt_Poll_Hi*dia)+ (dia_ppt_Fert_R*ppt_budInit_Hi*dia) + (dia_temp_budInit_R*temp_budInit_Hi*dia)+ (dia_temp_Poll_R*temp_Poll_Hi*dia)+ (dia_temp_Fert_R*temp_Fert_Hi*dia),
  
  logF_WD=Int + (dia*Diameter) + (dia2*Diameter) + (ppt_budInit_R*ppt_budInit_Lo) + (ppt_Poll_R*ppt_Poll_Lo) + (ppt_Fert_R*ppt_Fert_Lo) + (temp_budInit_R*temp_budInit_Hi)+ (temp_Poll_R*temp_Poll_Hi)+ (temp_Fert_R*temp_Fert_Hi) + (dia_ppt_budInit_R*ppt_budInit_Lo*dia)+ (dia_ppt_Poll_R*ppt_Poll_Lo*dia)+ (dia_ppt_Fert_R*ppt_budInit_Lo*dia) + (dia_temp_budInit_R*temp_budInit_Hi*dia)+ (dia_temp_Poll_R*temp_Poll_Hi*dia)+ (dia_temp_Fert_R*temp_Fert_Hi*dia),
  
  F_current=exp(logF_current),
  F_WW=exp(logF_WW),
  F_WD=exp(logF_WD)
  )%>%
  group_by(TREE_ID)%>%
  mutate(meanF_current=mean(logF_current),meanF_WW=mean(logF_WW),meanF_WD=mean(logF_WD))

specF_pinus<-gcAC_pinus%>%
  ungroup()%>%
  dplyr::select(Species,meanF_current,meanF_WW,meanF_WD)%>%
  group_by(Species)%>%
  mutate(Fcurr=exp(meanF_current),FWW=exp(meanF_WW),FWD=exp(meanF_WD))%>%
  distinct()

ggplot(specF_pinus) +
 # geom_density(aes(x=meanF_current,fill=Species)) +
   geom_density(aes(x=meanF_current),fill="blue") +
   geom_density(aes(x=meanF_WW),fill="white") +
  geom_density(aes(x=meanF_WD),fill="orange") +
  facet_wrap(~Species,scales="free")



```

Here I use four different GCMs from CMIP6 under SSP5-8.5 and analyze the response of each tree in the FIA dataset to future climate responses. A majority of this code chunk should not be run again because it simply links the FIA data to GCM data, which is already included in an output. If other GCMs are run, then this chunk will need to be run in full.
``` {r future analysis under different GCMs}
library(ncdf4)
library(terra)
library(raster)
# let's start by bringing in the tree-level data

# let's load in the data for the trees
setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code")
load("pinus_FIA.rdata")
pineResponse<-Full
load("quercus_FIA.rdata")
oakResponse<-Full
load("Abies_FIA.rdata")
firResponse<-Full

all_response<-rbind(pineResponse,oakResponse,firResponse)%>%
  dplyr::select(TREE_ID,X,Y)%>%
  distinct()
library(sf)
ar_sf<-st_as_sf(all_response,coords=c("X","Y"))
resp_vec<-terra::vect(ar_sf)



##### DON'T RUN THIS STUFF
# precip data
k<-"CNRMprecip.nc"
  
  nc_data <- nc_open(paste0('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate/GCMs Late/',k))
  
  lon <- ncvar_get(nc_data, "lon")
    for(j in 1:length(lon)) {
       val<-lon[j]
       if(val>180) new<-(val - 360) else new <- val
       lon[j] <- new
    }
  
      lat <- ncvar_get(nc_data, "lat", verbose = F)
      p.array <- ncvar_get(nc_data, "pr") # store the data in a 3-dimensional array
      nc_close(nc_data) 
      

    mos<-c(1:3,10:12)
    yrs<-2025:2099
    names<-expand_grid(mos,yrs)%>%
      arrange(yrs,mos)%>%
      unite(Date,mos,yrs,sep="_")
    
    
out<-NULL
    for(l in 1:450) {
      p.slice <- p.array[, , l] 
      r <- raster(t(p.slice), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat), crs=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0"))
      r <- flip(r, direction='y')
  
    # convert the raster to a spatraster
p_future<-terra::rast(r)
    
name<-names[l,1]
    
future_xy<-terra::extract(p_future,resp_vec)%>%
     mutate(.,!!name,GCM=k)%>%
     rename(Precip=2)%>%
     dplyr::select(-1)%>%
     mutate(Precip=Precip*24*60*60*30)%>%
     cbind(.,all_response)%>%
  dplyr::select(TREE_ID,Date,GCM,Precip)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  distinct()
out<-rbind(out,future_xy)
    }
precip<-out
save(precip,file="CNRMprecip.rdata")


# tmin data  
k<-"HadGEM3airtemp.nc"

nc_data <- nc_open(paste0('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate/GCMs Late/',k))

lon <- ncvar_get(nc_data, "lon")
  for(j in 1:length(lon)) {
     val<-lon[j]
     if(val>180) new<-(val - 360) else new <- val
     lon[j] <- new
  }

    lat <- ncvar_get(nc_data, "lat", verbose = F)
    t.array <- ncvar_get(nc_data, "ta") # store the data in a 3-dimensional array
    nc_close(nc_data) 
    

  mos<-5:8
  yrs<-2025:2099
  names<-expand_grid(mos,yrs)%>%
    arrange(yrs,mos)%>%
    unite(Date,mos,yrs,sep="_")
  
  
  out<-NULL
  for(l in 1:300) {
    t.slice <- t.array[, , l] 
    r <- raster(t(t.slice), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat), crs=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0"))
    r <- flip(r, direction='y')

  # convert the raster to a spatraster
  t_future<-terra::rast(r)
  
  name<-names[l,1]
  
  future_xy<-terra::extract(t_future,resp_vec)%>%
   mutate(.,!!name,GCM=k)%>%
   rename(Temp=2)%>%
   dplyr::select(-1)%>%
   mutate(Temp=Temp-273.15)%>%
   cbind(.,all_response)
 out<-rbind(out,future_xy)
  }
temp<-out%>%
  drop_na()
save(temp,file="HadGEM3temp.rdata")





load("HadGEM3precip.rdata")
load("HadGEM3temp.rdata")


temp<-temp%>%
  dplyr::select(TREE_ID,Date,Temp)%>%
  distinct()

allT<-temp%>%
  group_by(TREE_ID,Date)%>%
  mutate(Temp=mean(Temp))%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  dplyr::select(-Month)%>%
  distinct()


# OK, now let's load in some PRISM 30year mean data
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
mon<-c(1:3,10:12)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("ppt", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(ar_sf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Precip=2)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_p<-EXT_df%>%
    dplyr::select(TREE_ID,Precip)%>%
    distinct()%>%
    group_by(TREE_ID)%>%
    mutate(Norm_p=sum(Precip))%>%
    dplyr::select(-Precip)%>%
    distinct()
    
  
  
  

temp<-data.frame(NULL)
library(prism)
mon<-c(5:8)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("tmean", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(ar_sf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Temp=2)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_t<-EXT_df%>%
    dplyr::select(TREE_ID,Temp)%>%
    rename(Norm_t=Temp)%>%
    group_by(TREE_ID)%>%
    mutate(Norm_t=mean(Norm_t))%>%
    distinct()

#normals<-full_join(normal_t,normal_p)
  

outP<-full_join(precip,normal_p)
outT<-full_join(allT,normal_t)



outP$Year<-as.numeric(outP$Year)
outT$Year<-as.numeric(outT$Year)


outP<-outP%>%
  arrange(Year,Month,TREE_ID)%>%
  mutate(Year=ifelse(Month%in%c(10,11,12),Year+1,Year))%>%
  group_by(Year,TREE_ID)%>%
  mutate(totPrecip=sum(Precip),deltaP=totPrecip-Norm_p)%>%
  group_by(TREE_ID)%>%
  dplyr::select(TREE_ID,Year,Norm_p,totPrecip,deltaP)


outT<-outT%>%
  drop_na()%>%
  group_by(Year,TREE_ID)%>%
  mutate(deltaT=Temp-Norm_t)%>%
  group_by(TREE_ID)%>%
  dplyr::select(TREE_ID,Year,Norm_t,Temp,deltaT)

#load("HadGEM3temp_futures.rdata")


precip_temp<-full_join(outP,outT)%>%
  drop_na()%>%
  distinct()

save(precip_temp,file="HadGEM3_allfutures.rdata")






###### START HERE #####
load("MIROC_allfutures.rdata")

#precip_temp<-HG3T2

# load in FIA data to get species names
dir<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA"
#CA_FIA <- getFIA(states = 'CA', dir = dir,load=TRUE) # use this code to get most updated FIA data
CA_FIA<-readFIA(dir) # read in data from directory


#CA_recent<-clipFIA(CA_FIA) # this gets most recent data
tpa_polysSF <- tpa(CA_FIA,treeType="live",treeDomain = SPCD==122,byPlot=TRUE,returnSpatial = TRUE) # filter out just PIPO and make it a spatial object, only gives trees per acre
plot(tpa_polysSF) # testplot of trees per acre

plot.list<-data.frame(Plot=CA_FIA$PLOT$PLOT,Unit=CA_FIA$PLOT$UNITCD,County=CA_FIA$PLOT$COUNTYCD,STATE=CA_FIA$PLOT$STATECD,UTMy=CA_FIA$PLOT$LAT,UTMx=CA_FIA$PLOT$LON)%>%
  unite(PLOT,Plot,Unit,County,STATE,sep="_")%>%
  rename(Plot=PLOT)%>%
  distinct()

tree.list <- data.frame(Year=CA_FIA$TREE$INVYR,Plot=CA_FIA$TREE$PLOT,Unit=CA_FIA$TREE$UNITCD,County=CA_FIA$TREE$COUNTYCD,STATE=CA_FIA$TREE$STATECD,Subplot=CA_FIA$TREE$SUBP,Tree=CA_FIA$TREE$TREE,Diameter=CA_FIA$TREE$DIA,SPCD=CA_FIA$TREE$SPCD,SHADE=CA_FIA$TREE$CLIGHTCD,canopy=CA_FIA$TREE$CCLCD)%>%
  unite(PLOT,Plot,Unit,County,STATE,sep="_")%>%
  rename(Plot=PLOT)%>%
  distinct()

PLOT_TREE<-merge(plot.list,tree.list)


# ok, let's predict some shade classes now
sp_names<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA/SPC_ID.csv")%>%
  dplyr::select(SPCD,SCI_NAME)

treeNames<-merge(PLOT_TREE,sp_names)%>% # merge tree spatial object and names list
  rename(species=SCI_NAME)%>%
  rename(diam=Diameter,shade=SHADE,plot=Plot,tree=Tree)%>%
  unite(TREE_ID,plot,Subplot,tree,sep="_")%>%
  dplyr::select(TREE_ID,diam,species)%>%
  group_by(TREE_ID)%>%
  mutate(Diam=max(diam))%>%
  dplyr::select(-diam)%>%
  distinct()


# merge in data with the names
HG_names<-full_join(precip_temp,treeNames)%>%
  drop_na()





pines<-c("Pinus contorta","Pinus ponderosa","Pinus jeffreyi","Pinus lambertiana","Pinus monticola")
firs<-c("Abies concolor","Abies magnifica","Abies grandis")
oaks<-c("Quercus chrysolepis","Quercus kelloggii","Quercus agrifolia")
specs<-rbind(pines,firs,oaks)

hg_p<-HG_names%>%
  filter(species%in%specs)
rm(HG_names,precip_temp)




out<-NULL

l3<-NULL
for(i in 2028:2099) {
  P3<-filter(hg_p,Year==i-3)%>%
    mutate(Year=i)%>%
    rename(P3=deltaP)%>%
    dplyr::select(TREE_ID,Year,P3)%>%
    distinct()
   T3<-filter(hg_p,Year==i-3)%>%
    mutate(Year=i)%>%
    group_by(TREE_ID)%>%
    mutate(T3=mean(deltaT))%>%
    dplyr::select(species,TREE_ID,Year,T3,deltaP,deltaT)%>%
    distinct()
   clim3<-merge(P3,T3)
   l3<-rbind(l3,clim3)
}
save(l3,file="allspp_lag3.rdata")
rm(l3,P3,T3)
   
l2<-NULL
for(i in 2028:2099) {
  P2<-filter(hg_p,Year==i-2)%>%
    mutate(Year=i)%>%
    rename(P2=deltaP)%>%
    dplyr::select(TREE_ID,Year,P2)%>%
    distinct()
   T2<-filter(hg_p,Year==i-2)%>%
    mutate(Year=i)%>%
    group_by(TREE_ID)%>%
    mutate(T2=mean(deltaT))%>%
    dplyr::select(species,TREE_ID,Year,T2)%>%
    distinct()
   clim2<-merge(P2,T2)
   l2<-rbind(l2,clim2)
}
save(l2,file="allspp_lag2.rdata")
rm(l2,P2,T2)
   
l1<-NULL
for(i in 2028:2099) {
  P1<-filter(hg_p,Year==i-1)%>%
    mutate(Year=i)%>%
    rename(P1=deltaP)%>%
    dplyr::select(TREE_ID,Year,P1)%>%
    distinct()
   T1<-filter(hg_p,Year==i-1)%>%
    mutate(Year=i)%>%
    group_by(TREE_ID)%>%
    mutate(T1=mean(deltaT))%>%
    dplyr::select(species,TREE_ID,Year,T1)%>%
    distinct()
   clim1<-merge(P1,T1)
   l1<-rbind(l1,clim1)
}
save(l1,file="allspp_lag1.rdata")
rm(P1,T1,l1)

l0<-NULL
for(i in 2028:2099) {
  P0<-filter(hg_p,Year==i)%>%
    mutate(Year=i)%>%
    rename(P0=deltaP)%>%
    dplyr::select(TREE_ID,Year,P0)%>%
    distinct()
   T0<-filter(hg_p,Year==i)%>%
    mutate(Year=i)%>%
    group_by(TREE_ID)%>%
    mutate(T0=mean(deltaT))%>%
    dplyr::select(species,TREE_ID,Year,T0)%>%
    distinct()
   clim0<-merge(P0,T0)
   l0<-rbind(l0,clim0)
}
save(l0,file="allspp_lag0.rdata")
rm(l0,P0,T0,hg_p)

load("allspp_lag0.rdata")
load("allspp_lag1.rdata")
load("allspp_lag3.rdata")
load("allspp_lag2.rdata")

allpine<-merge(l1,l2)%>%
  merge(.,l3)%>%
  merge(.,l0)

rm(l1,l2,l3,l0)
save(allpine,file="MIROC6allspp.rdata")




load("HadGEM3allspp.rdata")
load("HadGEM3_allfutures.rdata")
pt<-precip_temp%>%
  dplyr::select(TREE_ID,Norm_p,Norm_t)%>%
  distinct()

# read in all of the coefficients
pines<-read.csv('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/Pinus MASTIF Output (deviation climate)/pinus_betas.csv')%>%
  mutate(X=gsub("species","",X))%>%
  separate(X,c('Species','var1','var2'),sep=":")%>%
  mutate(var1=ifelse(is.na(var1)==TRUE,"Intercept",var1),var2=ifelse(is.na(var2)==TRUE," ",var2))%>%
    filter(var1!="shade",var2!="shade")%>%
  mutate(Species=tolower(Species),Species=gsub("pinus","Pinus ",Species),Species=ifelse(Species=="Pinus contorta","Pinus contorta",ifelse(Species=="Pinus jeffreyi", "Pinus jeffreyi",ifelse(Species=="Pinus lamberti","Pinus lambertiana",ifelse(Species=="Pinus monticol","Pinus monticola","Pinus ponderosa")))))%>%
  mutate(beta_obs=ifelse(sig95=="*",estimate,0),interaction=paste(var1,var2,sep=":"))%>%
  dplyr::select(Species,interaction,beta_obs)%>%
  pivot_wider(names_from=interaction,values_from=beta_obs)%>%
  rename(Int=2,dia=3,dia2=4,P_3=5,T_3=6,P_2=7,T_2=8,P_1=9,T_1=10,diam_P3=11,diam_T3=12,diam_P2=13,diam_T2=14,diam_P1=15,diam_T1=16,species=Species)


firs<-read.csv('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/Abies MASTIF Output (deviation climate)/abies_betas.csv')%>%
  mutate(X=gsub("species","",X))%>%
  separate(X,c('Species','var1','var2'),sep=":")%>%
  mutate(var1=ifelse(is.na(var1)==TRUE,"Intercept",var1),var2=ifelse(is.na(var2)==TRUE," ",var2))%>%
    filter(var1!="shade",var2!="shade")%>%
  mutate(Species=tolower(Species),Species=gsub("abies","Abies ",Species),Species=ifelse(Species=="Abies concolor","Abies concolor",ifelse(Species=="Abies magnific","Abies magnifica",ifelse(Species=="Abies lasiocar","Abies lasiocarpa",Species))))%>%
  mutate(beta_obs=estimate,interaction=paste(var1,var2,sep=":"))%>%
  dplyr::select(Species,interaction,beta_obs)%>%
  pivot_wider(names_from=interaction,values_from=beta_obs)%>%
  rename(Int=2,dia=3,dia2=4,P_0=5,T_0=6,P_1=7,T_1=8, diam_P0=9, diam_T0=10,diam_P1=11,diam_T1=12,species=Species)


oaks<-read.csv('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/Quercus MASTIF Output (deviation climate)/quercus_betas.csv')%>%
  mutate(X=gsub("species","",X))%>%
  separate(X,c('Species','var1','var2'),sep=":")%>%
  mutate(var1=ifelse(is.na(var1)==TRUE,"Intercept",var1),var2=ifelse(is.na(var2)==TRUE," ",var2))%>%
    filter(var1!="shade",var2!="shade")%>%
  mutate(Species=tolower(Species),Species=gsub("quercus","Quercus ",Species),Species=ifelse(Species=="Quercus chrysole","Quercus chrysolepis",ifelse(Species== "Quercus kelloggi","Quercus kelloggii","Quercus agrifolia")))%>%
  mutate(beta_obs=estimate,interaction=paste(var1,var2,sep=":"))%>%
  dplyr::select(Species,interaction,beta_obs)%>%
  pivot_wider(names_from=interaction,values_from=beta_obs)%>%
  rename(Int=2,dia=3,dia2=4,P_3=5,T_3=6,P_2=7,T_2=8,P_1=9,T_1=10,diam_P3=11,diam_T3=12,diam_P2=13,diam_T2=14,diam_P1=15,diam_T1=16,species=Species)




ps<-c("Pinus contorta","Pinus lambertiana","Pinus ponderosa","Pinus monticola","Pinus ponderosa","Pinus jeffreyi")
fs<-c("Abies concolor","Abies magnifica","Abies grandis")
os<-c("Quercus chrysolepis","Quercus kelloggii","Quercus agrifolia")

HGpine<-allpine%>%
  filter(species%in%ps)%>%
  full_join(.,pines)%>%
  full_join(.,treeNames)%>%
  merge(.,pt)%>%
  mutate(P0=scale(P0),P1=scale(P1),P2=scale(P2),P3=scale(P3),T0=scale(T0),T1=scale(T1),T2=scale(T2),T3=scale(T3))

HGoak<-allpine%>%
  filter(species%in%os)%>%
  full_join(.,oaks)%>%
  full_join(.,treeNames)%>%
  merge(.,pt)%>%
  mutate(P0=scale(P0),P1=scale(P1),P2=scale(P2),P3=scale(P3),T0=scale(T0),T1=scale(T1),T2=scale(T2),T3=scale(T3))

HGfir<-allpine%>%
  filter(species%in%fs)%>%
  full_join(.,firs)%>%
  full_join(.,treeNames)%>%
  merge(.,pt)%>%
  mutate(P0=scale(P0),P1=scale(P1),P2=scale(P2),P3=scale(P3),T0=scale(T0),T1=scale(T1),T2=scale(T2),T3=scale(T3))

pineOut<-HGpine%>%
    #rename(T_3=15,P_2=16)%>%
  mutate(
    logF= Int + (dia*Diam) + (dia2*Diam) + (P1*P_1) + (P2*P_2) + (P3*P_3) + (T1*T_1)+ (T2*T_2)+ (T3*T_3) + (diam_P1*P1*Diam)+ (diam_P2*P2*Diam)+ (diam_P3*P3*Diam) + (diam_T1*T1*Diam)+ (diam_T2*T2*Diam)+ (diam_T3*T3*Diam)
  )%>%
  #full_join(.,ratios)%>%
  dplyr::select(Year,TREE_ID,Norm_p,Norm_t,deltaP,deltaT,species,logF)%>%
  distinct()%>%
  drop_na()


firOut<-HGfir%>%
  mutate(
    logF= Int + (dia*Diam) + (dia2*Diam) + (P0*P_0) + (P1*P_1) +  (T0*T_0)+ (T1*T_1)+ (diam_P1*P1*Diam)+ (diam_P0*P0*Diam)+ (diam_T1*T1*Diam)+ (diam_T0*T0*Diam)
  )%>%
  dplyr::select(Year,TREE_ID,Norm_p,Norm_t,deltaP,deltaT,species,logF)%>%
  distinct()%>%
  drop_na()

oakOut<-HGoak%>%
    #rename(T_3=15,P_2=16)%>%
  mutate(
    logF= Int + (dia*Diam) + (dia2*Diam) + (P1*P_1) + (P2*P_2) + (P3*P_3) + (T1*T_1)+ (T2*T_2)+ (T3*T_3) + (diam_P1*P1*Diam)+ (diam_P2*P2*Diam)+ (diam_P3*P3*Diam) + (diam_T1*T1*Diam)+ (diam_T2*T2*Diam)+ (diam_T3*T3*Diam)
  )%>%
  #full_join(.,ratios)%>%
  dplyr::select(Year,TREE_ID,Norm_p,Norm_t,deltaP,deltaT,species,logF)%>%
  distinct()%>%
  drop_na()


HadGEM3<-rbind(pineOut,firOut,oakOut)%>%
  mutate(GCM="HadGEM3")


save(HadGEM3,file="allHadGEM3.rdata")


load("allMIROC6.rdata")
load("allCanESM.rdata")
load("allCNRM.rdata")
load("allHadGEM3.rdata")


allGCM<-rbind(CNRM,HadGEM3,CanESM,MIROC6)%>%
  distinct()

sem <- function(x){
  sd(x)/sqrt(length(x))
}

gcm_time<-allGCM%>%
  group_by(species,Year)%>%
  mutate(avgDP=mean(deltaP),avgDT=mean(deltaT),semDP=sem(deltaP),semDT=sem(deltaT))%>%
  dplyr::select(GCM,Year,avgDP,avgDT,semDP,semDT,logF)%>%
  distinct()

fecundity_future<-allGCM%>%
  group_by(species,Year)%>%
  mutate(meanF=mean(logF))%>%
  dplyr::select(species,Year,meanF)%>%
  distinct()
  
# DO LINEAR MODEL
specs2<-fecundity_future%>%
  group_by(species)%>%
  do(P=summary(lm(meanF~Year,data=.))[[4]][2,4])%>%
  dplyr::select(species,P)%>%
  drop_na()%>%
  mutate(P=round(as.numeric(P),3),P=ifelse(P<0.001,"<0.001",P))

# DO LINEAR MODEL
specs_coefs<-fecundity_future%>%
  group_by(species)%>%
  do(coef=lm(meanF~Year,data=.)$coefficients[[2]])%>%
  dplyr::select(species,coef)%>%
  drop_na()%>%
  mutate(newcoef=as.numeric(coef)/100)

specs_Ps<-fecundity_future%>%
  group_by(species)%>%
  do(P=summary(lm(meanF~Year,data=.))[[4]][2,4])%>%
  dplyr::select(species,P)%>%
  drop_na()%>%
  mutate(P=as.numeric(P),P=ifelse(P<0.05,"*","n.s."))

res<-merge(specs_coefs,specs_Ps)%>%
  dplyr::select(species,newcoef,P)

fecundity_future<-merge(fecundity_future,res)%>%
  group_by(species)%>%
  mutate(Pxpos=2027,Pypos=ifelse(max(meanF)>0,max(meanF)-(max(meanF)*0.03),max(meanF)-abs((max(meanF))*0.3)))


fec_future<-ggplot(fecundity_future,aes(Year,meanF,color=species,group=species)) +
  geom_line() +
  geom_smooth(method="lm",color="black",alpha=0.25) +
  theme_minimal()+
  geom_text(aes(x=Pxpos,y=Pypos,label=P),color="black",size=12) +
  labs(x="Year",y="Predicted Fecundity (log scale)") +
  theme(legend.position="none",text=element_text(size=35)) +
  facet_wrap(~species,scales="free",ncol=1) +
  ylab("")


dp_time<-ggplot(gcm_time,aes(Year,avgDP,color=species)) +
  #geom_point() +
  geom_smooth(method="lm") +
  theme_minimal()

dt_time<-ggplot(gcm_time,aes(Year,avgDT,color=species)) +
  #geom_point() +
  geom_smooth(method="lm") +
  theme_minimal()


futures<-ggpubr::ggarrange(fec_time,fec_future,ncol=2,labels=c("A","B"),font.label=list(size=40))
ggsave("Fig3.png",futures,bg="white",dpi=300,height=35,width=20)


ftime_mod<-fecundity_future%>%
  group_by(species)%>%
  do(mo=(lm(meanF~Year,data=.)$coefficients))%>%
  mutate(dFdt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  full_join(.,allPC)%>%
  full_join(.,hgspec)%>%
  distinct()%>%
  drop_na()%>%
  group_by(TREE_ID)%>%
  mutate(meandF=mean(dFdt))%>%
  dplyr::select(species,PC,meandF)%>%
  distinct()

future_time<-ggarrange(dp_time,dt_time,F_time,ncol=3,labels=c("A","B","C"),common.legend = TRUE)
ggsave("future_time.png",future_time,bg="white",width=12,height=10)



allGCM_new<-allGCM%>%
  group_by(GCM,Year)%>%
  mutate(avgDP=mean(deltaP),avgDT=mean(deltaT),semDP=sem(deltaP),semDT=sem(deltaT))%>%
  dplyr::select(GCM,Year,avgDP,avgDT,semDP,semDT)%>%
  distinct()

DP_plot<-ggplot(allGCM_new,aes(Year,avgDP,color=GCM,group=GCM)) +
  geom_line() +
  theme_minimal() +
  scale_color_colorblind() +
  labs(y="Precipitation Difference from 30yr Normal",x="") +
  theme(legend.title=element_blank(),axis.text.x=element_blank(),plot.margin = unit(c(0,0.2,0,1), 'lines'),axis.text.y=element_text(angle=90),axis.text=element_text(size=15),axis.title=element_text(size=13),legend.text=element_text(size=15),text=element_text(size=17))

DT_plot<-ggplot(allGCM_new,aes(Year,avgDT,color=GCM,group=GCM)) +
  geom_line() +
  theme_minimal() +
  scale_color_colorblind() +
  labs(y="Temperature Difference from 30yr Normal")+
  theme(legend.title=element_blank(),plot.margin = unit(c(0,0.2,0,1), 'lines'),axis.text.y=element_text(angle=90),axis.text=element_text(size=15),axis.title=element_text(size=13),legend.text=element_text(size=15),text=element_text(size=17))

DPDT<-ggarrange(DP_plot,DT_plot,ncol=1,labels=c("C","D"),common.legend=TRUE)

ggsave("suppFig_futuretime.png",DPDT,bg="white",dpi=300,height=15,width=15)
  

allGCM_new<-allGCM%>%
  group_by(GCM)%>%
  mutate(avgDP=mean(deltaP),avgDT=mean(deltaT),semDP=sem(deltaP),semDT=sem(deltaT))%>%
  dplyr::select(GCM,Year,avgDP,avgDT,semDP,semDT)%>%
  distinct()

DP_bar<-ggplot(allGCM_new,aes(GCM,avgDP,fill=GCM)) +
  geom_bar(stat="summary") +
  geom_errorbar(aes(ymin=avgDP-semDP,ymax=avgDP+semDP),width=0) +
  theme_minimal() +
  scale_fill_colorblind() +
  labs(y="Average Precipitation Difference from 30yr Normal",x="") +
  theme(legend.title=element_blank(),axis.text.x=element_blank(),plot.margin = unit(c(0,0.2,0,1), 'lines'),axis.text.y=element_text(angle=90),axis.text=element_text(size=15),axis.title=element_text(size=13),legend.text=element_text(size=15))

DT_bar<-ggplot(allGCM_new,aes(GCM,avgDT,fill=GCM)) +
  geom_bar(stat="summary") +
  geom_errorbar(aes(ymin=avgDT-semDT,ymax=avgDT+semDT),width=0) +
  theme_minimal() +
  scale_fill_colorblind() +
  labs(y="Average Temperature Difference from 30yr Normal",x="") +
  theme(legend.title=element_blank(),axis.text.x=element_blank(),plot.margin = unit(c(0,0.2,0,1), 'lines'),axis.text.y=element_text(angle=90),axis.text=element_text(size=15),axis.title=element_text(size=13),legend.text=element_text(size=15))

gcm_plot<-ggarrange(DP_plot,DT_plot,ncol=1,labels=c("A","B"),legend=NULL)
gcm_bars<-ggarrange(DP_bar,DT_bar,ncol=1,labels=c("C","D"),common.legend=TRUE)
allgcms<-ggarrange(gcm_plot,gcm_bars,ncol=2,common.legend=TRUE)

ggsave("future_timeseries.png",allgcms,dpi=300,bg="white",height=10,width=10)



af2<-allFutures2%>%
  dplyr::select(TREE_ID,logF_current)%>%
  distinct()

save(af2,file="allfutures.rdata")

allGCM2<-full_join(allGCM,af2)%>%
  mutate(dF=logF-logF_current)

# pca with climate normals
load("HadGEM3_allfutures.rdata")
hadgem<-precip_temp%>%
  dplyr::select(TREE_ID,Norm_p,Norm_t)%>%
  distinct()

ag<-allGCM%>%
  dplyr::select(TREE_ID,species)%>%
  distinct

hgspec<-full_join(hadgem,ag)%>%
  dplyr::select(species,TREE_ID,Norm_p,Norm_t)%>%
  distinct()%>%
  rename(P=Norm_p,T=Norm_t)%>%
  drop_na()


norm_pca<-prcomp(hgspec[,3:4],scale.=TRUE,center=TRUE)

summary(norm_pca)
library(ggbiplot)
library(colorspace)

pca_plot<-ggbiplot(norm_pca,alpha=0,varname.size=5,varname.adjust=2,groups=hgspec$species,ellipse = TRUE,ellipse.alpha=0.0001,ellipse.linewidth=0.5) +
  scale_color_brewer(type="qual",palette = "RdYlBu")+
  theme_minimal() +
  lims(x=c(-2,2),y=c(-2,2)) +
  labs(x="PC1 (57.6%)", y="PC2 (42.3%)") +
  theme(legend.title=element_blank(),legend.text=element_text(size=15),axis.text=element_text(size=15),axis.title=element_text(size=15),legend.position="none")
#ggsave("PCAplot.png",pca_plot,bg="white",dpi=300,height=10,width=10)

# decreasing PC1 is warmer growing season / wetter winters and increasing is cooler growing season, drier winter

PC1<-data.frame(res=norm_pca[["rotation"]])%>%
  dplyr::select(1)%>%
  rename(PC1=1)


allPC<-hgspec%>%
  mutate(PC=P*PC1[1,]+T*PC1[2,])%>%
  dplyr::select(species,TREE_ID,PC)%>%
  group_by(species)%>%
  mutate(PC=scale(PC))

allGCM2<-allGCM%>%
  #filter(Year%in%c(2050:2099))%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(logF~Year,data=.)$coefficients))%>%
  mutate(dFdt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  full_join(.,allPC)%>%
  full_join(.,hgspec)%>%
  distinct()%>%
  drop_na()%>%
  group_by(TREE_ID)%>%
  mutate(meandF=mean(dFdt))

pc_reg<-allGCM2%>%
  group_by(species)%>%
  do(mo=(lm(dFdt~PC,data=.)$coefficients))%>%
  mutate(ddFdt=mo[[2]])
  

ag2<-allGCM2%>%
  group_by(P,T)%>%
  mutate(avg=mean(meandF))%>%
  dplyr::select(-meandF,-TREE_ID,-species)%>%
  distinct()


t<-with(ag2, interp(x = scale(P), y = scale(T), z = avg, nx = 500, ny = 500,linear=FALSE,extrap=FALSE)) |>
  interp2xyz() |>
  as.data.frame() |>
  ggplot(aes(x = x, y = y, z = z)) +
  geom_contour_filled(aes(fill = after_stat(level_mid)), bins = 17) +
  scale_fill_stepsn(NULL, n.breaks = 5,
                    colors = c('#ffffc8', '#f6b732', '#c52300', '#7d0025'),
                    labels = ~ifelse(.x %% 2 == 0, .x, '')) +
  theme_bw() +
  theme(legend.key.height = unit(10, 'mm'))



library(grid)
dryText <- textGrob("Cooler & Drier", gp=gpar(fontsize=15, fontface="italic"))
wetText <- textGrob("Warmer & Wetter", gp=gpar(fontsize=15, fontface="italic"))

future_plot<-ggplot(allGCM2,aes((PC),(meandF),color=species)) +
  #geom_point(alpha=0.1) +
  geom_smooth(method="lm") +
  geom_smooth(data=allGCM2,aes(PC,meandF),color="black",linetype="dashed",method="lm")+
  
  labs(x="", y = "Rate of Fecundity Change (2028 - 2099)") +
  #ylim(-5,.2) +
  scale_color_brewer(type="qual",palette = "RdYlBu")+
  #scale_color_tableau(palette="Tableau 20") +
  theme_minimal()+
  theme(legend.title=element_blank(),legend.text=element_text(size=15),axis.text.y=element_text(size=15),axis.title=element_text(size=15),axis.text.x=element)+
  annotation_custom(wetText,xmin=5.5,xmax=6.5,ymin=-5.9,ymax=-5.9) +
  annotation_custom(dryText,xmin=-1.7,xmax=-.7,ymin=-5.9,ymax=-5.9) +
  coord_cartesian(clip="off")

# make the figure of fecundity change with PC under each GCM
allGCM3<-allGCM%>%
  #filter(Year%in%c(2050:2099))%>%
  group_by(TREE_ID,GCM)%>%
  do(mo=(lm(logF~Year,data=.)$coefficients))%>%
  mutate(dFdt=mo[[2]])%>%
  dplyr::select(-mo)%>%
  full_join(.,allPC)%>%
  full_join(.,hgspec)%>%
  distinct()%>%
  drop_na()%>%
  group_by(TREE_ID)%>%
  mutate(meandF=mean(dFdt))%>%
  dplyr::select(species,PC,GCM,meandF)%>%
  distinct()

gcm_pc<-ggplot(allGCM3,aes((PC),(meandF),color=GCM)) +
  #geom_point(alpha=0.05) +
  geom_smooth(method="lm") +
  #geom_smooth(data=allGCM2,aes(PC,meandF),color="black",linetype="dashed",method="lm")+
  labs(x="PC1 Score", y = "Rate of Fecundity Change (2028 - 2099)") +
  scale_color_colorblind() +
  theme_minimal()+
  theme(legend.title=element_blank(),legend.text=element_text(size=15),axis.text=element_text(size=15),axis.title=element_text(size=15),axis.title.y=element_blank())+
  annotation_custom(wetText,xmin=5.5,xmax=6.5,ymin=.0086,ymax=.0086) +
  annotation_custom(dryText,xmin=-1.7,xmax=-.7,ymin=.0086,ymax=.0086) +
  coord_cartesian(clip="off")

gcm3<-allGCM2%>%
  group_by(species)%>%
  mutate(meanRate=mean(meandF),semRate=sem(meandF))%>%
  dplyr::select(species,meanRate,semRate)%>%
  distinct()

rateBars<-ggplot(gcm3,aes(species,meanRate,fill=species)) +
  geom_bar(stat="identity") +
  geom_errorbar(data=gcm3,width=0,aes(ymin=meanRate+semRate,ymax=meanRate-semRate))+
  scale_fill_brewer(type="qual",palette = "RdYlBu")+
  theme_minimal()+
  ylab("Average Change in Fecundity (2028 - 2099)") +
  xlab("") +
  theme(legend.title=element_blank(),legend.text=element_text(size=15),axis.text=element_text(size=15),axis.title=element_text(size=15),axis.text.x=element_text(angle=90))


rateBars<- rateBars + theme(legend.position="none")


fig4<-egg::ggarrange(plots=list(pca_plot,future_plot,rateBars,gcm_pc),ncol=2,nrow=2,labels=c("A","B","C","D"))

ggsave("figure4.png",fig4,bg="white",dpi=300,height=15,width=15)




 
topFig<-ggarrange(F_time,future_plot,ncol=2,labels=c("A","B"),common.legend=TRUE)
bottomFig<-ggarrange(rateBars,pca_plot,ncol=2,labels=c("C","D"))
fullFig<-ggarrange(topFig,bottomFig,nrow=2,common.legend=TRUE)

ggsave("fullFig.png",fullFig,bg="white",dpi=300,width=12,height=12)


future_plotP<-ggplot(allGCM2,aes(P,(dFdt),color=GCM)) +
  #geom_point(alpha=0.01) +
  geom_smooth(method="lm") +
  geom_smooth(data=allGCM2,aes(P,meandF),color="blue",linetype="dashed",method="lm")+
  labs(x="30yr Normal October - April Precipitation (mm)", y = "Rate of Fecundity Change (2028 - 2099)") +
  scale_color_colorblind() +
  theme_minimal()+
  theme(legend.title=element_blank(),legend.text=element_text(size=15),legend.position="top",axis.text=element_text(size=15),axis.title=element_text(size=15))
  #annotation_custom(dryText,xmin=1,xmax=2,ymin=-5.4,ymax=-5.4) +
  #annotation_custom(wetText,xmin=-6.2,xmax=-5.2,ymin=-5.4,ymax=-5.4) +
  #coord_cartesian(clip="off")

future_plotT<-ggplot(allGCM2,aes(T,dFdt,color=GCM)) +
  #geom_point(alpha=0.01) +
  geom_smooth(method="lm") +
  geom_smooth(data=allGCM2,aes(T,meandF),color="blue",linetype="dashed",method="lm")+
  labs(x="Growing Season Temperature (C)", y = "") +
  scale_color_colorblind() +
  theme_minimal()+ 
  theme(legend.title=element_blank(),legend.text=element_text(size=15),legend.position="top",axis.text.y=element_blank(),axis.text=element_text(size=15),axis.title=element_text(size=15))
  #annotation_custom(dryText,xmin=1,xmax=2,ymin=-5.4,ymax=-5.4) +
  #annotation_custom(wetText,xmin=-6.2,xmax=-5.2,ymin=-5.4,ymax=-5.4) +
  #coord_cartesian(clip="off")


future_plotPT<-ggarrange(future_plotP,future_plotT,labels=c("A","B"),common.legend=TRUE)

#ggsave("future_plot.png",future_plot,bg="white")



library(cowplot)

futures<-ggdraw()+
  draw_plot(future_plot)+
  draw_plot(pca_plot,height=.32,x=.3,y=.1)

allFutures<-ggarrange(future_plotP,future_plotT,future_plot,common.legend=TRUE,labels=c("A","B","C"),nrow=1,widths=c(1,1,1.2))

ggsave("futures.png",allFutures,bg="white",dpi=300,width=18,height=10)


#ggsave(plot=future_plot,file="pinusFuture.png",bg="white")



# mapping dFdt
treeNames2<-merge(PLOT_TREE,sp_names)%>% # merge tree spatial object and names list
  rename(species=SCI_NAME)%>%
  rename(diam=Diameter,shade=SHADE,plot=Plot,tree=Tree)%>%
  unite(TREE_ID,plot,Subplot,tree,sep="_")%>%
  dplyr::select(TREE_ID,species,UTMx,UTMy)%>%
  rename(X=UTMx,Y=UTMy)%>%
  distinct()%>%
  mutate(Genus=sub(" .*", "", species))%>%
  filter(Genus%in%c("Quercus","Abies","Pinus"),species%in%specs2$species)


allGCM2<-allGCM%>%
  #filter(Year%in%c(2050:2099))%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(logF~Year,data=.)$coefficients))%>%
  mutate(dFdt=mo[[2]])%>%
  dplyr::select(-mo)


delta_f<-merge(treeNames2,allGCM2)

df_sf<-st_as_sf(delta_f,coords=c("X","Y"))%>%
  drop_na()


library(tigris) # package for CA maps
library(raster)
ca<-states(keep_zipped_shapefile=TRUE)%>%
  filter(NAME=="California")%>%
  dplyr::select(NAME,INTPTLAT,INTPTLON)%>%
  rename(LAT=2,LON=3)
ca$LON<-as.numeric(ca$LON)
ca$LAT<-as.numeric(ca$LAT)

grid <- ca%>%
  sf::st_make_grid(cellsize = 0.05, what = "polygons",square=TRUE) %>%
  sf::st_intersection(ca) %>% 
  sf::st_sf(grid_id = 1:length(.))
sf::sf_use_s2(FALSE)

library(gstat)
st_crs(df_sf)<-st_crs(grid)
res<-NULL
for(i in unique(df_sf$species)) {
  dat<-filter(df_sf,species==i)
  interp<-idw(dFdt~1,df_sf,grid,nmax=5,maxdist=5)%>%
   rename(dFdt=3)%>%
    mutate(Species=i,Genus=unique(dat$Genus))
res<-rbind(res,interp)
}

res1<-res%>%
  dplyr::select(-var1.var)%>%
  drop_na()%>%
  distinct()


delta_f_arr<-delta_f%>%
  arrange(desc(dFdt))
  
df_map<-ggplot() +
    geom_sf(data=ca,fill="white") +
    #geom_sf(data=res1, aes(fill = dFdt),color=NA) + 
   geom_point(data=delta_f_arr,aes(X,Y,color=dFdt),size=3,alpha=1) +
  scale_color_brewer(type="div",palette="BrBG") +
    #scale_color_gradient2(low="#DDE182",mid="#C5C9D2",high="#0254C2",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x=" ",y=" ") +
    theme_minimal() +
    theme(legend.title=element_blank(),text=element_text(size=20),legend.position="top",legend.key.size = unit(1, 'cm'),axis.text=element_blank()) 

library(ggh4x)

design <- c(
"
AABBCCDD
EEFFGGHH
#IIJJKK#
"
)

new_df_map<-df_map + ggh4x::facet_manual(~species, design = design,remove_labels="x")

ggsave("Fig5.png",new_df_map,bg="white",dpi=900,width = 16000, height = 14000, units = "px")

```

This figure creates a heatmap of the trend attribution results i.e. Figure 1 in Thompson et al. 
``` {r heatmap figure}
# let's look at the distribution of each species' response
setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code")
load("pinus_FIA.rdata")
pineResponse<-Full
load("quercus_FIA.rdata")
oakResponse<-Full
load("Abies_FIA.rdata")
firResponse<-Full


all_response<-rbind(pineResponse,oakResponse,firResponse)
#save(all_response,file="PineFirOak.rdata")

ar2<-all_response%>%
  dplyr::select(Variable,Full_Effect,X,Y)

plist<-NULL
for (i in unique(ar2$Variable)) {
  
  resp<-filter(ar2,Variable==i)
  resp<-st_as_sf(resp,coords=c("X","Y"))
  st_crs(resp)<-st_crs(grid)
  iAll <- idw(Full_Effect~1, resp, grid,nmax=5,maxdist=5)
  
   nam<-paste0("mean",i)
    plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=iAll, aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="yellow",high="blue",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 
   #resp_plots[[i]]<-plot
   #names(resp_plots[[i]])<-nam
   setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/All")
   file_name = paste("mean_", i, ".png", sep="")
   ggsave(file_name,plot,bg="white",height=10,width=10)
   plist[[i]]<-plot
}


resp<-ar2%>%
    group_by(Variable)%>%
    mutate(Full_scale=scale(Full_Effect))%>%
  ungroup()%>%
    group_by(X,Y)%>%
    mutate(sumFull=sum(Full_Effect)) # this calculates the total full effect 
resp<-st_as_sf(resp,coords=c("X","Y"))
st_crs(resp)<-st_crs(grid)
iAll <- idw(sumFull~1, resp, grid,nmax=5,maxdist=5)
  
plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=iAll, aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="yellow",high="blue",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle("Total Effect (All Variables)") +
    theme(legend.title=element_blank()) 
   #resp_plots[[i]]<-plot
   #names(resp_plots[[i]])<-nam
setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/All")
#ggsave("sumAll.png",plot,bg="white",height=10,width=10)











for(i in plist) {
  plot<-plist[i]}

  plist[[i]]<-plist[[i]] + theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      legend.position="none",
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank())
}





sublist<-list(plist[[1]]+theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank()) + ggtitle("Precipitation, Lag 1"),
      plist[[2]]+theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank())+ ggtitle("Precipitation, Lag 2"),
      plist[[4]]+theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank())+ ggtitle("Temperature, Lag 1"),
      plist[[5]]+theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank())+ ggtitle("Temperature, Lag 2"))

p_arrange<-ggarrange(plotlist=sublist,common.legend = TRUE,widths=5,heights=5,ncol=4,legend="left")
#ggsave("all_plots.png",p_arrange,bg="white",width=12,height=8)


arnew<-ar2%>%
  mutate(Variable=ifelse(Variable=="Temp","Temperature, Current Year",ifelse(Variable=="Precip","Precipitation, Current Year",ifelse(Variable=="T1","Temperature, Lag 1",ifelse(Variable=="P1","Precipitation, Lag 1", ifelse(Variable=="T2","Temperature, Lag 2", ifelse(Variable=="P2","Precipitation, Lag 2", ifelse(Variable=="T3","Temperature, Lag 3", "Precipitation, Lag 3"))))))))

dens_plot<-ggplot(arnew)+
  geom_density(aes(Full_Effect,fill=Variable),color="black",show.legend=FALSE) +
  theme_minimal() +
  facet_wrap(~factor(Variable,levels=c("Temperature, Current Year","Precipitation, Current Year","Temperature, Lag 1","Precipitation, Lag 1","Temperature, Lag 2","Precipitation, Lag 2","Temperature, Lag 3","Precipitation, Lag 3")),scales="free",ncol=1) +
  scale_fill_colorblind() +
  xlim(-.05,.05) +
  xlab("Full Effect")

#ggsave("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/FIA Maps/All/all_densities.png",dens_plot,bg="white",height=12,width=8)



iAll2<-iAll%>%
  mutate(predScale=log(scale(var1.pred)))

fullMap<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=iAll2, aes(fill = predScale),color=NA) + 
    #geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="yellow",high="blue",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_classic() +
    ggtitle(i) +
    theme(legend.title=element_blank()) 

fullMap


# make a df that lists species, variables, and stages
stages<-data.frame(
  species=c("Quercus chrysolepis","Quercus agrifolia","Quercus kelloggii","Abies magnifica","Abies concolor","Abies grandis","Pinus ponderosa","Pinus monticola","Pinus contorta","Pinus jeffreyi","Pinus lambertiana"),
  Variable=c("Precip","Precip","Precip","Precip","Precip","Precip","Precip","Precip","Precip","Precip","Precip","Temp","Temp","Temp","Temp","Temp","Temp","Temp","Temp","Temp","Temp","Temp","P1","P1","P1","P1","P1","P1","P1","P1","P1","P1","P1","P2","P2","P2","P2","P2","P2","P2","P2","P2","P2","P2","P3","P3","P3","P3","P3","P3","P3","P3","P3","P3","P3","T1","T1","T1","T1","T1","T1","T1","T1","T1","T1","T1","T2","T2","T2","T2","T2","T2","T2","T2","T2","T2","T2","T3","T3","T3","T3","T3","T3","T3","T3","T3","T3","T3"),
  Stage=c(NA,NA,NA,
          "Fertilization","Fertilization","Fertilization",
          NA,NA,NA,NA,NA,
          NA,NA,NA,
          "Fertilization","Fertilization","Fertilization",
          NA,NA,NA,NA,NA,
          "Fertilization","Fertilization","Fertilization",
          "Bud Initiation","Bud Initiation","Bud Initiation",
          "Fertilization","Fertilization","Fertilization","Fertilization","Fertilization",
          "Pollination","Pollination","Pollination",
          NA,NA,NA,
          "Pollination","Pollination","Pollination","Pollination","Pollination",
          "Bud Initiation","Bud Initiation","Bud Initiation",
          NA,NA,NA,
          "Bud Initiation","Bud Initiation","Bud Initiation","Bud Initiation","Bud Initiation","Fertilization","Fertilization","Fertilization",
          "Bud Initiation","Bud Initiation","Bud Initiation",
          "Fertilization","Fertilization","Fertilization","Fertilization","Fertilization",
          "Pollination","Pollination","Pollination",
          NA,NA,NA,
          "Pollination","Pollination","Pollination","Pollination","Pollination",
          "Bud Initiation","Bud Initiation","Bud Initiation",
          NA,NA,NA,
          "Bud Initiation","Bud Initiation","Bud Initiation","Bud Initiation","Bud Initiation"))
          



# add tree names to the data
all3<-all_response%>%
  group_by(Species,Variable)%>%
  mutate(meanF=mean(Full_Effect),meanD=mean(Direct_Effect),meanI=mean(Indirect),meanR=mean(Response),
         Variable=ifelse(Variable=="P1","Precipitation, Bud Initiation",ifelse(Variable=="P2","Precipitation, Pollination",ifelse(Variable=="P3","Precipitation, Fertilization",ifelse(Variable=="T1","Temperature, Bud Initiation",ifelse(Variable=="T2","Temperature, Pollination","Temperature, Fertilization"))))))%>%
  group_by(TREE_ID)%>%
  mutate(cumF=sum(Full_Effect))%>%
  group_by(Species)%>%
  mutate(cumuF=mean(cumF),dummy=1)


tabs2<-all3%>%
  group_by(Species,Variable)%>%
  mutate(Response=round(mean(Response),3))%>%
  mutate(Direct=round(mean(Direct_Effect),3))%>%
  mutate(Indirect=round(mean(Indirect),3))%>%
  mutate(Full=round(mean(Full_Effect),3))%>%
  mutate(Cumulative=round(mean(cumuF),3))%>%
  dplyr::select(Species,Variable,Response,Direct,Indirect,Full,Cumulative)%>%
  distinct()
  
write.csv(tabs2,file="tableS2.csv")

rMap<-ggplot(all3)+
  geom_tile(aes(Species,Variable,fill=meanR),color="black") +
  scale_fill_gradient2(low="yellow",mid="white",high="blue") +
  theme_classic() +
  theme(axis.text.x = element_blank(),legend.title=element_blank(),axis.title.x=element_blank(),axis.title.y=element_blank(),text=element_text(size=15)) +
  ggtitle("Response")


dMap<-ggplot(all3)+
  geom_tile(aes(Species,Variable,fill=meanD),color="black") +
  scale_fill_gradient2(low="yellow",mid="white",high="blue") +
  theme_classic() +
  theme(axis.text.x = element_blank(),axis.title.x=element_blank(),legend.title=element_blank(),axis.text.y=element_blank(),axis.title.y=element_blank(),text=element_text(size=15))+
  ggtitle("Direct Effects")


iMap<-ggplot(all3)+
  geom_tile(aes(Species,Variable,fill=meanI),color="black") +
  scale_fill_gradient2(low="yellow",mid="white",high="blue") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),legend.title=element_blank(),axis.title.x=element_blank(),axis.title.y=element_blank(),legend.position="none",text=element_text(size=15)) +
  ggtitle("Indirect Effects")


fMap<-ggplot(all3)+
  geom_tile(aes(Species,Variable,fill=meanF),color="black") +
  scale_fill_gradient2(low="yellow",mid="white",high="blue") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),axis.title.x=element_blank(),legend.title=element_blank(),axis.text.y=element_blank(),axis.title.y=element_blank(),legend.position="none",text=element_text(size=15))+
  ggtitle("Full Effects")

cMap<-ggplot(all3)+
  geom_tile(aes(dummy,Species,fill=cumuF),color="black") +
  scale_fill_gradient2(low="yellow",mid="white",high="blue") +
  theme_classic() +
  scale_y_discrete(limits=rev) +
  theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.title.x=element_blank(),legend.title=element_blank(),axis.title.y=element_blank(),legend.position="none",text=element_text(size=15))+
  ggtitle("Cumulative Effects")



library(egg)
heatmapT<-ggpubr::ggarrange(rMap,dMap,ncol=2,common.legend=TRUE,widths=c(1.4,1))
heatmapB<-ggpubr::ggarrange(iMap,fMap,ncol=2,legend=NULL,widths=c(1.4,1))
heatmaps<-egg::ggarrange(plots=list(heatmapT,heatmapB),nrow=2,heights=c(1,1.2))
heatmaps2<-ggpubr::ggarrange(heatmaps,cMap,ncol=2,widths=c(4,1),heights=c(1.5,1))

ggsave("Figure1.png",heatmaps2,bg="white",height=12,width=15,dpi=300)







alltab<-all3%>%
  dplyr::select(Species,Variable,meanF,meanD,meanI,meanR)%>%
  distinct()%>%
  rename(Response=meanR,Direct=meanD,Indirect=meanI,Full=meanF)
write.csv(alltab,"species_response_table.csv")









elev <- read_sf(dsn = "/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/NED10M_SpatialMetadata/NED10M_fe2947_October2018.shp")
allsf<-st_as_sf(all3,coords=c("X","Y"))
st_crs(allsf)<-st_crs(elev)

all_elev<-st_intersection(allsf,elev)

allE<-all_elev%>%
  mutate(elevation=ifelse(zunit==0,zmean*0.3048,zmean))

ggplot(allE,aes(elevation,(Response),color=varNew)) +
  geom_point() +
  scale_color_colorblind() +
  geom_smooth(method="lm") +
  facet_wrap(~species)

ggplot(allE,aes(elevation,log(dt),color=varNew)) +
  geom_point() +
  scale_color_colorblind() +
  geom_smooth(method="lm")

ggplot(allE,aes(elevation,Direct_Effect,color=varNew)) +
  geom_point() +
  scale_color_colorblind() +
  geom_smooth(method="lm")

ggplot(allE,aes(elevation,Indirect,color=varNew)) +
  geom_point() +
  scale_color_colorblind() +
  geom_smooth(method="lm")


allE_lab<-allE%>%
  mutate(species=ifelse(species=="Abies concolor","ABCO",ifelse(species=="Abies grandis","ABGR",ifelse(species=="Abies magnifica","ABMA",ifelse(species=="Pinus contorta","PICO",ifelse(species=="Pinus ponderosa","PIPO",ifelse(species=="Pinus lambertiana","PILA",ifelse(species=="Pinus monticola","PIMO",ifelse(species=="Pinus jeffreyi","PIJE",ifelse(species=="Quercus agrifolia","QUAG",ifelse(species=="Quercus chrysolepis","QUCH","QUKE")))))))))))

fullEl<-ggplot(allE_lab,aes(elevation,Full_Effect,show.legend=FALSE)) +
  #geom_point(alpha=0.05,show.legend=FALSE) +
  scale_color_colorblind() +
  geom_smooth(method="lm",show.legend=FALSE,color="black") +
  facet_grid(species~varNew,scales="free",switch="y") +
  theme_minimal()
#ggsave("full_elevation.png",fullEl,bg="white",height=10,width=10)






# let's make a figure of indirect effects
tn2<-treeNames%>%
  unite(TREE_ID,plot,Subplot,tree,sep="_")%>%
  dplyr::select(TREE_ID,species)

specs<-c("Pinus contorta","Pinus ponderosa","Pinus jeffreyi","Pinus lambertiana","Pinus monticola","Quercus chrysolepis","Quercus kelloggii","Quercus agrifolia","Abies grandis","Abies concolor","Abies magnifica")

ind<-all_response%>%
  dplyr::select(TREE_ID,Variable,Indirect)%>%
  distinct()%>%
  merge(.,tn2)%>%
  mutate(Variable=ifelse(Variable=="P1","Precipitation, lag 1",ifelse(Variable=="P2","Precipitation, lag 2",ifelse(Variable=="P3","Precipitation, lag 3",ifelse(Variable=="Precip","Precipitation, current",ifelse(Variable=="T1","Temperature, lag 1", ifelse(Variable=="T2","Temperature, lag 2", ifelse(Variable=="T3","Temperature, lag 3", "Temperature, current"))))))))%>%
  group_by(species,Variable)%>%
  mutate(varNew=mean(Indirect))%>%
  dplyr::select(-Indirect)%>%
  distinct()%>%
  filter(species%in%specs)


ind$Variable<-factor(ind$Variable,levels=c("Temperature, current","Temperature, lag 1","Temperature, lag 2","Temperature, lag 3","Precipitation, current","Precipitation, lag 1","Precipitation, lag 2","Precipitation, lag 3"))

iMap<-ggplot(ind)+
  geom_tile(aes(species,Variable,fill=varNew),color="black") +
  scale_fill_gradient2(low="yellow",mid="white",high="blue") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),axis.title.x=element_blank(),legend.title=element_blank(),axis.title.y=element_blank())+
  scale_y_discrete(limits=rev)+
  ggtitle("Indirect Effects")
ggsave("indirectHeatmap.png",iMap,bg="white",dpi=300)




# PCA?
allWide<-all3%>%
  dplyr::select(Species,TREE_ID,Full_Effect,Variable)%>%
  distinct(Species,TREE_ID,.keep_all=TRUE)%>%
  pivot_wider(names_from=Variable,values_from=Full_Effect)%>%
  rename(PF=5,PP=4)%>%
  mutate(PF = ifelse(Species%in%c("Abies concolor","Abies magnifica","Abies grandis"),PP,PF))%>%
  rename("Precipitation, Fertilization" = 5,"Precipitation, Pollination" = 4)%>%
  drop_na()

library(ggbiplot)
respPC<-prcomp(allWide[3:8],center=TRUE,scale.=TRUE)
summary(respPC)
pca<-ggbiplot(respPC,groups=allWide$Species,ellipse=TRUE,alpha=0.01) +
  scale_color_discrete_diverging("Cork") +
  theme_minimal() +
  ylim(-5,5) +
  xlim(-5,5) +
  theme(legend.title=element_blank()) +
  labs(x="PC1 (32.0%)", y="PC2 (19.6%)") 
#ggsave("PCAplot.png",pca,bg="white",dpi=300,height=10,width=10)

PC1<-data.frame(res=respPC[["rotation"]])%>%
  dplyr::select(1)%>%
  rename(PC1=1)


allPC<-allWide%>%
  rename(PBI=3,PP=4,PF=5,TBI=6,TP=7,TF=8)%>%
  mutate(PC=PBI*PC1[1,]+PF*PC1[2,]+TBI*PC1[3,]+TF*PC1[4,]+PP*PC1[5,]+TP*PC1[6,])%>%
  dplyr::select(Species,TREE_ID,PC)%>%
  merge(allFutures)

library(grid)
wetText <- textGrob("Wet", gp=gpar(fontsize=13, fontface="italic"))
dryText <- textGrob("Dry", gp=gpar(fontsize=13, fontface="italic"))

PCreg<-ggplot() + 
  geom_smooth(data=allPC,aes(PC,deltaF_WW,linetype="Warm, Wet"),method="lm",color="black")+ 
  geom_smooth(data=allPC,aes(PC,deltaF_WD,linetype="Warm, Dry"),method="lm",color="black") +
  theme_minimal() +
  labs(x="PC1 Score (Climate Effect on Pollination and Fertilization)", y="Change in Fecundity (Log Scale)") +
  theme(legend.title=element_blank()) +
  annotation_custom(wetText,xmin=.45,xmax=.7,ymin=-3250,ymax=-3250) +
  annotation_custom(dryText,xmin=-.85,xmax=-.7,ymin=-3250,ymax=-3250) +
  coord_cartesian(clip="off")
PCreg


ggsave("pc_regression.png",PCreg,bg="white",dpi=300)

```

Here we analyze time-series data to look at the change in fecundity in time. Importantly, I analyze both contemporary changes (1994-2020) and future changes under the mean GCM results (2028 - 2099). 
``` {r time series data}

# read in all of the coefficients
pines<-read.csv('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/Pinus MASTIF Output (deviation climate)/pinus_betas.csv')%>%
  mutate(X=gsub("species","",X))%>%
  separate(X,c('Species','var1','var2'),sep=":")%>%
  mutate(var1=ifelse(is.na(var1)==TRUE,"Intercept",var1),var2=ifelse(is.na(var2)==TRUE," ",var2))%>%
    filter(var1!="shade",var2!="shade")%>%
  mutate(Species=tolower(Species),Species=gsub("pinus","Pinus ",Species),Species=ifelse(Species=="Pinus contorta","Pinus contorta",ifelse(Species=="Pinus jeffreyi", "Pinus jeffreyi",ifelse(Species=="Pinus lamberti","Pinus lambertiana",ifelse(Species=="Pinus monticol","Pinus monticola","Pinus ponderosa")))))%>%
  mutate(beta_obs=ifelse(sig95=="*",estimate,0),interaction=paste(var1,var2,sep=":"))%>%
  dplyr::select(Species,interaction,beta_obs)%>%
  pivot_wider(names_from=interaction,values_from=beta_obs)%>%
  rename(Int=2,dia=3,dia2=4,P_3=5,T_3=6,P_2=7,T_2=8,P_1=9,T_1=10,diam_P3=11,diam_T3=12,diam_P2=13,diam_T2=14,diam_P1=15,diam_T1=16,species=Species)


firs<-read.csv('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/Abies MASTIF Output (deviation climate)/abies_betas.csv')%>%
  mutate(X=gsub("species","",X))%>%
  separate(X,c('Species','var1','var2'),sep=":")%>%
  mutate(var1=ifelse(is.na(var1)==TRUE,"Intercept",var1),var2=ifelse(is.na(var2)==TRUE," ",var2))%>%
    filter(var1!="shade",var2!="shade")%>%
  mutate(Species=tolower(Species),Species=gsub("abies","Abies ",Species),Species=ifelse(Species=="Abies concolor","Abies concolor",ifelse(Species=="Abies magnific","Abies magnifica",ifelse(Species=="Abies lasiocar","Abies lasiocarpa",Species))))%>%
  mutate(beta_obs=estimate,interaction=paste(var1,var2,sep=":"))%>%
  dplyr::select(Species,interaction,beta_obs)%>%
  pivot_wider(names_from=interaction,values_from=beta_obs)%>%
  rename(Int=2,dia=3,dia2=4,P_0=5,T_0=6,P_1=7,T_1=8, diam_P0=9, diam_T0=10,diam_P1=11,diam_T1=12,species=Species)


oaks<-read.csv('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/Quercus MASTIF Output (deviation climate)/quercus_betas.csv')%>%
  mutate(X=gsub("species","",X))%>%
  separate(X,c('Species','var1','var2'),sep=":")%>%
  mutate(var1=ifelse(is.na(var1)==TRUE,"Intercept",var1),var2=ifelse(is.na(var2)==TRUE," ",var2))%>%
    filter(var1!="shade",var2!="shade")%>%
  mutate(Species=tolower(Species),Species=gsub("quercus","Quercus ",Species),Species=ifelse(Species=="Quercus chrysole","Quercus chrysolepis",ifelse(Species== "Quercus kelloggi","Quercus kelloggii","Quercus agrifolia")))%>%
  mutate(beta_obs=estimate,interaction=paste(var1,var2,sep=":"))%>%
  dplyr::select(Species,interaction,beta_obs)%>%
  pivot_wider(names_from=interaction,values_from=beta_obs)%>%
  rename(Int=2,dia=3,dia2=4,P_3=5,T_3=6,P_2=7,T_2=8,P_1=9,T_1=10,diam_P3=11,diam_T3=12,diam_P2=13,diam_T2=14,diam_P1=15,diam_T1=16,species=Species)




pines2<-pclim%>%
  rename(species=Species)%>%
  full_join(.,pines)%>%
  rename(P3=precip_budInit,P2=ppt_Poll,P1=ppt_Fert,T3=temp_budInit,T2=tmean_Poll,T1=tmean_Fert)%>%
  mutate(
    logF= Int + (dia*Diameter) + (dia2*Diameter) + (P1*P_1) + (P2*P_2) + (P3*P_3) + (T1*T_1)+ (T2*T_2)+ (T3*T_3) + (diam_P1*P1*Diameter)+ (diam_P2*P2*Diameter)+ (diam_P3*P3*Diameter) + (diam_T1*T1*Diameter)+ (diam_T2*T2*Diameter)+ (diam_T3*T3*Diameter))%>%
    unite(col="Tree",Plot,Tree,sep="_")%>%
  dplyr::select(species,year,Tree,X,Y,logF)

oaks2<-oclim%>%
  rename(species=Species)%>%
  full_join(.,oaks)%>%
  rename(P3=ppt_budInit,P2=ppt_Poll,P1=ppt_Fert,T3=temp_budInit,T2=tmean_Poll,T1=temp_Fert)%>%
  mutate(
    logF= Int + (dia*Diameter) + (dia2*Diameter) + (P1*P_1) + (P2*P_2) + (P3*P_3) + (T1*T_1)+ (T2*T_2)+ (T3*T_3) + (diam_P1*P1*Diameter)+ (diam_P2*P2*Diameter)+ (diam_P3*P3*Diameter) + (diam_T1*T1*Diameter)+ (diam_T2*T2*Diameter)+ (diam_T3*T3*Diameter))%>%
    unite(col="Tree",Plot,Tree,sep="_")%>%
  dplyr::select(species,year,Tree,X,Y,logF)


firs2<-aclim%>%
  rename(species=Species)%>%
  full_join(.,firs)%>%
  rename(P1=precip_budInit,T1=temp_budInit,T0=tmean_Poll,P0=precip_PollFert)%>%
 mutate(
    logF= Int + (dia*Diameter) + (dia2*Diameter) + (P0*P_0) + (P1*P_1) +  (T0*T_0)+ (T1*T_1)+ (diam_P1*P1*Diameter)+ (diam_P0*P0*Diameter)+ (diam_T1*T1*Diameter)+ (diam_T0*T0*Diameter)
  ) %>%
  unite(col="Tree",Plot,Tree,sep="_")%>%
  dplyr::select(species,year,Tree,X,Y,logF)


allspecs<-rbind(pines2,firs2,oaks2)%>%
  drop_na()%>%
  group_by(species,year)%>%
  mutate(meanF=mean(logF))


# here we will do a time-series of current climate for each species in CA
a<-aclim2%>%
  mutate(Precip=precip_budInit-Norm_p,Tnew=(temp_budInit+tmean_Poll+tmean_Fert)/3,Temp=Tnew-Norm_t)%>%
  dplyr::select(Tree,Plot,Subplot,year,Species,Precip,Temp)%>%
  rename(plot=Plot,tree=Tree)%>%
  full_join(.,abiesFIA)
b<-pclim2%>%
  mutate(Precip=precip_budInit-Norm_p,Tnew=(temp_budInit+tmean_Poll+tmean_Fert)/3,Temp=Tnew-Norm_t)%>%
  dplyr::select(Tree,Plot,Subplot,year,Species,Precip,Temp)%>%
  rename(plot=Plot,tree=Tree)%>%
  full_join(.,pinusFIA)
c<-oclim2%>%
  mutate(Precip=ppt_budInit-Norm_p,Tnew=(temp_budInit+tmean_Poll+temp_Fert)/3,Temp=Tnew-Norm_t)%>%
  dplyr::select(Tree,Plot,Subplot,year,Species,Precip,Temp)%>%
  rename(plot=Plot,tree=Tree)%>%
  full_join(.,quercusFIA)

allspecs_clim<-rbind(a,b,c)%>%
  drop_na()%>%
  mutate(avgP=mean(Precip),avgT=mean(Temp))%>%
  pivot_longer(cols=c(avgP,avgT),names_to="Variable",values_to="Value")%>%
  ungroup()%>%
  dplyr::select(Species,Variable,Value,geometry)%>%
  distinct()


# OK, let's map the changes

library(tigris) # package for CA maps
library(raster)
ca<-states(keep_zipped_shapefile=TRUE)%>%
  filter(NAME=="California")%>%
  dplyr::select(NAME,INTPTLAT,INTPTLON)%>%
  rename(LAT=2,LON=3)
ca$LON<-as.numeric(ca$LON)
ca$LAT<-as.numeric(ca$LAT)




grid <- ca%>%
  sf::st_make_grid(cellsize = 0.05, what = "polygons",square=TRUE) %>%
  sf::st_intersection(ca) %>% 
  sf::st_sf(grid_id = 1:length(.))
sf::sf_use_s2(FALSE)
#grid<-distinct(grid)

library(gstat)

current_sf<-st_as_sf(allspecs_clim)%>%
  drop_na()

interp<-NULL
for(j in unique(current_sf$Variable)) {
  
  dat<-filter(current_sf,Variable==j)
  st_crs(dat)<-st_crs(grid)
  
  iClim <- idw(Value~1, dat, grid,nmax=10,maxdist=10)
  iClim2<-cbind(iClim,Variable=j,Time="Current")
  
  interp<-rbind(interp,iClim2)
}


Pplot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=subset(interp,Variable=="avgP"), aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="black",high="lightblue",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_minimal() +
    theme(legend.title=element_blank()) 

Tplot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=subset(interp,Variable=="avgT"), aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="blue",high="red",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_minimal() +
    theme(legend.title=element_blank()) 

Pplot<-Pplot + theme(plot.margin = unit(c(0,0,0,0), "lines"),axis.text=element_blank(),axis.title=element_blank())
Tplot<-Tplot + theme(plot.margin = unit(c(0,0,0,0), "lines"),axis.text=element_blank(),axis.title=element_blank())



current_P<-ggplot(data=subset(allspecs_clim,Variable=="avgP"),aes(year,Value,color=Species,group=Species)) +
  geom_line() +
  scale_color_tableau(palette="Tableau 20") +
  theme_minimal() +
  ylab("Precipitation Difference from 30yr Normal") +
  xlab("")+
  theme(legend.title=element_blank(),axis.text.y=element_text(angle=90),text=element_text(size=15),legend.text=element_text(size=15))

current_T<-ggplot(data=subset(allspecs_clim,Variable=="avgT"),aes(year,Value,color=Species,group=Species)) +
  geom_line() +
  scale_color_tableau(palette="Tableau 20") +
  theme_minimal() +
  ylab("Temperature Difference from 30yr Normal")+
  xlab("Year")+
  theme(legend.title=element_blank(),axis.text.y=element_text(angle=90),text=element_text(size=15),legend.text=element_text(size=15))

current_clim<-ggarrange(current_P,current_T,ncol=1,labels=c("A","B"),common.legend=TRUE)


# let's do a linear model of current climate
currP<-allspecs_clim%>%
  group_by(Species,Variable)%>%
  do(P=summary(lm(Value~year,data=.))[[4]][2,4])%>%
  dplyr::select(Species,Variable,P)%>%
  drop_na()%>%
  mutate(P=round(as.numeric(P),3),P=ifelse(P<0.001,"<0.001",P))

# DO LINEAR MODEL
curr_coefs<-allspecs_clim%>%
  group_by(Species,Variable)%>%
  do(coef=lm(Value~year,data=.)$coefficients[[2]])%>%
  dplyr::select(Species,Variable,coef)%>%
  drop_na()%>%
  mutate(newcoef=as.numeric(coef)/100)%>%
  dplyr::select(Species,Variable,newcoef)%>%
  rename(Beta=newcoef)

current_stats<-merge(currP,curr_coefs)

write.csv(file="current_climate_stats.csv",x=current_stats)


# make a time-series figure of future climate at species level

allFIA<-rbind(abiesFIA,quercusFIA,pinusFIA)%>%
  mutate(TREE_ID=paste(plot,Subplot,tree,sep="_"))
  
  
avgGCM<-allGCM%>%
  group_by(TREE_ID)%>%
  mutate(DP=mean(deltaP),DT=mean(deltaT))%>%
  full_join(.,allFIA)%>%
  dplyr::select(species,Year,DP,DT,geometry)%>%
  distinct()%>%
  pivot_longer(cols=c(DP,DT),names_to="Variable",values_to="Value")

library(gstat)

future_sf<-st_as_sf(avgGCM)%>%
  drop_na()

interp<-NULL
for(j in unique(future_sf$Variable)) {
  
  dat<-filter(future_sf,Variable==j)
  st_crs(dat)<-st_crs(grid)
  
  iClim <- idw(Value~1, dat, grid,nmax=10,maxdist=10)
  iClim2<-cbind(iClim,Variable=j,Time="Current")
  
  interp<-rbind(interp,iClim2)
}


Pplot_future<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=subset(interp,Variable=="DP"), aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="black",high="lightblue",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_minimal() +
    theme(legend.title=element_blank()) 

Tplot_future<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=subset(interp,Variable=="DT"), aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="blue",high="red",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_minimal() +
    theme(legend.title=element_blank()) 


Pplot_future <- Pplot_future + theme(plot.margin = unit(c(0,0,0,0), "lines"),axis.text=element_blank(),axis.title=element_blank())
Tplot_future <- Tplot_future + theme(plot.margin = unit(c(0,0,0,0), "lines"),axis.text=element_blank(),axis.title=element_blank())



Oaks<-avgGCM%>%
  dplyr::select(TREE_ID,species,geometry)%>%
  filter(species%in%c("Quercus agrifolia","Quercus kelloggii","Quercus chrysolepis"))%>%
  mutate(val=1)
oaksf<-st_as_sf(Oaks)

oaksMap<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=oaksf, aes(color=species)) + 
  scale_color_colorblind() +
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_minimal() +
    theme(legend.title=element_blank(),legend.position="top",legend.box.margin=margin(-10,-10,-10,-10),legend.margin=margin(t = 1, r=1,unit='cm'),text=element_text(size=12),plot.margin = unit(c(-3,0,0,0), "cm")) + 
  guides(color = guide_legend(override.aes = list(size = 3))) 

current_maps<-ggarrange(Pplot,Tplot,ncol=1,labels=c("Precipitation (1994 - 2020)","Temperature (1994 - 2020)"))


future_maps<-ggarrange(Pplot_future,Tplot_future,ncol=1,labels=c("Precipitation (2028 - 2099)","Temperature (2028 - 2099)"))

left<-ggarrange(Pplot,Tplot,ncol=1,labels=c("A","D"))
right<-ggarrange(Pplot_future,Tplot_future,ncol=1,labels=c("C","E"))
full<-ggarrange(left,oaksMap,right,ncol=3,labels=c("","B",""),widths=c(1,2,1))
ggsave("allmaps.png",full,bg="white",dpi=300,height=10,width=12)

future_P<-ggplot(avgGCM,aes(Year,DP,color=species,group=species)) +
  geom_line() +
  scale_color_tableau(palette="Tableau 20") +
  theme_minimal() +
  ylab("") +
  xlab("")+
  theme(legend.title=element_blank(),axis.text.y=element_text(angle=90),text=element_text(size=15),legend.text=element_text(size=15))

future_T<-ggplot(avgGCM,aes(Year,DT,color=species,group=species)) +
  geom_line() +
  scale_color_tableau(palette="Tableau 20") +
  theme_minimal() +
  ylab("") +
  xlab("")+
  theme(legend.title=element_blank(),axis.text.y=element_text(angle=90),text=element_text(size=15),legend.text=element_text(size=15))

future_clim<-ggarrange(future_P,future_T,ncol=1,labels=c("C","D"),common.legend=TRUE)

current_future<-ggarrange(current_P,future_P,current_T,future_T,labels=c("A","B","C","D"),common.legend=TRUE)

ggsave("Figure2.png",current_future,bg="white",dpi=300,height=15,width=15)


# let's do stats for future climate now
aGCM2<-avgGCM%>%
  pivot_longer(cols=3:4,values_to="Value",names_to="Variable")

futureP<-aGCM2%>%
  group_by(species,Variable)%>%
  do(P=summary(lm(Value~Year,data=.))[[4]][2,4])%>%
  dplyr::select(species,Variable,P)%>%
  drop_na()%>%
  mutate(P=round(as.numeric(P),3),P=ifelse(P<0.001,"<0.001",P))

# DO LINEAR MODEL
future_coefs<-aGCM2%>%
  group_by(species,Variable)%>%
  do(coef=lm(Value~Year,data=.)$coefficients[[2]])%>%
  dplyr::select(species,Variable,coef)%>%
  drop_na()%>%
  mutate(newcoef=as.numeric(coef)/100)%>%
  dplyr::select(species,Variable,newcoef)%>%
  rename(Beta=newcoef)

future_stats<-merge(futureP,future_coefs)

write.csv(file="future_climate_stats.csv",x=future_stats)


# DO LINEAR MODEL
specs2<-allspecs%>%
  group_by(species)%>%
  do(P=summary(lm(logF~year,data=.))[[4]][2,4])%>%
  dplyr::select(species,P)%>%
  drop_na()%>%
  mutate(P=round(as.numeric(P),3),P=ifelse(P<0.001,"<0.001",P))

# DO LINEAR MODEL
specs_coefs<-allspecs%>%
  group_by(species)%>%
  do(coef=lm(logF~year,data=.)$coefficients[[2]])%>%
  dplyr::select(species,coef)%>%
  drop_na()%>%
  mutate(newcoef=as.numeric(coef)/100)

specs_Ps<-allspecs%>%
  group_by(species)%>%
  do(P=summary(lm(logF~year,data=.))[[4]][2,4])%>%
  dplyr::select(species,P)%>%
  drop_na()%>%
  mutate(P=as.numeric(P),P=ifelse(P<0.05,"*","n.s."))

res<-merge(specs_coefs,specs_Ps)%>%
  dplyr::select(species,newcoef,P)

allspecs<-merge(allspecs,res)%>%
  group_by(species)%>%
  mutate(Pxpos=1995,Pypos=ifelse(max(meanF)>0,max(meanF)-(max(meanF)*0.1),max(meanF)-abs((max(meanF))*0.4)))


fec_time<-ggplot(allspecs,aes(year,logF,color=species,group=Tree)) +
  geom_line() +
  geom_smooth(data=allspecs,aes(year,logF,group=species),method="lm",color="black",alpha=0.25) +
  theme_minimal()+
  geom_text(aes(x=Pxpos,y=Pypos,label=P),color="black",size=12) +
  labs(x="Year",y="Predicted Fecundity (log scale)") +
  theme(legend.position="none",text=element_text(size=35)) +
  facet_wrap(~species,scales="free",ncol=1)

ggsave("time_fecundity.png",fec_time,bg="white",dpi=300,height=30,width=10)








dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)
tmp<-inputs$seedData

SD<-tmp%>%
  dplyr::select(plot,trap,year,abiesGrandis,abiesConcolor,abiesMagnific,pinusContorta,pinusLamberti,pinusMonticol,pinusPonderos,pinusJeffreyi,quercusChrysole,quercusKelloggi,quercusAgrifoli)%>%
  rename("Abies grandis"=4,"Abies concolor"=5,"Abies magnifica" = 6, "Pinus contorta"=7,"Pinus lambertiana"=8,"Pinus monticola"=9,"Pinus ponderosa"=10,'Pinus jeffreyi'=11,"Quercus chrysolepis"=12,"Quercus kelloggii"=13,"Quercus agrifolia"=14)%>%
  pivot_longer(cols=4:14,names_to="Species",values_to="seedCount")%>%
  drop_na()%>%
  mutate(group=paste0(plot,trap,sep="_"))%>%
  group_by(Species,year)%>%
  mutate(meanCount=mean(seedCount))

sd_plot<-ggplot(SD,aes(year,log(seedCount),group=group,color=Species)) +
  geom_line() +
  facet_wrap(~Species) +
  theme_minimal() +
  theme(legend.position="none") +
  labs(y="Seed Count / Trap",x="Year")


seed_test<-SD%>%
  group_by(Species)%>%
  do(coef=(lm(seedCount~year,data=.)$coefficients[[2]]))%>%
  dplyr::select(Species,coef)%>%
  drop_na()%>%
  mutate(coef=round(as.numeric(coef),4),coef=ifelse(abs(coef)<0.1,"n.s.",ifelse(Species=="Abies magnifica",abs(coef),coef)))


sd2p<-ggplot() +
  geom_line(data=SD,aes(year,log(seedCount),color=Species,group=group),show.legend=FALSE) +
  geom_smooth(method="lm",formula=y~x,color="black",data=SD,aes(year,log(seedCount)))+
  facet_wrap(~Species)  +
  labs(y="Seed Count / Trap (log scale)",x="Year") +
  geom_text(data=seed_test,aes(x=2020,y=6,label=coef))


ggsave("timeseries.png",sd2p,bg="white",dpi=300,width=10,height=10)


# do time series of climate for each species; do contemporary / historical climate and then future climate
ac<-abiesClim%>%
  dplyr::select(species,plot,year,precip_budInit,temp_budInit)
pc<-pinusClim%>%
  dplyr::select(species,plot,year,precip_budInit,temp_budInit)
oc<-quercusClim%>%
  dplyr::select(species,plot,year,ppt_budInit,temp_budInit)%>%
  rename(precip_budInit=ppt_budInit)

all_climate<-rbind(ac,pc,oc)%>%
  distinct()%>%
  mutate(species=ifelse(species=="abiesGrandis","Abies grandis",ifelse(species=="abiesConcolor","Abies concolor",ifelse(species=="abiesMagnific","Abies magnifica",ifelse(species=="pinusPonderos","Pinus ponderosa",ifelse(species=="pinusLamberti","Pinus lambertiana",ifelse(species=="pinusMonticol","Pinus monticola",ifelse(species=="pinusJeffreyi","Pinus jeffreyi",ifelse(species=="pinusContorta","Pinus contorta")))))))))
         
         
         ("Abies grandis","Abies concolor","Abies magnifica","Pinus ponderosa","Pinus lambertiana","Pinus monticola","Pinus jeffreyi","Pinus contorta","Quercus chrysolepis","Quercus agrifolia","Quercus kelloggii"))

  filter(species%in%c("Abies grandis","Abies concolor","Abies magnifica","Pinus ponderosa","Pinus lambertiana","Pinus monticola","Pinus jeffreyi","Pinus contorta","Quercus chrysolepis","Quercus agrifolia","Quercus kelloggii"))




```

Here I am trying to test the model's ability to predict the observed fecundity in 2024. I suspect the best way to do this is to run MASTIF on 2024 data only, using a simple model with only DBH as a predictor. Although the predictions may not be accurate, the estimates will be and we can use those estimates to test against our predictions (i.e., observed v. predicted). 
``` {r forecast}

p_coef<-read.csv('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/Pinus MASTIF Output (deviation climate)/pinus_betas.csv')%>%
  mutate(X=gsub("species","",X))%>%
  separate(X,c('Species','var1','var2'),sep=":")%>%
  mutate(var1=ifelse(is.na(var1)==TRUE,"Intercept",var1),var2=ifelse(is.na(var2)==TRUE," ",var2))%>%
    filter(var1!="shade",var2!="shade")%>%
  #mutate(Species=tolower(Species),Species=gsub("pinus","Pinus ",Species),Species=ifelse(Species=="Pinus contorta","Pinus contorta",ifelse(Species=="Pinus jeffreyi", "Pinus jeffreyi",ifelse(Species=="Pinus lamberti","Pinus lambertiana",ifelse(Species=="Pinus monticol","Pinus monticola","Pinus ponderosa")))))%>%
  #mutate(beta_obs=ifelse(sig95=="*",estimate,0),interaction=paste(var1,var2,sep=":"))%>%
  mutate(beta_obs=estimate,interaction=paste(var1,var2,sep=":"))%>%
  dplyr::select(Species,interaction,beta_obs)%>%
  pivot_wider(names_from=interaction,values_from=beta_obs)%>%
  rename(species=Species)
names(p_coef)<-sub(":", "", names(p_coef))
names(p_coef)<-sub(" ", "", names(p_coef))



######### here we will get the climate data for 2024
library(sf)
library(raster)
library(terra)
library(sp)


dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)

genus<-"pinus"
tmp<-extractGenus(inputs, genus = genus, taxa, plotData)

treeData<-tmp$inputs$treeData # get individual tree data from MASTIF file
xytree<-tmp$inputs$xytree # isolate tree location data
trees<-full_join(treeData,xytree)%>% # do this so I can find tree locations
  filter(year==2023)%>%
  dplyr::select(plot,tree,species,shade,x,y,diam)%>% # let's keep the shade and diameter from previous year
  drop_na()


# read in list of 2024 pine data
temp <- list.files(path="/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/MASTIF data 2024/Trees",pattern="\\.csv$",include.dirs = TRUE,full.names=TRUE)
myfiles <- lapply(temp, read_csv)%>%
  lapply(.,as.data.frame)%>%
  lapply(.,dplyr::select,c(plot,tag,species,diam2024,sex2024,cropCount2024))%>%
  Map(cbind,.)%>%
  do.call(rbind,.)%>%
  rename(tree=tag)%>%
  mutate(plot=sub("_","",plot))

newdata<- full_join(trees,myfiles)%>% # this merges the original mastif file with the current-year data
  dplyr::select(-sex2024,-cropCount2024)%>%
  mutate(year=2023,diameter=ifelse(is.na(diam2024)==TRUE,diam,diam2024))%>% # use previous year's diameter if we don't have it right now for current year; trees probably didn't grow an insane amount
  dplyr::select(-diam,-diam2024)%>%
  drop_na()


tree_sf<-st_as_sf(newdata,coords=c("x","y"),
                  crs = "+proj=utm +zone=11")
tree_transform<- st_transform(tree_sf, crs = "+proj=longlat +datum=WGS84")
tree_crs<-crs(tree_transform) # define the CRS


# start with Pinus bud initiation
mon<-8:10
years<-unique(newdata$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_budInit=7)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

budTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(temp_budInit=mean(tmean_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,temp_budInit)%>%
  distinct()



# now let's do temp at pollination
mon<-4:8
years<-unique(newdata$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Poll=7)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

pollenTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(tmean_Poll=mean(tmean_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,tmean_Poll)%>%
  distinct()



# now let's do temp at fertilization
mon<-5:10
years<-unique(newdata$year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Fert=7)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

fertTemp<-temp%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  group_by(species,tree,plot,Year)%>%
  mutate(tmean_Fert=mean(tmean_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,tmean_Fert)%>%
  distinct()



# now let's do precip at Bud Initiation
# here we are only concerned with water year
mon<-10:12
years<-unique(newdata$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-4),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-4)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=7)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}


# now let's get spring precip
mon<-1:4
years<-unique(newdata$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_budInit=7)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


budPrecip<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  mutate(Year=ifelse(Month%in%c(10:12),as.numeric(Year)+1,as.numeric(Year)))%>%
  group_by(species,tree,plot,Year)%>%
  mutate(precip_budInit=sum(ppt_budInit))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,precip_budInit)%>%
  distinct()


# now let's do precip at Pollination
# here we are only concerned with water year
mon<-10:12
years<-unique(newdata$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Poll=7)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}


# now let's get spring precip
mon<-1:4
years<-unique(newdata$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Poll=7)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


pollPrecip<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  mutate(Year=ifelse(Month%in%c(10:12),as.numeric(Year)+1,as.numeric(Year)))%>%
  group_by(species,tree,plot,Year)%>%
  mutate(ppt_Poll=sum(ppt_Poll))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_Poll)%>%
  distinct()


# now let's do precip at Fertilization
# here we are only concerned with water year
require(terra)
mon<-10:12
years<-unique(newdata$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Fert=7)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}


# now let's get spring precip
mon<-1:4
years<-unique(newdata$year)
vars<-"ppt"
temp2<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,ppt_Fert=7)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp2<-rbind(temp2,EXT_df)
}


fertPrecip<-rbind(temp,temp2)%>%
  separate(Date,c("Month","Year"),sep="_")%>%
  mutate(Year=ifelse(Month%in%c(10:12),as.numeric(Year)+1,as.numeric(Year)))%>%
  group_by(species,tree,plot,Year)%>%
  mutate(ppt_Fert=sum(ppt_Fert))%>%
  ungroup()%>%
  dplyr::select(species,tree,plot,year,ppt_Fert)%>%
  distinct()



budPrecip$tree<-as.character(budPrecip$tree)
pollPrecip$tree<-as.character(pollPrecip$tree)
fertPrecip$tree<-as.character(fertPrecip$tree)
budTemp$tree<-as.character(budTemp$tree)
pollenTemp$tree<-as.character(pollenTemp$tree)
fertTemp$tree<-as.character(fertTemp$tree)

pinusClim<-full_join(budPrecip,pollPrecip)%>%
  full_join(.,fertPrecip)%>%
  full_join(.,budTemp)%>%
  full_join(.,pollenTemp)%>%
  full_join(.,fertTemp)




# OK let's try to do the normals calculations

# OK, now let's load in some PRISM 30year mean data
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
mon<-c(1:3,10:12)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("ppt", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_sf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Precip=7)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_p<-EXT_df%>%
    dplyr::select(tree,Precip)%>%
    distinct()%>%
    group_by(tree)%>%
    mutate(Norm_p=sum(Precip))%>%
    dplyr::select(-Precip)%>%
    distinct()
    
  
  
  

temp<-data.frame(NULL)
library(prism)
mon<-c(5:8)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)
v<-NULL

data<-prism_archive_subset("tmean", "monthly normals", mon = mon,resolution="4km") # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tree_vec<-vect(tree_sf) # convert tree file to spatial vector
  EXT<-lapply(SR,terra::extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the tree locations

  names(EXT)<-mon
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,Temp=7)%>%
    Map(cbind, ., Month = names(.))%>%
    do.call(rbind,.)
  normal_t<-EXT_df%>%
    dplyr::select(tree,Temp)%>%
    rename(Norm_t=Temp)%>%
    group_by(tree)%>%
    mutate(Norm_t=mean(Norm_t))%>%
    distinct()

normals<-full_join(normal_t,normal_p)


pinusClim2<-full_join(pinusClim,normals)%>%
  mutate(precip_budinit=scale(precip_budInit-Norm_p),temp_budinit=scale(temp_budInit-Norm_t),tmean_poll=scale(tmean_Poll-Norm_t),tmean_fert=scale(tmean_Fert-Norm_t),ppt_poll=scale(ppt_Poll-Norm_p),ppt_fert=scale(ppt_Fert-Norm_p))%>%
  full_join(.,newdata)%>%
  dplyr::select(1:4, 13:19, diameter)
  

# now that we have climate data, let's combine it with the coefficients data from previous MASTIF run

pine_full<-full_join(p_coef,pinusClim2)%>%
  rename(diam2=4)%>%
  mutate(logF= (Intercept + diam*diameter + diam2*diameter + precip_budInit*precip_budinit + ppt_Poll*ppt_poll + ppt_Fert*ppt_fert + temp_budInit*temp_budinit + tmean_Poll*tmean_poll + tmean_Fert*tmean_fert + diamprecip_budInit*diameter*precip_budinit + diamppt_Poll*diameter*ppt_poll + diamppt_Fert*diameter*ppt_fert + diamtemp_budInit*diameter*temp_budinit + diamtmean_Poll*diameter*tmean_poll + diamtmean_Fert*diameter*tmean_fert))%>% # now let's predict fecundity for each tree
  group_by(plot,species)%>%
  mutate(mF=median(logF))
  

seki_seeds<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/MASTIF data 2024/SEKI_SeedData.csv")%>%
  rename(Count1=4,Count2=5)%>%
  mutate(Genus=ifelse(species=="pinusUNKNOWN","Pinus",NA),Plot=ifelse(Plot=="SJ","SEQJ",ifelse(Plot=="SJM","SEQJM","SEQJP")))%>%
  drop_na()%>%
  group_by(Plot,Trap)%>%
  mutate(Total=sum(Count1+Count2))

tahoe_seeds<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/MASTIF data 2024/Tahoe_Seeds.csv")%>%
  rename(Count1=4,Count2=5)%>%
  mutate(Genus=ifelse(species=="pinusUNKNOWN","Pinus",NA),Plot=ifelse(Plot=="TP","TAHOEP",ifelse(Plot=="TJ","TAHOEJ",ifelse(Plot=="TJP","TAHOEJP",ifelse(Plot=="TJ ","TAHOEJ",ifelse(Plot=="TJM","TAHOJM",NA))))))%>%
  drop_na()%>%
  group_by(Plot,Trap)%>%
  mutate(Total=sum(Count1+Count2))

seeds_full<-rbind(seki_seeds,tahoe_seeds)%>%
  ungroup()%>%
  dplyr::select(-species,-Trap,-Count1,-Count2)

pine_compare<-pine_full%>%
  mutate(Genus="Pinus")%>%
  ungroup()%>%
  rename(Plot=plot)%>%
  dplyr::select(Genus,Plot,logF)%>%
  full_join(.,seeds_full)%>%
  drop_na()%>%
  mutate(Fec=exp(logF))
  

ggplot(pine_compare,aes(Fec/8000,(Total/0.133),shape=Plot),size=10) +
  geom_point() +
  theme_minimal() +
  lims(y=c(0,15),x=c(0,15))+
  labs(x="Predicted",y="Observed")+
  geom_abline(aes(intercept=0,slope=1))

# ok for pines it looks like we're overpredicting? idk seems tough when things are so zero-inflated
# hm I need to think about this a bit more I think
# do I need to scale the trap-level data to tree or plot level and how? 
# or should I scale tree-level predictions to trap or plot level? need think about how to best aggregate



ggplot() +
  stat_density(data=pine_full,aes(x=logF,fill=species)) +
  geom_vline(data=pine_full,aes(xintercept=mF,linetype=species))+
  facet_wrap(plot~species,scale="free")




# ok now let's try to validate
# for each plot, take seed count for each species and compare to what the model predicts we should see



```






``` {r ANPP x fecundity}
dir<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/ANPP"
files<-paste(dir,list.files(path=dir),sep="/")
ras <- lapply(files,raster) 
stacked<-stack(ras)
avgNPP <- calc(stacked, fun = mean, na.rm = T)
library(terra)
avgNPP_rast<-rast(avgNPP)


pinus_vec<-vect(gcAC_pinus,geom=c("X","Y"),crs=crs(avgNPP_rast)) 
abies_vec<-vect(gcAC_abies,geom=c("X","Y"),crs=crs(avgNPP_rast)) 
quercus_vec<-vect(gcAC_quercus,geom=c("X","Y"),crs=crs(avgNPP_rast)) 

pines<-terra::extract(avgNPP_rast,pinus_vec,xy=TRUE,bind=TRUE)
pdf<-as.data.frame(pines)%>%
  rename(avg_ANPP=layer)%>%
  dplyr::select(Species,TREE_ID,Year,logF_current,meanF_current,avg_ANPP,x,y)
firs<-terra::extract(avgNPP_rast,abies_vec,xy=TRUE,bind=TRUE)
adf<-as.data.frame(firs)%>%
  rename(avg_ANPP=layer)%>%
  dplyr::select(Species,TREE_ID,Year,logF_current,meanF_current,avg_ANPP,x,y)
oaks<-terra::extract(avgNPP_rast,quercus_vec,xy=TRUE,bind=TRUE)
odf<-as.data.frame(oaks)%>%
  rename(avg_ANPP=layer)%>%
  dplyr::select(Species,TREE_ID,Year,logF_current,meanF_current,avg_ANPP,x,y)

alltrees<-rbind(pdf,adf,odf)
at2<-alltrees%>%
  dplyr::select(Species,TREE_ID,Year,logF_current)

avgNPP_plot<-ggplot(alltrees,aes(avg_ANPP,meanF_current,color=Species)) +
  geom_point() +
  scale_color_tableau(palette="Tableau 20") +
  geom_smooth(method="lm")
# more productive sites don't necessarily have greater fecundity



# okay let's repeat the analysis but keep year-level data
# is fecundity greater in years following high productivity?
dir<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/ANPP"
files<-paste(dir,list.files(path=dir),sep="/")
ras <- lapply(files,raster) 
vecs<-list(pinus_vec,abies_vec,quercus_vec)

# let's try a quick for-loop
res<-NULL
output<-NULL
for(i in ras) {
  for(j in vecs) {
  dat<-rast(i)
  out<-terra::extract(dat,j,xy=TRUE,bind=TRUE)
  out_df<-as.data.frame(out)%>%
    dplyr::select(Species,TREE_ID,starts_with("X"))%>%
    dplyr::select(-x)%>%
    pivot_longer(3,names_to="Year",values_to="ANPP")%>%
    mutate(Year=gsub("X","",Year))
  res<-rbind(res,out_df)
  }
  output<-rbind(output,res)
}

allNPP<-output%>%
  mutate(Genus=ifelse(Species%in%c("Pinus contorta","Pinus ponderosa","Pinus monticola","Pinus jeffreyi","Pinus lambertiana"),"Pinus",ifelse(Species%in%c("Abies grandis","Abies concolor","Abies magnifica"),"Abies","Quercus")),Year=ifelse(Genus=="Abies",as.numeric(Year)+1,as.numeric(Year)+1))%>%
  full_join(.,at2)%>%
  distinct()%>%
  drop_na()%>%
  group_by(Species,Year)%>%
  mutate(meanANPP=(mean(ANPP)),meanF=(mean(logF_current)),scaleFec=ifelse(Genus=="Abies",meanF/10,meanF*10))


# plot of ANPP year prior to bud initiation and total fecundity
library(ggthemes)
anpp_fecundity<-ggplot(allNPP,aes(log(ANPP),(logF_current),color=Genus)) +
         geom_point(show.legend=FALSE) +
         geom_smooth(method="lm",color="black",show.legend=FALSE) +
  scale_color_colorblind() +
  labs(x="Net Primary Productivity (g C / m^2)",y="log fecundity") +
  facet_wrap(~Genus,scales="free") 

#ggsave("ANPP_fec.png",anpp_fecundity,bg="white")

```







``` {r Precip Lag}
library(sf)
library(raster)
library(terra)
library(sp)


dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)

genus<-"abies"
tmp<-extractGenus(inputs, genus = genus, taxa, plotData)



treeData<-tmp$inputs$treeData # get individual tree data
xytree<-tmp$inputs$xytree # isolate tree location data
seedData<-tmp$inputs$seedData
xytrap<-tmp$inputs$xytrap
seedTraits<-as.data.frame(tmp$inputs$seedTraits)%>%
  mutate(species=rownames(.))






# first, let's prep the tree data
xytree2<-xytree
trees<-merge(treeData,xytree2)
tree_sf<-st_as_sf(trees,coords=c("x","y"),
                  crs = "+proj=utm +zone=11")
tree_transform<- st_transform(tree_sf, crs = "+proj=longlat +datum=WGS84")
tree_crs<-crs(tree_transform) # define the CRS






# first I want to get precip data for t-3 year's fall (i.e., water year)
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-4), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-4),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-4)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,precip_Lag3=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t0.1<-temp%>%
  dplyr::select(-repMu,-repSd,-cropCount,-cropFraction,-cropFractionSd,-cropMin,-cropMax,-fecMin,-fecMax)%>%
  group_by(plot,tree,species,year)%>%
  mutate(Precip_lag3=sum(precip_Lag3))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,Precip_lag3)%>%
  distinct()


# now let's get precip data for spring t-2 years
mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-3), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-3)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,precip_Lag3=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t0.2<-temp%>%
  dplyr::select(-repMu,-repSd,-cropCount,-cropFraction,-cropFractionSd,-cropMin,-cropMax,-fecMin,-fecMax)%>%
  group_by(plot,tree,species,year)%>%
  mutate(Precip_lag3=sum(precip_Lag3))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,Precip_lag3)%>%
  distinct()


t0<-rbind(t0.1,t0.2)%>%
  group_by(plot,tree,species,year)%>%
  mutate(Precip_lag3=sum(Precip_lag3))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,Precip_lag3)%>%
  distinct()






# first I want to get precip data for t-3 year's fall (i.e., water year)
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,precip_Lag2=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t1<-temp%>%
  dplyr::select(-repMu,-repSd,-cropCount,-cropFraction,-cropFractionSd,-cropMin,-cropMax,-fecMin,-fecMax)%>%
  group_by(plot,tree,species,year)%>%
  mutate(Precip_lag2=sum(precip_Lag2))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,Precip_lag2)%>%
  distinct()


# now let's get precip data for spring t-2 years
mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,precip_Lag2=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t1.2<-temp%>%
  dplyr::select(-repMu,-repSd,-cropCount,-cropFraction,-cropFractionSd,-cropMin,-cropMax,-fecMin,-fecMax)%>%
  group_by(plot,tree,species,year)%>%
  mutate(Precip_lag2=sum(precip_Lag2))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,Precip_lag2)%>%
  distinct()


t1.3<-rbind(t1,t1.2)%>%
  group_by(plot,tree,species,year)%>%
  mutate(Precip_lag2=sum(Precip_lag2))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,Precip_lag2)%>%
  distinct()





# OK let's do 1 year prior now
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,precip_Lag1=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t2<-temp%>%
  dplyr::select(-repMu,-repSd,-cropCount,-cropFraction,-cropFractionSd,-cropMin,-cropMax,-fecMin,-fecMax)%>%
  group_by(plot,tree,species,year)%>%
  mutate(Precip_lag1=sum(precip_Lag1))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,Precip_lag1)%>%
  distinct()


# now let's get precip data for spring t-2 years
mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,precip_Lag1=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t2.2<-temp%>%
  dplyr::select(-repMu,-repSd,-cropCount,-cropFraction,-cropFractionSd,-cropMin,-cropMax,-fecMin,-fecMax)%>%
  group_by(plot,tree,species,year)%>%
  mutate(Precip_lag1=sum(precip_Lag1))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,Precip_lag1)%>%
  distinct()


t2.3<-rbind(t2,t2.2)%>%
  group_by(plot,tree,species,year)%>%
  mutate(Precip_lag1=sum(Precip_lag1))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,Precip_lag1)%>%
  distinct()







# I need to get current water year precip
# OK let's do 1 year prior now
mon<-10:12
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,precip=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t2<-temp%>%
  dplyr::select(-repMu,-repSd,-cropCount,-cropFraction,-cropFractionSd,-cropMin,-cropMax,-fecMin,-fecMax)%>%
  group_by(plot,tree,species,year)%>%
  mutate(Precip=sum(precip))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,Precip)%>%
  distinct()


mon<-1:4
years<-unique(trees$year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,precip=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t2.2<-temp%>%
  dplyr::select(-repMu,-repSd,-cropCount,-cropFraction,-cropFractionSd,-cropMin,-cropMax,-fecMin,-fecMax)%>%
  group_by(plot,tree,species,year)%>%
  mutate(Precip=sum(precip))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,Precip)%>%
  distinct()


tcurrent<-rbind(t2,t2.2)%>%
  group_by(plot,tree,species,year)%>%
  mutate(Precip=sum(Precip))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,Precip)%>%
  distinct()










precip<-merge(t1.3,t2.3)%>%
  merge(.,t0)%>%
  merge(.,tcurrent)



```

``` {r Growing Season VPD}
library(sf)
library(raster)
library(terra)
library(sp)


dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)

genus<-"quercus"
tmp<-extractGenus(inputs, genus = genus, taxa, plotData)



treeData<-tmp$inputs$treeData # get individual tree data
xytree<-tmp$inputs$xytree # isolate tree location data
seedData<-tmp$inputs$seedData
xytrap<-tmp$inputs$xytrap
seedTraits<-as.data.frame(tmp$inputs$seedTraits)%>%
  mutate(species=rownames(.))






# first, let's prep the tree data
xytree2<-xytree
trees<-merge(treeData,xytree2)
tree_sf<-st_as_sf(trees,coords=c("x","y"),
                  crs = "+proj=utm +zone=11")
tree_transform<- st_transform(tree_sf, crs = "+proj=longlat +datum=WGS84")
tree_crs<-crs(tree_transform) # define the CRS



# max VPD
mon<-5:8 # set growing season march - september
years<-unique(trees$year)
vars<-"vpdmax"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-1), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(vars, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,VPDmax_lag1=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t1<-temp%>%
  dplyr::select(-repMu,-repSd,-cropCount,-cropFraction,-cropFractionSd,-cropMin,-cropMax,-fecMin,-fecMax)%>%
  group_by(plot,tree,species,year)%>%
  mutate(VPDmax_lag1=mean(VPDmax_lag1))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,VPDmax_lag1)%>%
  distinct()



# min VPD
mon<-5:8 # set growing season march - september
years<-unique(trees$year)
vars<-"vpdmin"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-1), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(vars, "monthly", years =(i-1),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-1)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,VPDmin_lag1=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t2<-temp%>%
  dplyr::select(-repMu,-repSd,-cropCount,-cropFraction,-cropFractionSd,-cropMin,-cropMax,-fecMin,-fecMax)%>%
  group_by(plot,tree,species,year)%>%
  mutate(VPDmin_lag1=mean(VPDmin_lag1))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,VPDmin_lag1)%>%
  distinct()


vpd_lag1<-merge(t1,t2)%>%
  mutate(VPD_lag1=(VPDmax_lag1+VPDmin_lag1)/2)%>%
  distinct(plot,tree,species,year,VPD_lag1)%>%
  mutate(VPDs_lag1=scale(VPD_lag1))





# lag 2 years
# max VPD
mon<-5:8 # set growing season march - september
years<-unique(trees$year)
vars<-"vpdmax"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(vars, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,VPDmax_lag2=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t1<-temp%>%
  dplyr::select(-repMu,-repSd,-cropCount,-cropFraction,-cropFractionSd,-cropMin,-cropMax,-fecMin,-fecMax)%>%
  group_by(plot,tree,species,year)%>%
  mutate(VPDmax_lag2=mean(VPDmax_lag2))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,VPDmax_lag2)%>%
  distinct()



# min VPD
mon<-5:8 # set growing season march - september
years<-unique(trees$year)
vars<-"vpdmin"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(vars, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(tree_transform,year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,VPDmin_lag2=31)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t2<-temp%>%
  dplyr::select(-repMu,-repSd,-cropCount,-cropFraction,-cropFractionSd,-cropMin,-cropMax,-fecMin,-fecMax)%>%
  group_by(plot,tree,species,year)%>%
  mutate(VPDmin_lag2=mean(VPDmin_lag2))%>%
  ungroup()%>%
  dplyr::select(plot,tree,species,year,VPDmin_lag2)%>%
  distinct()


vpd_lag2<-merge(t1,t2)%>%
  mutate(VPD_lag2=(VPDmax_lag2+VPDmin_lag2)/2)%>%
  distinct(plot,tree,species,year,VPD_lag2)%>%
  mutate(VPDs_lag2=scale(VPD_lag2))


vpd<-merge(vpd_lag1,vpd_lag2)

```

``` {r soil P}


library(raster)
library(terra)
pdf<-raster("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/ptif.tif")
plot(pdf)
rpdf<-rast(pdf)



dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)
genus<-"pinus"
tmp<-extractGenus(inputs, genus = genus, taxa, plotData)
treeData<-tmp$inputs$treeData # get individual tree data
xytree<-tmp$inputs$xytree # isolate tree location data
seedData<-tmp$inputs$seedData
xytrap<-tmp$inputs$xytrap
seedTraits<-as.data.frame(tmp$inputs$seedTraits)%>%
  mutate(species=rownames(.))
# first, let's prep the tree data
xytree2<-xytree
trees<-merge(treeData,xytree2)
tree_sf<-st_as_sf(trees,coords=c("x","y"),
                  crs = "+proj=utm +zone=11")
tree_transform<- st_transform(tree_sf, crs = "+proj=longlat +datum=WGS84")
tree_crs<-crs(tree_transform) # define the CRS
tree_vec<-vect(tree_transform) # convert tree file to spatial vector
EXT<-extract(rpdf,tree_vec,xy=TRUE,bind=TRUE) 

soilP<-as.data.frame(EXT)%>%
  rename(P=Band_1)%>%
  dplyr::select(-x,-y)




```

``` {r BCM data}

# load in tree points data
treepoints<-read.csv('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/BCM/OutTables/XWalk_TreePoints_2_BCMbasins.csv')%>%
  mutate(tree=gsub(".*-","",F1))%>%
  dplyr::select(BCM_Basin,plot,tree)%>%
  rename(Basin=BCM_Basin)




# load in monthly BCM data
bcm<-read.table('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/BCM/OutTables/alextrees_mo_v8_huc8.txt',header=TRUE)%>%
  filter(Year>=1980)%>%
  dplyr::select(Year,Month,Basin,ppt_mm,pet_mm,tav_C,snw_mm,cwd_mm)


# merge tree and bcm data
treebcm<-merge(treepoints,bcm)


# isolate some water year data
wy<-treebcm%>%
  filter(Month%in%10:12)%>%
  mutate(Year=Year+1)%>%
  dplyr::select(plot,tree,Year,ppt_mm,snw_mm)%>%
  group_by(plot,tree,Year)%>%
  mutate(Precip=sum(ppt_mm),Snow=sum(snw_mm))%>%
  dplyr::select(-ppt_mm,-snw_mm)%>%
  distinct()

wy2<-treebcm%>%
  filter(Month%in%1:3)%>%
  dplyr::select(plot,tree,Year,ppt_mm,snw_mm)%>%
  group_by(plot,tree,Year)%>%
  mutate(Precip=sum(ppt_mm),Snow=sum(snw_mm))%>%
  dplyr::select(-ppt_mm,-snw_mm)%>%
  distinct()


wy_all<-rbind(wy,wy2)%>%
  group_by(plot,tree,Year)%>%
  mutate(Precip=sum(Precip),Snow=sum(Snow))%>%
  distinct()


sumT<-treebcm%>%
  filter(Month%in%1:12)%>%
  dplyr::select(plot,tree,Year,tav_C,cwd_mm,pet_mm)%>%
  group_by(plot,tree,Year)%>%
  mutate(T_avg=mean(tav_C),CWD_avg=mean(cwd_mm))%>%
  dplyr::select(-tav_C,-cwd_mm)%>%
  distinct()

# now make lag variables
all_clim<-merge(wy_all,sumT)%>%
  dplyr::select(-pet_mm)%>%
  arrange(plot,tree,Year)%>%
  group_by(plot,tree)%>%
  distinct()%>%
  mutate(Precip_lag1=lag(Precip),
         Precip_lag2=lag(lag(Precip)),
         Snow_lag1=lag(Snow),
         Snow_lag2=lag(lag(Snow)),
         T_avg_lag1=lag(T_avg),
         T_avg_lag2=lag(lag(T_avg)),
         CWD_avg_lag1=lag(CWD_avg),
         CWD_avg_lag2=lag(lag(CWD_avg)),
         Precip_lag3=lag(lag(lag(Precip))),
         Precip_lag4=lag(lag(lag(lag(Precip)))),
         Snow_lag3=lag(lag(lag(Snow))),
         Snow_lag4=lag(lag(lag(lag(Snow)))),
         T_avg_lag3=lag(lag(lag(T_avg))),
         T_avg_lag4=lag(lag(lag(lag(T_avg)))),
         CWD_avg_lag3=lag(lag(lag(CWD_avg))),
         CWD_avg_lag4=lag(lag(lag(lag(CWD_avg)))))%>%
  #dplyr::select(-Precip,-Snow,-T_min,-CWD_avg,-PET)%>%
  drop_na()%>%
  distinct()%>%
  rename(year=Year)



```

``` {r Pinus BCM data}

# load in tree points data
treepoints<-read.csv('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/BCM/OutTables/XWalk_TreePoints_2_BCMbasins.csv')%>%
  mutate(tree=gsub(".*-","",F1))%>%
  dplyr::select(BCM_Basin,plot,tree)%>%
  rename(Basin=BCM_Basin)




# load in monthly BCM data
bcm<-read.table('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/BCM/OutTables/alextrees_mo_v8_huc8.txt',header=TRUE)%>%
  filter(Year>=1980)%>%
  dplyr::select(Year,Month,Basin,ppt_mm,pet_mm,tav_C,snw_mm,cwd_mm)


# merge tree and bcm data
treebcm<-merge(treepoints,bcm)

# first isolate the initiation month / year climate variables
# focusing on temperature and precipitation 
# August - Oct; t-3 years
# no rain in CA in aug - oct so use previous water year total precip as predictor

# isolate some water year data
wy<-treebcm%>%
  filter(Month%in%10:12)%>%
  mutate(Year=Year+1)%>%
  dplyr::select(plot,tree,Year,ppt_mm)%>%
  group_by(plot,tree,Year)%>%
  mutate(Precip=mean(ppt_mm))%>%
  dplyr::select(-ppt_mm)%>%
  distinct()

wy2<-treebcm%>%
  filter(Month%in%1:4)%>%
  dplyr::select(plot,tree,Year,ppt_mm)%>%
  group_by(plot,tree,Year)%>%
  mutate(Precip=mean(ppt_mm))%>%
  dplyr::select(-ppt_mm)%>%
  distinct()


wy_all<-rbind(wy,wy2)%>%
  group_by(plot,tree,Year)%>%
  mutate(Precip=mean(Precip))%>%
  distinct()


# now do temperature of cone bud development time frame
sumT<-treebcm%>%
  filter(Month%in%8:10)%>%
  dplyr::select(plot,tree,Year,tav_C)%>%
  group_by(plot,tree,Year)%>%
  mutate(T_avg=mean(tav_C))%>%
  dplyr::select(-tav_C)%>%
  distinct()


# now make lag variables
pollInit<-merge(wy_all,sumT)%>%
  distinct()%>%
  rename(year=Year)%>%
  mutate(P3=scale(lag(lag(lag(Precip)))),T3=scale(lag(lag(lag(T_avg)))))%>%
  rename(P3=6,T3=7)%>%
  drop_na()



# now let's isolate pollen development month / year climate variables
# focusing on temperature and precipitation 
# April - June; t-3 years
# no rain in CA in April - June so use previous water year total precip as predictor



# now do temperature of cone bud development time frame
sumT<-treebcm%>%
  filter(Month%in%4:6)%>%
  dplyr::select(plot,tree,Year,tav_C)%>%
  group_by(plot,tree,Year)%>%
  mutate(T_avg=mean(tav_C))%>%
  dplyr::select(-tav_C)%>%
  distinct()


aj<-merge(wy_all,sumT)%>%
  distinct()%>%
  rename(year=Year)%>%
  mutate(P2=scale(lag(lag(Precip))),T2=scale(lag(lag(T_avg))))%>%
  rename(P2=6,T2=7)%>%
  dplyr::select(-Precip,-T_avg)





# let's look at temperature of the final seed development year and precip of preceding winter (t-1)
sumT<-treebcm%>%
  filter(Month%in%5:9)%>%
  dplyr::select(plot,tree,Year,tav_C)%>%
  group_by(plot,tree,Year)%>%
  mutate(T_avg=mean(tav_C))%>%
  dplyr::select(-tav_C)%>%
  distinct()


aj2<-merge(wy_all,sumT)%>%
  distinct()%>%
  rename(year=Year)%>%
  mutate(P1=scale((lag(Precip))),T1=scale((lag(T_avg))))%>%
  rename(P1=6,T1=7)%>%
  dplyr::select(-Precip,-T_avg)

# now make lag variables
pollInit3<-merge(pollInit2,aj2)%>%
  distinct()



```

``` {r look at individual traps for pinus}


dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)
genus<-"pinus"
tmp<-extractGenus(inputs, genus = genus, taxa, plotData)
treeData<-tmp$inputs$treeData # get individual tree data
xytree<-tmp$inputs$xytree # isolate tree location data
seedData<-tmp$inputs$seedData
xytrap<-tmp$inputs$xytrap
seedTraits<-as.data.frame(tmp$inputs$seedTraits)%>%
  mutate(species=rownames(.))


drop<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/Moran & Das SEKI Input/SEKITrapXY.csv")%>%
  distinct(plot)%>%
  mutate(plot=gsub("_","",plot))

p<-drop[24,]

keep<-c("SEQUBBBPIPO","SEQUEMRIDGE","SEQUFFS6BURN","SEQUFFS7CONTROL","SEQULOTHAR","SEQUUPLOG")

bad<-c("YOSECRCRPIPO","SEQUEMSLOPE","SEQUFFS2BURN","SEQUFFS5BURN","SEQUFRPIJE","SEQULMCC","SEQULOGSEGI","SEQULOLOG","SEQUPGABMA","YOSEPOFLABMA","YOSESFTRABMA","SEQUUPTHAR","SEQUWTABMA","YOSEYOHOPIPO","SEQUCCRPIPO","SEQUEMSALIX","SEQULOGPIJE","SEQUSU")






xytrap2<- xytrap%>%
 filter(plot==p)


xytrap2<-xytrap%>%
 filter(plot==p,trap%in%ids)


ggplot(xytrap2,aes(x,y)) +
  #geom_point() +
  geom_text(aes(label=trap))



p<-keep[3]

# make a subset of data just to make things run faster
treeData2<-merge(treeData,all_clim)%>%
 filter(plot==p)%>%
  distinct()

  
treeData2<-as.data.frame(treeData2)
seedData2<-seedData%>%
 filter(plot==p)%>%
  distinct(plot,trap,year,.keep_all = TRUE)%>%
  drop_na()
  #mutate(abiesAmabilis=round(abiesAmabilis,0),abiesProcera=round(abiesProcera,0))
xytree2<-xytree%>%
 filter(plot==p)%>%
  distinct()
xytrap2<-xytrap%>%
  filter(plot==p)%>%
  #filter(plot==p,trap%in%ids)%>%
  distinct(plot,trap,.keep_all = TRUE)
  

  
# OK let's try to run MASTIF now
seednames<-seedData2%>%
  pivot_longer(cols=c(6,8:10,12,13),names_to="seedName",values_to="count")%>%
  distinct(seedName)
seeds<-c(unique(seednames$seedName))

plist<-data.frame(plot=unique(treeData2$plot))
seed_data<-merge(seedData2,plist)




formulaRep <- as.formula( ~ diam)   # maturation model

yearEffect   <- list( groups = c('species','ecoRegWWF'), p = 2)   # AR( 4 ) 
randomEffect <- list( randGroups = 'tree', 
                     formulaRan = as.formula( ~ 1 ) )
betaPrior  <- list( pos = 'diam', neg = 'I( diam^2 )' )

specNames<-seeds[seeds!='pinusUNKN']
#specNames<-'pinusPonderos'
seedNames<-seeds


priors<-list(
  minDiam=0.1,
  priorDist=10,
  priorVDist=1
)
#treeData2$cropCount<-as.integer(treeData2$cropCount)
inputs   <- list( specNames = specNames, seedNames = seedNames,
                  treeData = treeData2, seedData = seed_data, 
                  betaPrior=betaPrior,
                  #priorList=priors,
                  yearEffect = yearEffect, 
                  randomEffect=randomEffect,
                  #priorDist=2,priorVDist=1,
                  #maxF=1e+8,minDist=2,maxDist =5,
                  xytree = xytree2, xytrap = xytrap2)


  
# now let's take the top models and run outputs for those

fecForms<-as.formula(~diam)

  
  output <- mastif( inputs = inputs, formulaFec=fecForms, formulaRep, ng = 1000, burnin = 500)
  mastPlot(output)
  
  

  
plot(output[["prediction"]][["seedPred"]][["countPerTrap"]],output[["prediction"]][["seedPred"]][["predMeanTrap"]])
abline(a=0,b=1)

plot(output[["prediction"]][["seedPred"]][["countPerTrap"]],output[["prediction"]][["seedPred"]][["estMeanTrap"]])
abline(a=0,b=1)
  

dataTab <- table( treeData2$plot, treeData2$year )

w <- which( dataTab > 0, arr.ind=T ) # a plot-year with observations
w <- w[sample( nrow( w ), 1 ), ]

mapYears <- 2020
mapPlot  <- rownames( dataTab )[w[1]]
inputs$mapPlot    <- mapPlot
inputs$mapYears   <- mapYears
inputs$treeSymbol <- treeData2$diam
inputs$SCALEBAR   <- T
inputs$treeScale  <- .3
inputs$trapScale  <- 2

mastMap( inputs )

output$mapPlot    <- mapPlot
output$mapYears   <- mapYears
output$treeSymbol <- treeData2$diam
output$SCALEBAR   <- T
output$treeScale  <- .3
output$trapScale  <- 2
mastMap(output)


ggplot(xytrap2,aes(x,y)) +
  #geom_point() +
  geom_text(aes(label=trap))




trees<-treeData2%>%
  filter(year==2018)%>%
  merge(.,xytree2)

ggplot(xytrap2,aes(x,y)) +
  #geom_point() +
  geom_text(aes(label=trap)) +
  geom_point(data=trees,aes(x,y,color=diam)) +
  scale_color_gradient(low="white",high="red")




# I wonder if it is offset by a few traps with many seeds and many with low seeds? can we filter to just those?
seedtest<-seedData2%>%
  dplyr::select(trap,year,pinusLamberti,pinusPonderos)%>%
  pivot_longer(cols=3:4,names_to="Species",values_to="Count")%>%
  filter(Species!='pinusLamberti')%>%
  filter(year<=2010)

ggplot(seedtest,aes(year,(Count),color=Species,group=Species)) +
  geom_line() +
  theme_minimal() +
  facet_wrap(Species~trap,scales="fixed")



sp<-output[["prediction"]][["seedPred"]]

ggplot(sp,aes((countPerTrap),log(estMeanTrap))) +
  geom_point() +
  theme_minimal() +
  facet_wrap(~trapID,scales="free")


ggplot(treeData2,aes(year,diam,color=tree,group=tree)) +
  geom_line(show.legend=FALSE)



```

``` {r Calocedrus MASTIF run}


dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)
genus<-"calocedrus"
tmp<-extractGenus(inputs, genus = genus, taxa, plotData)
treeData<-tmp$inputs$treeData # get individual tree data
xytree<-tmp$inputs$xytree # isolate tree location data
seedData<-tmp$inputs$seedData
xytrap<-tmp$inputs$xytrap
seedTraits<-as.data.frame(tmp$inputs$seedTraits)%>%
  mutate(species=rownames(.))



drop<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/Moran & Das SEKI Input/SEKITrapXY.csv")%>%
  distinct(plot)%>%
  mutate(plot=gsub("_","",plot))

# make a subset of data just to make things run faster
treeData2<-merge(treeData,all_clim)%>%
  filter(!plot %in% drop$plot)%>%
  filter(plot!='UCSCFERP',plot!='WREFWFDP',plot!="SEQJ",plot!="SOAP001",plot!="SOAP002",plot!="SOAP004",plot!="SOAP008",plot!="SOAP011")%>%
  distinct()

treeData2<-as.data.frame(treeData2)
seedData2<-seedData%>%
  filter(!plot %in% drop$plot)%>%
  filter(plot!='UCSCFERP',plot!='WREFWFDP',plot!="SEQJ",plot!="SOAP001",plot!="SOAP002",plot!="SOAP004",plot!="SOAP008",plot!="SOAP011")%>%
  distinct(plot,trap,year,.keep_all = TRUE)
  #mutate(abiesAmabilis=round(abiesAmabilis,0),abiesProcera=round(abiesProcera,0))
xytree2<-xytree%>%
  filter(!plot %in% drop$plot)%>%
 filter(plot!='UCSCFERP',plot!='WREFWFDP',plot!="SEQJ",plot!="SOAP001",plot!="SOAP002",plot!="SOAP004",plot!="SOAP008",plot!="SOAP011")%>%
  distinct()
xytrap2<-xytrap%>%
  filter(!plot %in% drop$plot)%>%
  filter(plot!='UCSCFERP',plot!='WREFWFDP',plot!="SEQJ",plot!="SOAP001",plot!="SOAP002",plot!="SOAP004",plot!="SOAP008",plot!="SOAP011")%>%
  distinct(plot,trap,.keep_all = TRUE)
priors<-tmp$inputs$priorTable
  
 
  
# OK let's try to run MASTIF now
seednames<-seedData2%>%
  pivot_longer(cols=c(6),names_to="seedName",values_to="count")%>%
  distinct(seedName)
seeds<-unique(treeData2$species)

plist<-data.frame(plot=unique(treeData2$plot))
seed_data<-merge(seedData2,plist)




fecForms<-list(
  f1=as.formula(~diam),
  f2=as.formula(~diam+I(diam^2)),
  f3=as.formula(~diam+I(diam^2)+Precip_lag3),
  #f4=as.formula(~diam+I(diam^2)+Precip_lag3+diam:Precip_lag3),
  f5=as.formula(~diam+I(diam^2)+Precip_lag4),
  #f6=as.formula(~diam+I(diam^2)+Precip_lag4+diam:Precip_lag4),
  f7=as.formula(~diam+I(diam^2)+Snow_lag3),
  #f8=as.formula(~diam+I(diam^2)+Snow_lag3+diam:Snow_lag3),
  f9=as.formula(~diam+I(diam^2)+Snow_lag4),
 # f10=as.formula(~diam+I(diam^2)+Snow_lag4+diam:Snow_lag4),
  f11=as.formula(~diam+I(diam^2)+T_avg_lag3),
 # f12=as.formula(~diam+I(diam^2)+T_avg_lag3+diam:T_avg_lag3),
  f13=as.formula(~diam+I(diam^2)+T_avg_lag4),
  #f14=as.formula(~diam+I(diam^2)+T_avg_lag4+diam:T_avg_lag4),
  f15=as.formula(~diam+I(diam^2)+CWD_avg_lag3),
  #f16=as.formula(~diam+I(diam^2)+CWD_avg_lag3+diam:CWD_avg_lag3),
  f17=as.formula(~diam+I(diam^2)+CWD_avg_lag4),
  #f18=as.formula(~diam+I(diam^2)+CWD_avg_lag4+diam:CWD_avg_lag4),
  f19=as.formula(~diam+I(diam^2)+Precip_lag3+T_avg_lag3),
  #f20=as.formula(~diam+I(diam^2)+Precip_lag3+T_avg_lag3+diam:Precip_lag3+diam:T_avg_lag3),
  f21=as.formula(~diam+I(diam^2)+Precip_lag4+T_avg_lag4),
 # f22=as.formula(~diam+I(diam^2)+Precip_lag4+T_avg_lag4+diam:Precip_lag4+diam:T_avg_lag4),
  f23=as.formula(~diam+I(diam^2)+Precip_lag3+Precip_lag4+T_avg_lag3+T_avg_lag4+diam:Precip_lag3+diam:T_avg_lag3+diam:Precip_lag4+diam:T_avg_lag4),
  
  
  
  
  f24=as.formula(~diam+I(diam^2)+Precip_lag1),
 # f25=as.formula(~diam+I(diam^2)+Precip_lag1+diam:Precip_lag1),
  f26=as.formula(~diam+I(diam^2)+Precip_lag2),
  #f27=as.formula(~diam+I(diam^2)+Precip_lag2+diam:Precip_lag2),
  f28=as.formula(~diam+I(diam^2)+Snow_lag1),
  #f29=as.formula(~diam+I(diam^2)+Snow_lag1+diam:Snow_lag1),
  f30=as.formula(~diam+I(diam^2)+Snow_lag2),
  #f31=as.formula(~diam+I(diam^2)+Snow_lag2+diam:Snow_lag2),
  f32=as.formula(~diam+I(diam^2)+T_avg_lag1),
  #f33=as.formula(~diam+I(diam^2)+T_avg_lag1+diam:T_avg_lag1),
  f34=as.formula(~diam+I(diam^2)+T_avg_lag2),
  #f35=as.formula(~diam+I(diam^2)+T_avg_lag2+diam:T_avg_lag2),
  f36=as.formula(~diam+I(diam^2)+CWD_avg_lag1),
  #f37=as.formula(~diam+I(diam^2)+CWD_avg_lag1+diam:CWD_avg_lag1),
  f38=as.formula(~diam+I(diam^2)+CWD_avg_lag2),
 # f39=as.formula(~diam+I(diam^2)+CWD_avg_lag2+diam:CWD_avg_lag2),
  f40=as.formula(~diam+I(diam^2)+Precip_lag1+T_avg_lag1),
  #f41=as.formula(~diam+I(diam^2)+Precip_lag1+T_avg_lag1+diam:Precip_lag1+diam:T_avg_lag1),
  f42=as.formula(~diam+I(diam^2)+Precip_lag2+T_avg_lag2),
 # f43=as.formula(~diam+I(diam^2)+Precip_lag2+T_avg_lag2+diam:Precip_lag2+diam:T_avg_lag2),
  f44=as.formula(~diam+I(diam^2)+Precip_lag1+Precip_lag2+T_avg_lag1+T_avg_lag2+diam:Precip_lag1+diam:T_avg_lag1+diam:Precip_lag2+diam:T_avg_lag2),
  f45=as.formula(~diam+I(diam^2)+CWD_avg_lag1+CWD_avg_lag2+diam:CWD_avg_lag1+diam:CWD_avg_lag2+CWD_avg_lag3+CWD_avg_lag4+diam:CWD_avg_lag3+diam:CWD_avg_lag4 + CWD_avg_lag1:CWD_avg_lag2 + CWD_avg_lag3:CWD_avg_lag4 + CWD_avg_lag1:CWD_avg_lag2:CWD_avg_lag3 + CWD_avg_lag1:CWD_avg_lag2:CWD_avg_lag3:CWD_avg_lag4),
  
 #f46=as.formula(~diam+I(diam^2)+CWD_avg+diam:CWD_avg)
)



formulaRep <- as.formula( ~ diam)   # maturation model

yearEffect   <- list( groups = c('species','ecoRegWWF'), p = 6)   # AR( 4 ) 
randomEffect <- list( randGroups = 'tree', 
                     formulaRan = as.formula( ~ 1 ) )
betaPrior  <- list( pos = 'diam', neg = 'I( diam^2 )' )

specNames<-seeds
seedNames<-seeds



#treeData2$cropCount<-as.integer(treeData2$cropCount)
inputs   <- list( specNames = specNames, seedNames = seedNames,
                  treeData = treeData2, seedData = seed_data, 
                  betaPrior=betaPrior,
                  #priorTable=priors,
                  yearEffect = yearEffect, 
                  randomEffect=randomEffect,
                  maxF=1e+8,
                  xytree = xytree2, xytrap = xytrap2)
  
  plotPars<-list()
  plotPars$SAVEPLOTS=T
  res<-NULL
  path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code"
  
  for(i in fecForms) {
    output <- mastif( inputs = inputs, formulaFec=i, formulaRep, ng = 5000, burnin = 2500)
    DICtrap<-output[["fit"]][["DICtrap"]]
    DICcrop<-output[["fit"]][["DICcrop"]]
   # betaFec<-(output[["parameters"]][["betaFec"]])
    out<-data.frame(Model=as.character(i)[2],DICtrap=DICtrap,DICcrop=DICcrop)
    res<-rbind(res,out)
   #newfolder <- paste0(genus,"_beta_prior","_",sub(" + ","_",i)[2])
    #dir.create(path=paste0(path,"/",newfolder))
  #knitr::opts_knit$set(root.dir = paste0(path,"/",newfolder))
   #setwd(paste0(path,"/",newfolder))
  # getwd()
   #name<-paste0(newfolder,"_betaFec.csv")
   #write.csv(betaFec,file=name)
   # mastPlot(output,plotPars)
  }
  
  
  
  
# now let's take the top models and run outputs for those

fecForms<-list(f1=as.formula(~diam+I(diam^2)+CWD_avg_lag1),
               f2=as.formula(~diam+I(diam^2)+Precip_lag2),
               f3=as.formula(~diam))


  plotPars<-list()
  plotPars$SAVEPLOTS=T
  res<-NULL
  path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code"
  
  for(i in fecForms) {
    output <- mastif( inputs = inputs, formulaFec=i, formulaRep, ng = 5000, burnin = 2500)
    DICtrap<-output[["fit"]][["DICtrap"]]
    DICcrop<-output[["fit"]][["DICcrop"]]
    betaFec<-(output[["parameters"]][["betaFec"]])
    out<-data.frame(Model=as.character(i)[2],DICtrap=DICtrap,DICcrop=DICcrop)
    res<-rbind(res,out)
   newfolder <- paste0(genus,"_beta_prior","_",sub(" + ","_",i)[2])
    dir.create(path=paste0(path,"/",newfolder))
   setwd(paste0(path,"/",newfolder))
  getwd()
   name<-paste0(newfolder,"_betaFec.csv")
   write.csv(betaFec,file=name)
   mastPlot(output,plotPars)
  }







```

``` {r Pseudotsuga MASTIF run}


dataFile <- '/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/West Coast data/mastifDataWestCoast.rdata'
load(dataFile)
genus<-"pseudotsuga"
tmp<-extractGenus(inputs, genus = genus, taxa, plotData)
treeData<-tmp$inputs$treeData # get individual tree data
xytree<-tmp$inputs$xytree # isolate tree location data
seedData<-tmp$inputs$seedData
xytrap<-tmp$inputs$xytrap
seedTraits<-as.data.frame(tmp$inputs$seedTraits)%>%
  mutate(species=rownames(.))



drop<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/Moran & Das SEKI Input/SEKITrapXY.csv")%>%
  distinct(plot)%>%
  mutate(plot=gsub("_","",plot))

# make a subset of data just to make things run faster
treeData2<-merge(treeData,all_clim)%>%
  #filter(!plot %in% drop$plot)%>%
  #filter(plot!='UCSCFERP',plot!='WREFWFDP',plot!="SEQJ",plot!="SOAP001",plot!="SOAP002",plot!="SOAP004",plot!="SOAP008",plot!="SOAP011")%>%
  distinct()


  
treeData2<-as.data.frame(treeData2)
seedData2<-seedData%>%
  #filter(!plot %in% drop$plot)%>%
  #filter(plot!='UCSCFERP',plot!='WREFWFDP')%>%
  distinct(plot,trap,year,.keep_all = TRUE)%>%
  drop_na()
  
xytree2<-xytree%>%
  #filter(!plot %in% drop$plot)%>%
  #filter(plot!='UCSCFERP',plot!='WREFWFDP')%>%
  distinct()
xytrap2<-xytrap%>%
  #filter(!plot %in% drop$plot)%>%
  #filter(plot!='UCSCFERP',plot!='WREFWFDP')%>%
  distinct(plot,trap,.keep_all = TRUE)
priors<-tmp$inputs$priorTable
  
 
  
# OK let's try to run MASTIF now
seednames<-seedData2%>%
  pivot_longer(cols=c(6),names_to="seedName",values_to="count")%>%
  distinct(seedName)
seeds<-c(unique(treeData2$species))

plist<-data.frame(plot=unique(treeData2$plot))
seed_data<-merge(seedData2,plist)


fecForms<-list(
  f1=as.formula(~diam),
  f2=as.formula(~diam+I(diam^2)),
  f3=as.formula(~diam+I(diam^2)+Precip_lag3),
  #f4=as.formula(~diam+I(diam^2)+Precip_lag3+diam:Precip_lag3),
  f5=as.formula(~diam+I(diam^2)+Precip_lag4),
  #f6=as.formula(~diam+I(diam^2)+Precip_lag4+diam:Precip_lag4),
  f7=as.formula(~diam+I(diam^2)+Snow_lag3),
  #f8=as.formula(~diam+I(diam^2)+Snow_lag3+diam:Snow_lag3),
  f9=as.formula(~diam+I(diam^2)+Snow_lag4),
 # f10=as.formula(~diam+I(diam^2)+Snow_lag4+diam:Snow_lag4),
  f11=as.formula(~diam+I(diam^2)+T_avg_lag3),
 # f12=as.formula(~diam+I(diam^2)+T_avg_lag3+diam:T_avg_lag3),
  f13=as.formula(~diam+I(diam^2)+T_avg_lag4),
  #f14=as.formula(~diam+I(diam^2)+T_avg_lag4+diam:T_avg_lag4),
  f15=as.formula(~diam+I(diam^2)+CWD_avg_lag3),
  #f16=as.formula(~diam+I(diam^2)+CWD_avg_lag3+diam:CWD_avg_lag3),
  f17=as.formula(~diam+I(diam^2)+CWD_avg_lag4),
  #f18=as.formula(~diam+I(diam^2)+CWD_avg_lag4+diam:CWD_avg_lag4),
  f19=as.formula(~diam+I(diam^2)+Precip_lag3+T_avg_lag3),
  #f20=as.formula(~diam+I(diam^2)+Precip_lag3+T_avg_lag3+diam:Precip_lag3+diam:T_avg_lag3),
  f21=as.formula(~diam+I(diam^2)+Precip_lag4+T_avg_lag4),
 # f22=as.formula(~diam+I(diam^2)+Precip_lag4+T_avg_lag4+diam:Precip_lag4+diam:T_avg_lag4),
  f23=as.formula(~diam+I(diam^2)+Precip_lag3+Precip_lag4+T_avg_lag3+T_avg_lag4+diam:Precip_lag3+diam:T_avg_lag3+diam:Precip_lag4+diam:T_avg_lag4),
  
  
  
  
  f24=as.formula(~diam+I(diam^2)+Precip_lag1),
 # f25=as.formula(~diam+I(diam^2)+Precip_lag1+diam:Precip_lag1),
  f26=as.formula(~diam+I(diam^2)+Precip_lag2),
  #f27=as.formula(~diam+I(diam^2)+Precip_lag2+diam:Precip_lag2),
  f28=as.formula(~diam+I(diam^2)+Snow_lag1),
  #f29=as.formula(~diam+I(diam^2)+Snow_lag1+diam:Snow_lag1),
  f30=as.formula(~diam+I(diam^2)+Snow_lag2),
  #f31=as.formula(~diam+I(diam^2)+Snow_lag2+diam:Snow_lag2),
  f32=as.formula(~diam+I(diam^2)+T_avg_lag1),
  #f33=as.formula(~diam+I(diam^2)+T_avg_lag1+diam:T_avg_lag1),
  f34=as.formula(~diam+I(diam^2)+T_avg_lag2),
  #f35=as.formula(~diam+I(diam^2)+T_avg_lag2+diam:T_avg_lag2),
  f36=as.formula(~diam+I(diam^2)+CWD_avg_lag1),
  #f37=as.formula(~diam+I(diam^2)+CWD_avg_lag1+diam:CWD_avg_lag1),
  f38=as.formula(~diam+I(diam^2)+CWD_avg_lag2),
 # f39=as.formula(~diam+I(diam^2)+CWD_avg_lag2+diam:CWD_avg_lag2),
  f40=as.formula(~diam+I(diam^2)+Precip_lag1+T_avg_lag1),
  #f41=as.formula(~diam+I(diam^2)+Precip_lag1+T_avg_lag1+diam:Precip_lag1+diam:T_avg_lag1),
  f42=as.formula(~diam+I(diam^2)+Precip_lag2+T_avg_lag2),
 # f43=as.formula(~diam+I(diam^2)+Precip_lag2+T_avg_lag2+diam:Precip_lag2+diam:T_avg_lag2),
  f44=as.formula(~diam+I(diam^2)+Precip_lag1+Precip_lag2+T_avg_lag1+T_avg_lag2+diam:Precip_lag1+diam:T_avg_lag1+diam:Precip_lag2+diam:T_avg_lag2),
  f45=as.formula(~diam+I(diam^2)+CWD_avg_lag1+CWD_avg_lag2+diam:CWD_avg_lag1+diam:CWD_avg_lag2+CWD_avg_lag3+CWD_avg_lag4+diam:CWD_avg_lag3+diam:CWD_avg_lag4 + CWD_avg_lag1:CWD_avg_lag2 + CWD_avg_lag3:CWD_avg_lag4 + CWD_avg_lag1:CWD_avg_lag2:CWD_avg_lag3 + CWD_avg_lag1:CWD_avg_lag2:CWD_avg_lag3:CWD_avg_lag4)
  
 #f46=as.formula(~diam+I(diam^2)+CWD_avg+diam:CWD_avg)
)


formulaRep <- as.formula( ~ diam)   # maturation model

yearEffect   <- list( groups = c('tree'), p = 4)   # AR( 4 ) 
randomEffect <- list( randGroups = 'tree', 
                     formulaRan = as.formula( ~ 1 ) )
betaPrior  <- list( pos = 'diam', neg = 'I( diam^2 )' )

specNames<-seeds
#specNames<-"pinusPonderos"
seedNames<-seeds
#seedNames<-c("pinusPonderos","pinusUNKN")


#treeData2$cropCount<-as.integer(treeData2$cropCount)
inputs   <- list( specNames = specNames, seedNames = seedNames,
                  treeData = treeData2, seedData = seed_data, 
                  betaPrior=betaPrior,
                  #priorTable=priors,
                  #yearEffect = yearEffect, 
                  randomEffect=randomEffect,
                  maxF=1e+8,
                  xytree = xytree2, xytrap = xytrap2)
  
  plotPars<-list()
  plotPars$SAVEPLOTS=T
  res<-NULL
  path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code"
  
  for(i in fecForms) {
    output <- mastif( inputs = inputs, formulaFec=i, formulaRep, ng = 50000, burnin = 25000)
    DICtrap<-output[["fit"]][["DICtrap"]]
    #DICcrop<-output[["fit"]][["DICcrop"]]
    betaFec<-(output[["parameters"]][["betaFec"]])
    out<-data.frame(Model=as.character(i)[2],DICtrap=DICtrap)
    res<-rbind(res,out)
   #newfolder <- paste0(genus,"_beta_prior","_",sub(" + ","_",i)[2])
    #dir.create(path=paste0(path,"/",newfolder))
  #knitr::opts_knit$set(root.dir = paste0(path,"/",newfolder))
   #setwd(paste0(path,"/",newfolder))
  # getwd()
   #name<-paste0(newfolder,"_betaFec.csv")
   #write.csv(betaFec,file=name)
   # mastPlot(output,plotPars)
  }
  
  
  
  
# now let's take the top models and run outputs for those

fecForms<-list(f1=as.formula(~diam + I(diam^2) + Precip_lag3 + Precip_lag4 + T_avg_lag3 + T_avg_lag4 + diam:Precip_lag3 + diam:T_avg_lag3 + diam:Precip_lag4 + diam:T_avg_lag4),
               f2=as.formula(~diam + I(diam^2) + Precip_lag1 + Precip_lag2 + T_avg_lag1 + T_avg_lag2 + diam:Precip_lag1 + diam:T_avg_lag1 + diam:Precip_lag2 + diam:T_avg_lag2),
               f3=as.formula(~diam + I(diam^2) + Snow_lag3))


  plotPars<-list()
  plotPars$SAVEPLOTS=T
  res<-NULL
  path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code"
  
  for(i in fecForms) {
    output <- mastif( inputs = inputs, formulaFec=i, formulaRep, ng = 50000, burnin = 25000)
    DICtrap<-output[["fit"]][["DICtrap"]]
    DICcrop<-output[["fit"]][["DICcrop"]]
    betaFec<-(output[["parameters"]][["betaFec"]])
    out<-data.frame(Model=as.character(i)[2],DICtrap=DICtrap)
    res<-rbind(res,out)
   newfolder <- paste0(genus,"_beta_prior","_",sub(" + ","_",i)[2])
    dir.create(path=paste0(path,"/",newfolder))
   setwd(paste0(path,"/",newfolder))
  getwd()
   name<-paste0(newfolder,"_betaFec.csv")
   write.csv(betaFec,file=name)
   mastPlot(output,plotPars)
  }











  
  
write.csv(betaFec,"pinus_CWDall_betaFec.csv")
  
pred<-data.frame(output[["prediction"]][["seedPred"]])

predPlot<-ggplot(pred,aes((countPerTrap),(predMeanTrap))) +
  geom_point() +
  geom_smooth(method="lm")
predPlot
ggsave("SEQP.png",predPlot,bg="white")

ggplot(pred) +
  geom_density(aes(log(countPerTrap)),fill="blue",alpha=0.5) +
  geom_density(aes(log(predMeanTrap)),fill="yellow",alpha=0.5)


  
fec<-data.frame(output[["prediction"]][["fecPred"]])

ggplot(fec,aes((fecEstMu),log(fecPredMu))) +
  geom_point() +
  geom_smooth(method="lm")

# time series of masting data?
f2<-fec%>%filter(plot=="MORAPP17" | plot=="YOSEYOHOPIPO")%>%
  group_by(species,plot,year)%>%
  mutate(meanFec=mean(fecEstMu),meanPred=mean(fecPredMu))

ggplot(f2,aes(year,(meanPred),color=plot,group=plot)) +
  geom_point() +
  geom_line() +
  theme_minimal() +
  facet_wrap(plot~species,scales="free")
  


write.csv(res,paste0(genus,"_DIC.csv"))


summary(output)




```


Let's do a PCA to see if we can explain the species-level responses to future climate
First do a PCA based on historical climate (just current P and T)
then take the full effects data and 



``` {r map fecundity change under future climate}
abies<-gcAC_abies%>%
  mutate(deltaF_WW=meanF_WW-meanF_current,deltaF_WD=meanF_WD-meanF_current,genus="Abies")%>%
  #dplyr::select(genus,Species,TREE_ID,X,Y,deltaF_WW,deltaF_WD)%>%
  distinct()
quercus<-gcAC_quercus%>%
  mutate(deltaF_WW=meanF_WW-meanF_current,deltaF_WD=meanF_WD-meanF_current,genus="Quercus")%>%
  #dplyr::select(genus,Species,TREE_ID,X,Y,deltaF_WW,deltaF_WD)%>%
  distinct()
pinus<-gcAC_pinus%>%
  mutate(deltaF_WW=meanF_WW-meanF_current,deltaF_WD=meanF_WD-meanF_current,genus="Pinus")%>%
  #dplyr::select(genus,Species,TREE_ID,X,Y,deltaF_WW,deltaF_WD)%>%
  distinct()
allFutures<-rbind(abies,quercus,pinus)%>%
  dplyr::select(genus,Species,TREE_ID,X,Y,deltaF_WW,deltaF_WD)
allFutures2<-rbind(abies,pinus,quercus)

# ok now we have to make maps of everything

library(tigris) # package for CA maps
library(raster)
ca<-states(keep_zipped_shapefile=TRUE)%>%
  filter(NAME=="California")%>%
  dplyr::select(NAME,INTPTLAT,INTPTLON)%>%
  rename(LAT=2,LON=3)
ca$LON<-as.numeric(ca$LON)
ca$LAT<-as.numeric(ca$LAT)




grid <- ca%>%
  sf::st_make_grid(cellsize = 0.05, what = "polygons",square=TRUE) %>%
  sf::st_intersection(ca) %>% 
  sf::st_sf(grid_id = 1:length(.))
sf::sf_use_s2(FALSE)
#grid<-distinct(grid)

library(gstat)

future_sf<-st_as_sf(allFutures,coords=c("X","Y"))%>%
  drop_na()

interp<-NULL
for(j in unique(future_sf$genus)) {
  
  dat<-filter(future_sf,genus==j)
  st_crs(dat)<-st_crs(grid)
  
  iWW <- idw(deltaF_WW~1, dat, grid,nmax=20,maxdist=20)
  iWW2<-cbind(iWW,genus=j,Climate="Warm Wet")
  
  iWD <- idw(deltaF_WD~1, dat, grid,nmax=20,maxdist=20)
  iWD2<-cbind(iWD,genus=j,Climate="Warm Dry")
  
  interp<-rbind(interp,iWW2,iWD2)
}

i2<-interp%>%
  group_by(genus,Climate)%>%
  mutate(Difference=scale(var1.pred))

plot<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=interp, aes(fill = var1.pred),color=NA) + 
   # geom_point(data=Full,aes(X,Y,color=(Response))) +
    scale_fill_gradient(low="blue",high="yellow",na.value="white") +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_minimal() +
    theme(legend.title=element_blank()) +
  facet_wrap(Climate~genus)
ggsave("difference_maps.png",plot,bg="white",dpi=300,width=12)


```

Re Cal-Adapt: 
These four models can be described as producing:

A warmer/drier simulation (HadGEM2-ES)
A cooler/wetter simulation (CNRM-CM5)
An average simulation (CanESM2)
A simulation that is most unlike the first three for the best coverage of different possibilities (MIROC5)

Source: Pierce, D. W., J. F. Kalansky, and D. R. Cayan, (Scripps Institution of Oceanography). 2018. Climate, Drought, and Sea Level Rise Scenarios for the Fourth California Climate Assessment. California’s Fourth Climate Change Assessment, California Energy Commission. Publication Number: CNRA-CEC-2018-006.


``` {r FIA prep}
dir<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA"
#CA_FIA <- getFIA(states = 'CA', dir = dir,load=TRUE) # use this code to get most updated FIA data
CA_FIA<-readFIA(dir) # read in data from directory



#CA_recent<-clipFIA(CA_FIA) # this gets most recent data
tpa_polysSF <- tpa(CA_FIA,treeType="live",treeDomain = SPCD==122,byPlot=TRUE,returnSpatial = TRUE) # filter out just PIPO and make it a spatial object, only gives trees per acre
plot(tpa_polysSF) # testplot of trees per acre

plot.list<-data.frame(Plot=CA_FIA$PLOT$PLOT,Unit=CA_FIA$PLOT$UNITCD,County=CA_FIA$PLOT$COUNTYCD,STATE=CA_FIA$PLOT$STATECD,UTMy=CA_FIA$PLOT$LAT,UTMx=CA_FIA$PLOT$LON)%>%
  unite(PLOT,Plot,Unit,County,STATE,sep="_")%>%
  rename(Plot=PLOT)%>%
  distinct()

tree.list <- data.frame(Year=CA_FIA$TREE$INVYR,Plot=CA_FIA$TREE$PLOT,Unit=CA_FIA$TREE$UNITCD,County=CA_FIA$TREE$COUNTYCD,STATE=CA_FIA$TREE$STATECD,Subplot=CA_FIA$TREE$SUBP,Tree=CA_FIA$TREE$TREE,Diameter=CA_FIA$TREE$DIA,SPCD=CA_FIA$TREE$SPCD,SHADE=CA_FIA$TREE$CLIGHTCD,canopy=CA_FIA$TREE$CCLCD)%>%
  unite(PLOT,Plot,Unit,County,STATE,sep="_")%>%
  rename(Plot=PLOT)%>%
  distinct()

PLOT_TREE<-merge(plot.list,tree.list)


# ok, let's predict some shade classes now
sp_names<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA/SPC_ID.csv")%>%
  dplyr::select(SPCD,SCI_NAME)

treeNames<-merge(PLOT_TREE,sp_names)%>% # merge tree spatial object and names list
  rename(species=SCI_NAME)%>%
  rename(diam=Diameter,shade=SHADE,plot=Plot,tree=Tree)



ppath<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/canopy_pred/"
test<-predCanopy(newdata=treeNames,fit=NULL,ppath=ppath)
FIA_data<-test%>%
  rename(LAT=UTMy,LON=UTMx)
  
library(sf) # need this to make SF objects
tree_sf<-st_as_sf(FIA_data,coords=c("LON","LAT")) # turn dataframe into a spatial object
#plot(tree_sf) # cool, the plot works 


tree_xy<-tree_sf%>%
  dplyr::mutate(X = sf::st_coordinates(.)[,1],
                Y = sf::st_coordinates(.)[,2])%>%
  dplyr::select(plot,Subplot,tree,species,shade,diam,X,Y)%>%
  rename(Plot=plot,Tree=tree,Species=species,Shade=shade,Diameter=diam)


tree_xy<-as.data.frame(tree_xy)%>%
  dplyr::select(-geometry)%>%
  mutate(X=round(X,2),Y=round(Y,2))

tbcm_xy<-merge(all_clim,tree_xy)%>%
  rename(Year=year)



```





``` {r Pinus predict fecundity with lags}
pine_predict<-pinus%>%
  rename(dp3=41)%>%
  mutate(logf=Precip_lag3*dp3*Diameter,Fec=exp(logf))%>%
  drop_na()%>%
  group_by(Species,Year,Plot)%>%
  mutate(meanF=mean(Fec),meanLF=mean(logf))

ggplot(pine_predict,aes(Year,meanLF,group=Plot,color=Plot)) +
  geom_line(show.legend=FALSE) +
  #scale_color_colorblind() +
  theme_minimal() +facet_wrap(~Species,ncol=1,scales="free") +
  labs(y="Log Fecundity (seeds per tree)")

# can I get a weighted latent variable working?
pine_weights<-pine_predict%>%
  arrange(Tree,Plot,Subplot,Year)%>%
  group_by(Tree,Plot,Subplot)%>%
  mutate(w1=.9,w2=.5,w3=.1,wF1=w1*lag(logf),wF2=w2*lag(lag(logf)),wF3=w3*lag(lag(lag(logf))))%>%
  drop_na()

B1df<-pine_weights%>%
  group_by(Tree,Plot,Subplot)%>%
  do(B1=(lm(logf~wF1,data=.)$coefficients[[2]]))
B2df<-pine_weights%>%
  group_by(Tree,Plot,Subplot)%>%
  do(B2=(lm(logf~wF2,data=.)$coefficients[[2]]))
B3df<-pine_weights%>%
  group_by(Tree,Plot,Subplot)%>%
  do(B3=(lm(logf~wF3,data=.)$coefficients[[2]]))
  
pineout<-merge(pine_weights,B1df)%>%
  merge(.,B2df)%>%
  merge(.,B3df)%>%
  dplyr::select(Plot,Subplot,Tree,Species,X,Y,Year,B1,B2,B3,wF1,wF2,wF3,logf)
pineout$B1<-as.numeric(pineout$B1)
pineout$B2<-as.numeric(pineout$B2)
pineout$B3<-as.numeric(pineout$B3)


pineFix<-pineout%>%
  ungroup()%>%
  mutate(logf2=logf+(B1*wF1+B2*wF2+B3*wF3))%>%
  group_by(Species,Year,Plot)%>%
  mutate(meanlogf=mean(logf2))%>%
  drop_na()%>%
  mutate(zscore = (logf2 - mean(logf2))/sd(logf2))%>%
  mutate(meanZ=mean(zscore))

ggplot(pineFix,aes(Year,meanlogf,group=Plot,color=Plot)) +
  geom_line(show.legend=FALSE) +
  #scale_color_colorblind() +
  theme_minimal() +facet_wrap(~Species,ncol=1,scales="free") +
  labs(y="Log Fecundity (seeds per tree)")


plot(density(scale(log(abs(pineFix$logf2[pineFix$Species=="Pinus ponderosa"])))))


ggplot(pineFix,aes(Year,meanZ,group=Plot,color=Plot)) +
  geom_line(show.legend=FALSE) +
  #scale_color_colorblind() +
  theme_minimal() +facet_wrap(~Species,ncol=1,scales="free") +
  labs(y="Z-score")
  

```






``` {r FIA stuff}
dir<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA"
#CA_FIA <- getFIA(states = 'CA', dir = dir,load=TRUE) # use this code to get most updated FIA data
CA_FIA<-readFIA(dir) # read in data from directory
#CA_recent<-clipFIA(CA_FIA) # this gets most recent data
tpa_polysSF <- tpa(CA_FIA,treeType="live",treeDomain = SPCD==122,byPlot=TRUE,returnSpatial = TRUE) # filter out just PIPO and make it a spatial object, only gives trees per acre
plot(tpa_polysSF) # testplot of trees per acre

plot.list<-data.frame(Plot=CA_FIA$PLOT$PLOT,LAT=CA_FIA$PLOT$LAT,LON=CA_FIA$PLOT$LON)
tree.list <- data.frame(Year=CA_FIA$TREE$INVYR,Plot=CA_FIA$TREE$PLOT,Subplot=CA_FIA$TREE$SUBP,Tree=CA_FIA$TREE$TREE,Diameter=CA_FIA$TREE$DIA,SPCD=CA_FIA$TREE$SPCD,SHADE=CA_FIA$TREE$CLIGHTCD)
PLOT_TREE<-merge(plot.list,tree.list)
  

# now let's turn out tree list into a spatial object
# the goal here is to make a map of every tree
geo<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA/CA_PLOTGEOM.csv") %>%# first get the geometry for the plots
  dplyr::select(PLOT,LAT,LON) %>% #isolate just pltID and lat / long
  rename(Plot=PLOT)%>%
  distinct()


tree_geo<-merge(PLOT_TREE,geo) # combine tree data and geometry
library(sf) # need this to make SF objects
tree_sf<-st_as_sf(tree_geo,coords=c("LON","LAT")) # turn dataframe into a spatial object
#plot(tree_sf) # cool, the plot works 

# load in species names
sp_names<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA/SPC_ID.csv")%>%
  dplyr::select(SPCD,SCI_NAME)
tree_geo_names<-merge(tree_sf,sp_names)%>% # merge tree spatial object and names list
  rename(Species=SCI_NAME)%>% # rename the scientific name column to something easier to read
  dplyr::select(-SPCD) %>%
  filter(Species=="Quercus kelloggii" | Species=="Quercus chrysolepis")




# MIGHT NEED TO UPDATE THIS TO MAKE MAPS, IF NEEDED
# now we can do a for loop that plots each species' diameter 
library(tigris) # package for CA maps
ca<-states()%>%
  filter(NAME=="California")%>%
  dplyr::select(NAME,INTPTLAT,INTPTLON)%>%
  rename(LAT=2,LON=3)
ca$LON<-as.numeric(ca$LON)
ca$LAT<-as.numeric(ca$LAT)

for(i in unique(tree_geo_names$Species)) {
  dat<-filter(tree_geo_names,Species==i)
  map<-ggplot() +
    geom_sf(data=ca) +
    geom_point(data=dat,aes(LON,LAT)) +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    ggtitle(unique(dat$Species))
  setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/FIA/Maps")
  ggsave(paste(i,"_","FIAplot.png"),map,bg="white")
}

m2<-st_as_sf(mora,coords=c("x","y"))
st_crs(m2)<-st_crs(ca)
m3<-as.data.frame(m2)

map<-ggplot() +
    geom_sf(data=ca) +
    geom_sf(data=m2) +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude")


```

``` {r predict with FIA}

# first let's collect the FIA data 
pinus<-tree_geo_names%>%
  dplyr::distinct()%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))
tree_vec<-vect(pinus) # convert tree file to spatial vector
#plot(tree_vec)# check the vectorized tree data

# I need to read in all of the climate data

mon<-5:8
years<-unique(pinus$Year)
vars<-"tmean"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(pinus,Year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,tmean_Lag2=9)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

temperature<-temp%>%
  group_by(Plot,Tree,Year,Subplot,Species)%>%
  mutate(tmean_Lag2=mean(tmean_Lag2))%>%
  ungroup()%>%
  dplyr::select(Plot,Tree,Year,Subplot,Species,tmean_Lag2)%>%
  distinct()%>%
  group_by(Tree,Species,Plot,Subplot,Year)%>%
  mutate(tmean_Lag2=mean(tmean_Lag2))%>%
  distinct()





# first I want to get precip data for t-3 year's winter (i.e., water year)
mon<-10:12
years<-unique(pinus$Year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset("tmax", "monthly", years =(i-3),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(pinus,Year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,precip_Lag2=9)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t1<-temp%>%
  group_by(Plot,Tree,Year,Subplot,Species)%>%
  mutate(totPrecip_lag2=sum(precip_Lag2))%>%
  ungroup()%>%
  dplyr::select(Plot,Tree,Year,Subplot,Species,totPrecip_lag2)%>%
  distinct()


# now let's get precip data for spring t-2 years
mon<-1:4
years<-unique(pinus$Year)
vars<-"ppt"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset("tmax", "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(pinus,Year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,precip_Lag2=9)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t1.2<-temp%>%
  group_by(Plot,Tree,Year,Subplot,Species)%>%
  mutate(totPrecip_lag2=sum(precip_Lag2))%>%
  ungroup()%>%
  dplyr::select(Plot,Tree,Year,Subplot,Species,totPrecip_lag2)%>%
  distinct()


precip<-rbind(t1,t1.2)%>%
  group_by(Plot,Tree,Species,Year,Subplot)%>%
  mutate(totPrecip_lag2=sum(totPrecip_lag2))%>%
  ungroup()%>%
  dplyr::select(Plot,Tree,Year,Subplot,Species,totPrecip_lag2)%>%
  distinct()



# now get VPD
mon<-5:8
years<-unique(pinus$Year)
vars<-"vpdmax"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(pinus,Year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,vpdmax=9)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t1.2<-temp%>%
  group_by(Plot,Tree,Year,Subplot,Species)%>%
  mutate(vpdmax=mean(vpdmax))%>%
  ungroup()%>%
  dplyr::select(Plot,Tree,Year,Subplot,Species,vpdmax)%>%
  distinct()


mon<-5:8
years<-unique(pinus$Year)
vars<-"vpdmin"
temp<-data.frame(NULL)
library(prism)
path<-"/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/climate"
prism_set_dl_dir(path)

for(i in years) {# for each row in the seeds dataframe
  v<-list() # should I create a new list here or keep everything together?
  for(k in vars)
  #get_prism_monthlys(type = k, years=(i-2), mon = mon, keepZip = TRUE)# get monthly temperature data for that year and up to 3 years in the past
  data<-prism_archive_subset(k, "monthly", years =(i-2),mon = mon) # get list of all the data names (should be 36 files)
  for(j in data) { # now here we will read in each climate raster file and add to a list
      name<-paste0(path,"/",j,"/",j,".bil")
      d<-raster(name)
      v[[j]]<-d
  } 
  #cropped<-lapply(v,crop,grid) # crop the extent of the climate data to just California
  SR<-lapply(v,rast) # convert the climate files to spatial raster
  tf<-filter(pinus,Year==i) # subset the tree_transform data to the same row considered in the loop so that everything matches
  tree_vec<-vect(tf) # convert tree file to spatial vector
  EXT<-lapply(SR,extract,tree_vec,xy=TRUE,bind=TRUE) # here we will extract the climate data where it intersects the seed trap locations
  years=(i-2)
  months<-mon
  my<-expand.grid(months,years)
  my<-paste0(my$Var1,"_",my$Var2)
  names(EXT)<-my
  EXT_df<-lapply(EXT,as.data.frame)%>%
    lapply(.,dplyr::rename,vpdmin=9)%>%
    Map(cbind, ., Date = names(.))%>%
    do.call(rbind,.)
  temp<-rbind(temp,EXT_df)
}

t2.2<-temp%>%
  group_by(Plot,Tree,Year,Subplot,Species)%>%
  mutate(vpdmin=mean(vpdmin))%>%
  ungroup()%>%
  dplyr::select(Plot,Tree,Year,Subplot,Species,vpdmin)%>%
  distinct()


vpd<-merge(t1.2,t2.2)%>%
  group_by(Plot,Tree,Species,Year,Subplot)%>%
  mutate(vpd=(vpdmax+vpdmin)/2)%>%
  ungroup()%>%
  dplyr::select(Plot,Tree,Year,Subplot,Species,vpd)%>%
  distinct()



# soil phosphorous
pdf<-rast("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/ptif.tif")
treesf<-st_as_sf(pinus,coords=c("x","y"),
                  crs = "+proj=utm +zone=11")
treevec<-vect(treesf)
crs(treevec)<-crs(pdf)

EXT<-extract(pdf,treevec,xy=TRUE,bind=TRUE) 

soilP<-as.data.frame(EXT)%>%
  rename(P=Band_1)%>%
  dplyr::select(-x,-y)

#### HAVING TROUBLE WITH SOIL P SO GOING TO SKIP FOR NOW???





climate<-merge(temperature,precip)%>%
  merge(.,vpd)







library(stringr)

# okay I think the approach I need to take is as follows:
  # first take the coefficients for each term in my full model: diameter and temperature
coefs<-read.csv('/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/code/Quercus/QUERCUS_BEST/QUERCUS_BEST.csv')%>%
  mutate(X=gsub("species","",X))%>%
  separate(X,c('Species','var1','var2'),sep=":")%>%
  mutate(var1=ifelse(is.na(var1)==TRUE,"Intercept",var1),var2=ifelse(is.na(var2)==TRUE," ",var2))%>%
    filter(var1!="shade",var2!="shade")%>%
  mutate(Species=tolower(Species),Species=gsub("quercus","Quercus ",Species),Species=ifelse(Species=="Quercus chrysole","Quercus chrysolepis",ifelse(Species=="Quercus kelloggi", "Quercus kelloggii",Species)))%>%
  mutate(beta_obs=ifelse(sig95=="*",estimate,0),interaction=paste(var1,var2,sep=":"))%>%
  dplyr::select(Species,interaction,beta_obs)%>%
  pivot_wider(names_from=interaction,values_from=beta_obs)


# next for each term, calculate the change in each variable with time in the FIA data 

# GROWTH effect with time
library(broom)
#Spec<-"Abies concolor" # if I need to specify for a focal species do that here or comment code out
dG<-pinus%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree,-SHADE)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  dplyr::mutate(deltaG=Diameter-lag(Diameter))%>% # calculate growth as difference in diameter from current and previous time point
  mutate(deltaG=ifelse(deltaG<0,0,deltaG)) %>% # use a tobit model to censor data at zero (i.e., can't have negative growth)
  #drop_na()%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(Diameter~Year,data=.)$coefficients))%>%
  mutate(statistic=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,statistic)%>%
  drop_na()%>%
  rename(.,dGdt=statistic)


dT<-climate%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(tmean_Lag2~Year,data=.)$coefficients))%>%
  mutate(statistic=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,statistic)%>%
  drop_na()%>%
  rename(.,dTdt=statistic)

dPrecip<-climate%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(totPrecip_lag2~Year,data=.)$coefficients))%>%
  mutate(statistic=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,statistic)%>%
  drop_na()%>%
  rename(.,dPrecipdt=statistic)

dVPD<-climate%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  distinct()%>%
  #filter(Species==Spec)%>%
  dplyr::select(-Plot,-Subplot,-Tree)%>%
  drop_na()%>%
  arrange(TREE_ID,Year)%>% # first let's arrange by tree and date so that I can calculate growth as difference in diameter
  dplyr::group_by(TREE_ID)%>%
  group_by(TREE_ID)%>%
  do(mo=(lm(vpd~Year,data=.)$coefficients))%>%
  mutate(statistic=mo[[2]])%>%
  dplyr::select(-mo)%>%
  dplyr::select(TREE_ID,statistic)%>%
  drop_na()%>%
  rename(.,dVPDdt=statistic)
  


cnew<-climate%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  dplyr::select(-Plot,-Subplot,-Tree)

p2<-pinus%>%
  mutate(TREE_ID=paste(Plot,Subplot,Tree,sep="_"))%>%
  dplyr::select(TREE_ID,Diameter,Year)


growth_climate<-merge(dG,cnew)%>%
  merge(.,dT)%>%
  #merge(.,dPrecip)%>%
 # merge(.,dVPD)%>%
  distinct()%>%
  merge(.,coefs)%>%
  merge(.,p2)



# okay the Clark et al., 2021 Nat. Comms paper appears to do the following to calculate each effect
# response: df/dC which is just the MASTIF output for change in fecundity with change in precip
Response<-growth_climate%>%
  dplyr::select(TREE_ID,10:12)%>%
  distinct()%>%
  rename(G=2,G2=3,Temp=4)%>%
  pivot_longer(col=2:4,names_to="Variable",values_to="Response")
# direct: df/dC * dC/dt which is just precipitation over time
Direct<-growth_climate%>%
  dplyr::select(1,4,8,14)%>%
  rename(G=2,Temp=3)%>%
  distinct()%>%
  pivot_longer(cols=2:3,names_to="Variable",values_to="dt")%>%
  merge(.,Response)%>%
  mutate(Direct_Effect=Response*dt)
# full: Direct + B + C*(D + E)
    # Direct = df/dC * dC/dt 
  # INDIRECT: 
    #B = (df/dG*dG/dt) 
    #C = df/dGC
    # D = G_effect*dC/dt
    # E = C_effect*dG/dt)



Indirect<-growth_climate%>%
  rename(G=10,G2=11,Temp=12)%>%
  distinct()%>%
  #mutate(Precip=(G*dGdt)+(GPrecip*((G*dPrecipdt)+(Precip*dGdt))),
        # Temp=(G*dGdt)+(GTemp*((G*dTdt)+(Temp*dGdt))),
        # VPD=(G*dGdt)+(GVPD*((G*dVPDdt)+(VPD*dGdt))),
        # Indirect_all=Precip+Temp+VPD
        # )%>%
  dplyr::select(TREE_ID,Precip,Temp,VPD,Indirect_all,geometry)%>%
  distinct()%>%
  pivot_longer(cols=2:4,names_to="Variable",values_to="Indirect")



Full<-Direct%>%
  #merge(Direct,Indirect)%>%
  #mutate(Full_Effect=Direct_Effect+Indirect,Full_Effect_all=Direct_Effect+Indirect_all)%>%
  drop_na()%>%
  mutate(x=st_coordinates(geometry)[,1],y=st_coordinates(geometry)[,2])
  



library(tigris) # package for CA maps
ca<-states()%>%
  filter(NAME=="California")%>%
  dplyr::select(NAME,INTPTLAT,INTPTLON)%>%
  rename(LAT=2,LON=3)
ca$LON<-as.numeric(ca$LON)
ca$LAT<-as.numeric(ca$LAT)

library(viridisLite)
# map of response first
response_plot<-ggplot() +
    geom_sf(data=ca) +
    geom_point(data=Full,aes(x,y,color=(Response))) +
    scale_color_viridis_c() +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_minimal() +
    ggtitle("Fecundity change with change in climate (df/dC)") +
  facet_wrap(~Variable) +
  theme(legend.title=element_blank())
ggsave("response_all_quercus.png",response_plot,bg="white",dpi=300)


# map of growth only response 
growth_plot<-ggplot() +
    geom_sf(data=ca) +
    geom_point(data=Full,aes(x,y,color=(Direct_Effect))) +
    scale_color_viridis_c() +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_minimal() +
    ggtitle("Fecundity change with change in growth (df/dG dG/dt)")+
  theme(legend.title=element_blank())
ggsave("growth_only_quercus.png",growth_plot,bg="white",dpi=300)

# map of direct effects
direct_plot<-ggplot() +
    geom_sf(data=ca) +
    geom_point(data=Full,aes(x,y,color=(Direct_Effect))) +
    scale_color_viridis_c() +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_minimal() +
    ggtitle("Direct Effect (df/dC * dC/dt")+
  facet_wrap(~Variable)+
  theme(legend.title=element_blank())
ggsave("direct_all_quercus.png",direct_plot,bg="white",dpi=300)


# map of indirect effects
indirect_plot<-ggplot() +
    geom_sf(data=ca) +
    geom_point(data=Full,aes(x,y,color=log10(Indirect))) +
    scale_color_viridis_c() +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_minimal() +
    ggtitle("Indirect effects via growth - climate interactions")+
  facet_wrap(~Variable)+
  theme(legend.title=element_blank())
ggsave("indirect_effect_all_abies.png",indirect_plot,bg="white",dpi=300)


# map of indirect effects all together
indirect_plot<-ggplot() +
    geom_sf(data=ca) +
    geom_point(data=Full,aes(x,y,color=log10(Indirect_all))) +
    scale_color_viridis_c() +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_minimal() +
    ggtitle("Sum of all indirect effects")+
  theme(legend.title=element_blank())
ggsave("indirect_effect_all_sum_abies.png",indirect_plot,bg="white",dpi=300)


# map of Full effects
full_plot<-ggplot() +
    geom_sf(data=ca) +
    geom_point(data=Full,aes(x,y,color=log10(Full_Effect))) +
    scale_color_viridis_c() +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_minimal() +
    ggtitle("Direct + Indirect Effects")+
  facet_wrap(~Variable)+
  theme(legend.title=element_blank())
ggsave("full_effect_all_abies.png",full_plot,bg="white",dpi=300)



# map of sum of Full effects
full_plot<-ggplot() +
    geom_sf(data=ca) +
    geom_point(data=Full,aes(x,y,color=log10(Full_Effect_all))) +
    scale_color_viridis_c() +
    #geom_polygon(data=ca,aes(LON,LAT),color="black") +
    labs(x="Longitude",y="Latitude") +
    theme_minimal() +
    ggtitle("Direct + sum of all Indirect Effects")+
  theme(legend.title=element_blank())
ggsave("full_effect_all_sum_abies.png",full_plot,bg="white",dpi=300)






all_figs<-ggarrange(response_plot,indirect_plot,direct_plot,full_plot)
ggsave("pinus_deltaTmin.png",all_figs,bg="white",dpi=300,height = 12,width=12)

full_density<-ggplot(Full) +
  geom_density(aes(x=Full_Effect)) +
  theme_minimal()



```

``` {r spectral density stuff}
library(Spectrum)
seed_time<-seedData%>%
  dplyr::select(-plot,-trap,-active,-area)%>%
  pivot_longer(cols=3:16,names_to="Species",values_to="Count")%>%
  drop_na()

# let's make a quick figure of count (x) by time (t)
st<-ggplot(seed_time,aes(year,Count,color=trapID,group=trapID)) +
  geom_line(show.legend=FALSE) +
  theme_minimal() +
  facet_wrap(~Species,scales="free")
st

# now let's use the spectrum command in stats to calculate the spectral density 

for(i in unique(seed_time$Species)) {
  dat<-filter(seed_time,Species==i)
  spectrum(dat)
  title(i)
}

# set the sampling interval so we can extract raw frequencies
si<-0.055

# now re-run with unscaled frequency
res<-data.frame(NULL)
for(i in unique(seed_time$Species)) {
  dat<-filter(seed_time,Species==i)
  #out<-spectrum(dat)
  x.spec <- spectrum(dat$Count)
  title(i)
  spx <- x.spec$freq/si
  spy <- 2*x.spec$spec
  Spec<-data.frame(freq=x.spec$freq,spec=x.spec$spec,Species=i)
  #plot(spy[,1]~log(spx),xlab="frequency",ylab="smoothed spectral density",type="l")
  #plot (spy[,1]~log(spx), subset=spx<=2,xlab="frequency",ylab="spectral density",type = "l") #Zoom-in on low freq
  #dom.freq<-data.frame(Species=i,df=spx[which.max(spy)]) #Extract the dominant frequency
  res<-rbind(res,Spec)
}


# now I think we can calculate some of the parameters from Qiu et al.

est<-res%>%
  mutate(period=(1/freq),v=period*spec,n=1)%>% # calculate some of the terms in the equations
  group_by(Species)%>%
  mutate(t=sum(n),num=1:t) # counting number of entries for each species, so I can specify t-1 in volatility calculation

res<-data.frame(NULL)
res2<-data.frame(NULL)
for(i in unique(est$Species)) {
  dat<-filter(est,Species==i,num!=max(num)) # subset df for each species, and remove the last element or volatility calculation
  #v<-dat$v 
  Mv<-log((1/(pi*dat$t))*(sum(dat$v))) # this is the equation for volatility
  out<-data.frame(Species=i,Mv=Mv)
  res<-rbind(res,out)
  
  dat2<-filter(est,Species==i)
  spec<-dat2$spec
  v<-dat2$v
  var_f<-(1/pi)*sum(spec) # this is the equation for spectral variance
  Mp<-log((1/(pi*var_f))*(sum(v))) # this is the equation for periodicity
  out2<-data.frame(Species=i,Mp=Mp)
  res2<-rbind(res2,out2)
}

MpMv<-merge(res,res2)


# relationship between volatility and periodicity? 
ggplot() +
  geom_point(data=MpMv,aes(Mv,Mp,color=Species)) + 
  geom_smooth(data=MpMv,aes(Mv,Mp),method="lm") +
  #scale_color_viridis(option="H") +
  theme_minimal() +
  labs(x="Volatility",y="Periodicity")
# sometimes slight positive relationship but not always!


# let's load in the cone estimated data
cones<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/Costs of Reproduction/Cone Size analysis/cone_size_rough.csv")%>%
  mutate(Species=ifelse(Species=="Abies concolor","abiesConcolor",ifelse(Species=="Abies magnifica","abiesMagnific",ifelse(Species=="Pinus contorta","pinusContorta",ifelse(Species=="Pinus jeffreyi","pinusJeffreyi",ifelse(Species=="Pinus lambertiana","pinusLamberti",ifelse(Species=="Pinus ponderosa","pinusPonderos",NA)))))))%>%
  #drop_na()%>%
  merge(.,MpMv)%>%
  mutate(pred_mass=as.numeric(pred_mass))

c1<-drop_na(cones)

# let's plot it
predicted_mass<-ggplot() +
  geom_point(data=c1,aes(pred_mass,Mv,color=Species),size=8) +
  geom_smooth(data=c1,aes(pred_mass,Mv),method="lm",se=FALSE)+
  geom_point(data=c1,aes(pred_mass,Mp,color=Species),size=8,shape=4) +
  geom_smooth(data=c1,aes(pred_mass,Mp),method="lm",se=FALSE) +
  labs(x="Predicted Mass", y = "Mv (circles), Mp (x's)") +
  theme_minimal()
predicted_mass


# let's try the same plot but with specific gravity at maturity?!
SG<-ggplot() +
  geom_point(data=c1,aes(SG,Mv,color=Species),size=8) +
  geom_smooth(data=c1,aes(SG,Mv),method="lm",se=FALSE)+
  geom_point(data=c1,aes(SG,Mp,color=Species),size=8,shape=4) +
  geom_smooth(data=c1,aes(SG,Mp),method="lm",se=FALSE) +
  labs(x="Cone Specific Gravity (Relative Density)", y = "Mv (circles), Mp (x's)") +
  theme_minimal()
SG



#ggsave("mass_period_volatility.png",predicted_mass,bg="white",dpi=300)
#ggsave("SG_period_volatility.png",SG,bg="white",dpi=300)


# what constrains cone size? is it tree height?
trees<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/Costs of Reproduction/Cone Size analysis/tree_size.csv")%>%
  mutate(Species=gsub("_"," ",Species))%>%
  dplyr::select(-Cycle)%>%
  drop_na()
cones<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/Costs of Reproduction/Cone Size analysis/cone_size_rough.csv")
cones$pred_mass<-as.numeric(cones$pred_mass)

tc<-merge(trees,cones)

height_sg<-ggplot(tc,aes(Height,SG)) +
  geom_text(aes(label=Species),check_overlap=TRUE) +
  geom_point(aes(color=Species)) +
  geom_smooth(method="lm") +
  theme_minimal()

dbh_sg<-ggplot(tc,aes(Diameter,SG)) +
  geom_text(aes(label=Species),check_overlap=TRUE) +
  geom_point(aes(color=Species)) +
  geom_smooth(method="lm") +
  theme_minimal()

tc2<-merge(trees,cones)%>%
  drop_na()

ht_mass<-ggplot(tc2,aes(Height,pred_mass)) +
  geom_text(aes(label=Species),check_overlap=TRUE) +
  geom_point(aes(color=Species)) +
  geom_smooth(method="lm") +
  theme_minimal()

dbh_mass<-ggplot(tc2,aes(Diameter,pred_mass)) +
  geom_text(aes(label=Species),check_overlap=TRUE) +
  geom_point(aes(color=Species)) +
  geom_smooth(method="lm") +
  theme_minimal()

height_sg
dbh_sg
ht_mass
dbh_mass

# make sure the species names match so I can merge with other data as well
specs<-c("Abies concolor","Abies magnifica", "Abies spp","Calocedrus decurrens","Pinus contorta","Pinus jeffreyi","Pinus lambertiana","Pinus monticola","Pinus ponderosa","Pinus spp","Pseudotsuga menziesii","Quercus kelloggii","Quercus spp","Sequoiadendron giganteum")

MpMv$Species<-specs

# let's pull in the Farjon data
farjon<-read.csv("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/Costs of Reproduction/Cone Size analysis/farjon_cone.csv")%>%
  mutate(Species=gsub("_"," ",taxon),cone_vol=(pi*(2*cone_width.min)^2*cone_length.min)*.001)%>% # let's assume cones are cylinders for ease
  dplyr::select(-taxon)%>%
  merge(.,trees)


# does tree height scale with cone volume?
height_vol<-ggplot(farjon,aes(Height,log(cone_vol))) +
  geom_text(aes(label=Species),check_overlap=TRUE) +
  geom_smooth(method="lm") +
  theme_minimal() +
  labs(x = "Species Max Height", y = "Cone Volume")


# but with diameter too?
dia_vol<-ggplot(farjon,aes(log(Diameter),log(cone_vol))) +
  geom_point(check_overlap=TRUE) +
  geom_smooth(method="lm") +
  theme_minimal() +
  labs(x = "Species Max Diameter", y = "Cone Volume")

height_vol
dia_vol # bigger trees have bigger cones; unsurprising

# let's run a linear model and extract the residuals
dv<-lm(cone_vol~Diameter,data=farjon)
r<-resid(dv) # extract residuals
farjon$residuals<-r # append residuals to the data frame as a column

res_pv<-merge(farjon,MpMv) # merge with periodicity data

res_plot<-ggplot() +
  geom_point(data=res_pv,aes(cone_vol,log(Mv),color=Species),size=8) +
  geom_smooth(data=res_pv,aes(cone_vol,log(Mv)),method="lm",se=FALSE)+
  geom_point(data=res_pv,aes(cone_vol,log(Mp),color=Species),size=8,shape=4) +
  geom_smooth(data=res_pv,aes(cone_vol,log(Mp)),method="lm",se=FALSE) +
  labs(x="Cone Volume (residual with tree diameter)", y = "Mv (circles), Mp (x's)") +
  theme_minimal()

res_lm<-lm(cone_vol~log(Mp),data=res_pv)
summary(res_lm) # no significant relationship...

# OK; larger cones are less periodic in masting habit and slightly (though not significantly) more volatile




fj_sg<-merge(farjon,cones)%>%
  drop_na()%>%
  mutate(pred_mass=as.numeric(pred_mass))%>%
  mutate(Density=pred_mass/cone_vol)

# does cone density scale with tree size?
height_dens<-ggplot(fj_sg,aes(Height,Density)) +
  geom_text(aes(label=Species),check_overlap=TRUE) +
  geom_smooth(method="lm") +
  theme_minimal() +
  labs(x = "Species Max Height", y = "Cone Density")


# but with diameter too?
dia_dens<-ggplot(fj_sg,aes(Diameter,Density)) +
  geom_text(aes(label=Species),check_overlap=TRUE) +
  geom_smooth(method="lm") +
  theme_minimal() +
  labs(x = "Species Max Diameter", y = "Cone Density")

height_dens
dia_dens



# okay let's look at cone volume (as a proxy for carbon investment?) and periodicity
firstup <- function(x) {
  substr(x, 1, 1) <- toupper(substr(x, 1, 1))
  x
} # just to capitalize the first letter of species 

  
fj_period<-merge(farjon,MpMv)


vol_period<-ggplot() +
  geom_point(data=fj_period,aes(cone_vol,Mv,color=Species),size=8) +
  geom_smooth(data=fj_period,aes(cone_vol,Mv),method="lm",se=FALSE)+
  geom_point(data=fj_period,aes(cone_vol,Mp,color=Species),size=8,shape=4) +
  geom_smooth(data=fj_period,aes(cone_vol,Mp),method="lm",se=FALSE) +
  labs(x="Cone Volume", y = "Mv (circles), Mp (x's)") +
  theme_minimal()
vol_period

th_period<-ggplot() +
  geom_point(data=fj_period,aes(Height,Mv,color=Species),size=8) +
  geom_smooth(data=fj_period,aes(Height,Mv),method="lm",se=FALSE)+
  geom_point(data=fj_period,aes(Height,Mp,color=Species),size=8,shape=4) +
  geom_smooth(data=fj_period,aes(Height,Mp),method="lm",se=FALSE) +
  labs(x="Tree Height", y = "Mv (circles), Mp (x's)") +
  theme_minimal()

dia_period<-ggplot() +
  geom_point(data=fj_period,aes(Diameter,Mv,color=Species),size=8) +
  geom_smooth(data=fj_period,aes(Diameter,Mv),method="lm",se=FALSE)+
  geom_point(data=fj_period,aes(Diameter,Mp,color=Species),size=8,shape=4) +
  geom_smooth(data=fj_period,aes(Diameter,Mp),method="lm",se=FALSE) +
  labs(x="Tree Diameter", y = "Mv (circles), Mp (x's)") +
  theme_minimal()

th_period
dia_period


# seed traits and periodicity
sl_period<-ggplot() +
  geom_point(data=fj_period,aes(seed_length.avg,Mv,color=Species),size=8) +
  geom_smooth(data=fj_period,aes(seed_length.avg,Mv),method="lm",se=FALSE)+
  geom_point(data=fj_period,aes(seed_length.avg,Mp,color=Species),size=8,shape=4) +
  geom_smooth(data=fj_period,aes(seed_length.avg,Mp),method="lm",se=FALSE) +
  labs(x="Seed Length", y = "Mv (circles), Mp (x's)") +
  theme_minimal()

sw_period<-ggplot() +
  geom_point(data=fj_period,aes(seed_width.avg,Mv,color=Species),size=8) +
  geom_smooth(data=fj_period,aes(seed_width.avg,Mv),method="lm",se=FALSE)+
  geom_point(data=fj_period,aes(seed_width.avg,Mp,color=Species),size=8,shape=4) +
  geom_smooth(data=fj_period,aes(seed_width.avg,Mp),method="lm",se=FALSE) +
  labs(x="Seed Width", y = "Mv (circles), Mp (x's)") +
  theme_minimal()

# bigger seeds are maybe more periodic?
fj_period<-fj_period%>%
  mutate(seed_vol=pi*(2*seed_width.avg)^2*(seed_length.avg))

sv_period<-ggplot() +
  geom_point(data=fj_period,aes(seed_vol,Mv,color=Species),size=8) +
  geom_smooth(data=fj_period,aes(seed_vol,Mv),method="lm",se=FALSE)+
  geom_point(data=fj_period,aes(seed_vol,Mp,color=Species),size=8,shape=4) +
  geom_smooth(data=fj_period,aes(seed_vol,Mp),method="lm",se=FALSE) +
  labs(x="Seed Volume", y = "Mv (circles), Mp (x's)") +
  theme_minimal()
sv_period


# tree height / diameter and seed size
sv_ht<-ggplot() +
  geom_point(data=fj_period,aes(Height,seed_vol,color=Species),size=8) +
  geom_smooth(data=fj_period,aes(Height,seed_vol),method="lm",se=FALSE)+
  labs(x="Tree Height", y = "Seed Volume") +
  theme_minimal()

sv_dia<-ggplot() +
  geom_point(data=fj_period,aes(Diameter,seed_vol,color=Species),size=8) +
  geom_smooth(data=fj_period,aes(Diameter,seed_vol),method="lm",se=FALSE)+
  labs(x="Tree Diameter", y = "Seed Volume") +
  theme_minimal()

sv_ht
sv_dia

# seed / cone relationship?
sc<-ggplot() +
  geom_point(data=fj_period,aes(cone_vol,seed_vol,color=Species),size=8) +
  geom_smooth(data=fj_period,aes(cone_vol,seed_vol),method="lm",se=FALSE)+
  labs(x="Cone Volume", y = "Seed Volume") +
  theme_minimal()
sc # bigger cones = bigger seeds => if larger trees have bigger seeds, they tend to have bigger cones and thus larger branches







# let's look at some seed traits
fj<-farjon%>%
  #dplyr::select(Species,seed_length.avg,seed_width.avg,seed.mass)%>%
  drop_na()%>%
  distinct()%>%
  mutate(seed_vol=(pi*(0.5*seed_width.avg)^2*seed_length.avg),seed_density=seed.mass/seed_vol)

ggplot(fj,aes(seed_vol,seed.mass)) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_minimal()

mv_mod<-lm(seed.mass~seed_vol,data=fj)
summary(mv_mod)


# how many seeds are these species producing?
specs<-unique(fj$Species)

# load mastif data
setwd("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data")
# load in tree data
load("/Users/alexthompson/Dropbox/Postdoc/Moran Lab Postdoc/Data/Moran & Das SEKI Input/sierraNEV.rdata")
# first let convert tree data from UTM to lat / long

# run a very simple MASTIF model
formulaFec <- as.formula( ~ diam + I( diam^2 ) )   
betaPrior  <- list( pos = 'diam', neg = 'I( diam^2 )' )
formulaRep <- as.formula( ~ diam)   # maturation model

yearEffect   <- list( groups = 'species', p = 4)   # AR( 4 ) 
randomEffect <- list( randGroups = 'tree', 
                     formulaRan = as.formula( ~ 1 ) )

specNames<-unique(treeData$species)
seeds<-unique(treeData$species)


inputs <- list( treeData = treeData, seedData = seedData, xytree = xytree, 
                xytrap = xytrap, specNames = specNames, seedNames = seeds, 
                betaPrior = betaPrior)
output <- mastif( inputs = inputs, formulaFec, formulaRep, 
                 ng = 500, burnin = 200 )


mastPlot(output)

fecundity<-output[["parameters"]][["betaFec"]]%>%
  mutate(species=rownames(.),species=gsub("species","",species))

seed_pred<-output[["prediction"]][["seedPred"]]%>%
  pivot_longer(cols=12:23,names_to="Species",values_to="Count")%>%
  dplyr::select(Species,Count)%>%
  mutate(Species=gsub("^(.*?)_.*", "\\1",Species))%>%
  group_by(Species)%>%
  mutate(Count=max(Count))%>%
  distinct()%>%
  ungroup()%>%
  mutate(Species=ifelse(Species=="abiesConcolor","Abies concolor",ifelse(Species=="abiesMagnific","Abies magnifica",ifelse(Species=="calocedrDecurren","Calocedrus decurrens",ifelse(Species=="pinusContorta","Pinus contorta",ifelse(Species=="pinusJeffreyi","Pinus jeffreyi",ifelse(Species=="pinusLamberti","Pinus lambertiana",ifelse(Species=="pinusMonticol","Pinus monticola",ifelse(Species=="pinusPonderos","Pinus ponderosa",ifelse(Species=="pseudotsMenziesi","Pseudotsuga menziesii",ifelse(Species=="quercusKelloggi","Quercus kelloggii",ifelse(Species=="sequoiadGiganteu","Sequoiadendron giganteum",NA))))))))))))


fj_pred<-merge(seed_pred,fj)

#plot mass against count estimates
ggplot(fj_pred,aes(log(seed.mass),Count)) +
  geom_point() +
    geom_text(aes(label=Species)) +
  geom_smooth(method="lm") +
  theme_minimal()

#plot density against count estimates
ggplot(fj_pred,aes((seed_density),log(Count))) +
  geom_point() +
  geom_text(aes(label=Species)) +
  geom_smooth(method="lm") +
  theme_minimal()
# is there a significant relationship between fecundity and seed density?
fd<-lm(log(Count)~seed_density,data=fj_pred)
summary(fd) # not significant; p = 0.38 in log-space


ggplot(fj_pred,aes((seed_density),seed.mass)) +
  geom_point() +
  geom_text(aes(label=Species)) +
  geom_smooth(method="lm") +
  theme_minimal()

ggplot(fj_pred,aes(log(seed_vol),log(seed.mass))) +
  geom_point() +
  geom_text(aes(label=Species)) +
  geom_smooth(method="lm") +
  theme_minimal()
# very strong relationship with seed volume and seed mass (duh); bigger seeds tend to be heavier

# does tree metabolic rate predict fecundity?
# if we know that an organism's size predicts it's metabolic rates, shouldn't we see this scaling?

# first let's use tree volume as a proxy for tree mass and estimate M as a 3/4 scaling function
fj2<-fj_pred%>%
  mutate(Volume=(pi*(0.5*Diameter)^2)*Height,MR=Volume^(3/4),seed_production=seed.mass*Count)%>%
  distinct()

#  seed density and metabolic rate do not scale
ggplot(fj2,aes(MR,seed_density)) +
  geom_point() +
  geom_text(aes(label=Species)) +
  geom_smooth(method="lm") +
  theme_minimal()
mr_density<-lm(seed_density~MR,data=fj2)
summary(mr_density) # p = 0.62; not even close
# what does this imply for allocation to reproduction? 
# does this suggest that the total per unit area energy invested into reproduction is actually pretty similar?


# what about total carbon investment in seeds?
ggplot(fj2,aes(MR,seed_production))+
  geom_point() +
  geom_text(aes(label=Species)) +
  geom_smooth(method="lm") +
  theme_minimal()
mr_prod<-lm(seed_production~MR,data=fj2)
summary(mr_prod) # p = 0.35 so not really




# seed mass and metabolic rate
ggplot(fj2,aes(MR,seed.mass))+
  geom_point() +
  geom_text(aes(label=Species)) +
  geom_smooth(method="lm") +
  theme_minimal()
mr_mass<-lm(seed.mass~MR,data=fj2)
summary(mr_mass) # p = 0.09; so almost there?
# seed mass and metabolic rate scale! 
# this result might suggest that a single seed costs ~ 0.01% of a tree's total metabolic rate
cost<-mr_mass$coefficients[[2]]
# okay, let's extract the estimate and use it to find a total cost
fj3<-fj2%>%
  mutate(Total_cost=cost*Count)
# total seed production costs range from approximately 3% to 10% of a tree's total metabolic rate
  

# now let's compare to the actual observed count data from the traps
seed_time<-seed_time%>%
  mutate(cost=Count*cost)

# now if I can get NPP data for each trap / site location I can overlay that on the cost data
# essentially, how does the amount of energy expended toward reproduction scale with NPP?
# what fraction of NPP is getting allocated toward reproduction and how does it vary among species?

# make a quick density plot of costs for each species
ggplot(seed_time) +
  geom_density(aes(log(cost),fill=Species)) +
  theme_minimal()


# let's assess the periodicity / volatility relationship with total carbon investment
pv2<-MpMv%>%
  distinct()

seed_pv<-merge(seed_time,pv2)%>%
  group_by(Species)%>%
  mutate(mCost=mean(cost))%>%
    dplyr::select(Species,year,cost,mCost,Mp,Mv)

ggplot(seed_pv) +
  geom_point(aes((mCost),Mp),color="grey") +
  geom_point(aes((mCost),Mv),color="orange") +
  theme_minimal() +
  geom_smooth(aes(mCost,Mp),color="grey",formula=y~log(x)) +
  geom_smooth(aes(mCost,Mv),color="orange",formula=y~log(x)) +
  labs(x="Average Cost of Reproduction (% of Metabolic Rate)", y = "Periodicity (Grey); Volatility (Orange)")
# what we get is that masting is far more volatile (i.e., greater year - to - year variation) in trees for which reproduction constitutes a larger fraction of their total metabolic rate

# how does metabolic rate scale with cone costs?
fj_cone<-merge(fj2,cones)%>%
  drop_na()
# seed mass and metabolic rate
ggplot(fj_cone,aes(MR,pred_mass))+
  geom_point() +
  geom_text(aes(label=Species)) +
  geom_smooth(method="lm") +
  theme_minimal()
mr_mass<-lm(seed.mass~MR,data=fj2)
summary(mr_mass) 
# no relationship with metabolism and cone mass
# constant investment? need more data...




# Brown et al., 2002 (metabolic theory of ecology) predict that biomass scales with temperature and temperature is a key predictor of fecundity in the models
# Individual metabolic rate: I = M^3/4 * e^-E/kT
# temperature-corrected metabolic rate: 3/4*ln(M)
# B (biomass) is proportional to M^(-1/4) * e^(-E/kT) (eq. 7)
# is this true for reproduction?
# metabolic theory also predicts that turnover times (synonymous with periodicity?) scales with mass
# t (turnover time) is proportional to M^(1/4) * e^(E/kT) (eq. 8)
# 
# how do reproductive dynamics vary in terms of biomass, when accountingT for temperature?
# do larger trees, which have a higher energy requirement, reproduce less periodically or less often? 
# however, is the total reproductive output over arbitrarily long periods of time, constant?

# ESSENTIALLY, THE MAIN QUESTION I AM INTERESTED IN IS: IS TOTAL INVESTMENT IN REPRODUCTION INVARIANT? 
# SPECIES MIGHT MAKE LOTS OF LITTLE SEEDS OR FEW LARGE SEEDS, BUT IS THE TOTAL CARBON INVESTED RELATIVELY THE SAME (WITHIN AN ORDER OF MAGNITUDE)?
# WHAT ARE THE IMPLICATIONS OF CARBON INVESTMENT ON MASTING BEHAVIOR IN TREES? 
# CAN WE FIND SOME GENERAL PRINCIPLES?


```



Let's start with a plot that looks a lot like the USGS plots
``` {r simulations}

seedNames  <- specNames  <- 'simSpec'
sim <- list( nplot=20, nyr=10, ntree=30,  ntrap=20, specNames = specNames, 
             seedNames = seedNames )


inputs     <- mastSim( sim )        # simulate dispersal data
seedData   <- inputs$seedData     # year, plot, trap, seed counts
treeData   <- inputs$treeData     # year, plot, tree data
xytree     <- inputs$xytree       # tree locations
xytrap     <- inputs$xytrap       # trap locations
formulaFec <- inputs$formulaFec   # fecundity model
formulaRep <- inputs$formulaRep   # maturation model
trueValues <- inputs$trueValues   # true states and parameter values
inputs$mapPlot<-"p1"
inputs$mapYears<-2007
inputs$treeSymbol <- treeData$diam
inputs$treeScale  <- 1.5
inputs$trapScale  <- 1

inputs$treeSymbol <- trueValues$repr
inputs$treeScale  <- .5
mastMap(inputs)

p1<-filter(xytrap,plot=="p1")
ggplot(p1,aes(x=x,y=y)) +
  geom_text(aes(label=trap))

xynew<-data.frame(trap=1:18,X=c(15,25,30,15,25,30,15,25,30,65,75,85,65,75,85,65,75,85),Y=c(65,75,85,50,60,70,35,45,55,15,25,30,25,35,45,35,45,55))

p1new<-merge(p1,xynew)%>%
  dplyr::select(-x,-y)%>%
  rename(x=X,y=Y)
ggplot(p1new,aes(x=x,y=y)) +
  geom_text(aes(label=trap))

inputs$xytrap<-p1new
mastMap(inputs)


par( mfrow=c( 1, 2 ), bty='n', mar=c( 4, 4, 1, 1 ) )
seedData  <- inputs$seedData
seedNames <- inputs$seedNames

hist( as.matrix( seedData[, seedNames] ) , nclass=100, 
      xlab = 'seed count', ylab='per trap', main='' )
hist( trueValues$fec, nclass=100, xlab = 'seeds produced', ylab = 'per tree', main = '' )



output   <- mastif( inputs = inputs, ng = 1000, burnin = 500 )
mastPlot(output)



xytrapnew<-inputs$xytrap
trp<-c(7,9,3,10,16,18)
xytrap2<-filter(xytrapnew,trap%in%trp)

inputs$xytrap<-xytrap2
mastMap(inputs)

output   <- mastif( inputs = inputs, ng = 4000, burnin = 500 )
mastPlot(output)



# let's combine all of the previous trap data with new trap data
xytrap_update<-filter(xytrap,plot!="p1")%>%
  rbind(.,p1new)
inputs$xytrap<-xytrap_update

output   <- mastif( inputs = inputs, ng = 4000, burnin = 500 )
mastPlot(output)


# what's the tolerance of MASTIF for # of plots with bad data?
trp<-c(7,9,3,10,16,18)
newtrap_a<-filter(xytrap,plot%in%c("p1"))%>%
  merge(.,xynew)%>%
  dplyr::select(-x,-y)%>%
  rename(x=X,y=Y)%>%
  filter(trap%in%trp)

newtrap_b<-filter(xytrap,plot%in%c("p4","p2","p3","p5","p6","p7","p8","p9","p10"))



newtrap<-rbind(newtrap_a,newtrap_b)

inputs$xytrap<-newtrap

output   <- mastif( inputs = inputs, ng = 1000, burnin = 500 )
mastPlot(output)

```


"To fit the data, there must be sufficient seed traps, and sources must not be so dense such that overlapping seed shadows make the individual contributions undetectable." - Jim





